<html>
<body>
<script src="resources/eml_report_loadable_data.js"></script>
<div class="dead">
<pre class="code">
<span class="srcline"><span class="lineno"><a href="93,1" id="srcline1">  1</a></span><span class="line"><span class="comment">%resolve a pair-collision, returning new sm position values</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,2" id="srcline2">  2</a></span><span class="line"><span class="comment">%in: the two smcle 5-tuples, flag whether to resolve or just check collisions</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,3" id="srcline3">  3</a></span><span class="line"><span class="comment">%out: T/F if just checking, list of new 3-tuples (cx,cy,theta) if resolving</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,4" id="srcline4">  4</a></span><span class="line">function [xSm, currOrd,flipPar]=pairCollision(sm, resolveFl, fricCoeff, prevOrd) <span class="comment">%#codegen</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,5" id="srcline5">  5</a></span><span class="line">    global A B tRes;</span></span>
<span class="srcline"><span class="lineno"><a href="93,6" id="srcline6">  6</a></span><span class="line">    lenVc=[A,B,A]; <span class="comment">%scales to get real-space distances</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,7" id="srcline7">  7</a></span><span class="line">    lenMx=repmat(lenVc,3,1);</span></span>
<span class="srcline"><span class="lineno"><a href="93,8" id="srcline8">  8</a></span><span class="line">    trEps=0.1*tRes*B; maxAngle=tRes; parThresh=5*tRes; parShift=tRes*B; <span class="comment">%perturbative scales</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,9" id="srcline9">  9</a></span><span class="line">    <span class="comment">% check for collisions:----------</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,10" id="srcline10"> 10</a></span><span class="line">    crd=smcle2coord(sm);</span></span>
<span class="srcline"><span class="lineno"><a href="93,11" id="srcline11"> 11</a></span><span class="line">    currOrd=prevOrd; <span class="comment">%order of parallel links - to know which way to shift next</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,12" id="srcline12"> 12</a></span><span class="line"><span class="comment">%     currOrd(abs(currOrd)&lt;0.1)=0; %decay over time and eventually forget</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,13" id="srcline13"> 13</a></span><span class="line">    flipPar=zeros(9,1);</span></span>
<span class="srcline"><span class="lineno"><a href="93,14" id="srcline14"> 14</a></span><span class="line"><span class="comment">%     cla; plot(crd(:,1:2:end)',crd(:,2:2:end)','-','LineWidth',2); %axis([-0.5,0.5,-0.5,0.5]*12);</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,15" id="srcline15"> 15</a></span><span class="line">    inters = lineSegmentIntersect([crd(1,1:4); crd(1,3:6); crd(1,5:8)],[crd(2,1:4); crd(2,3:6); crd(2,5:8)],...</span></span>
<span class="srcline"><span class="lineno"><a href="93,16" id="srcline16"> 16</a></span><span class="line">        parThresh*B^2, parThresh*B/2,lenMx); <span class="comment">%max value of cross-product and separation for parallel</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,17" id="srcline17"> 17</a></span><span class="line">    if ~(any(any(inters.intAdjacencyMatrix)) || any(any(inters.parAdjacencyMatrix))); xSm=zeros(2,3); return; end <span class="comment">%if no collision, return false</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,18" id="srcline18"> 18</a></span><span class="line">    if(~resolveFl); xSm=ones(2,3); return; end <span class="comment">%if just checking for collisions</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,19" id="srcline19"> 19</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="93,20" id="srcline20"> 20</a></span><span class="line">    <span class="comment">% find out the type of interaction:===============</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,21" id="srcline21"> 21</a></span><span class="line">    xSm=sm(:,1:3); <span class="comment">%setup the identity map</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,22" id="srcline22"> 22</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="93,23" id="srcline23"> 23</a></span><span class="line">    <span class="comment">% Separate any parallel links if present-------</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,24" id="srcline24"> 24</a></span><span class="line"><span class="comment">%     cla; plot(crd(:,1:2:end)',crd(:,2:2:end)','-','LineWidth',2); %axis([-0.5,0.5,-0.5,0.5]*12);</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,25" id="srcline25"> 25</a></span><span class="line">    [par1,par2]=find(inters.parAdjacencyMatrix); <span class="comment">%get parallel nearby lines</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,26" id="srcline26"> 26</a></span><span class="line">    parX=[par1,par2];</span></span>
<span class="srcline"><span class="lineno"><a href="93,27" id="srcline27"> 27</a></span><span class="line">    if(~isempty(par1)) <span class="comment">%number of parallel line</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,28" id="srcline28"> 28</a></span><span class="line"><span class="comment">%       cla; plot(crd(:,1:2:end)',crd(:,2:2:end)','-','LineWidth',2); %axis([-0.5,0.5,-0.5,0.5]*12);  </span></span></span>
<span class="srcline"><span class="lineno"><a href="93,29" id="srcline29"> 29</a></span><span class="line">      mv=1+((fricCoeff(2)-fricCoeff(1))/(fricCoeff(2)+fricCoeff(1))&lt;0.5*(rand-0.5)); <span class="comment">%move the one with smaller fricCoeff</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,30" id="srcline30"> 30</a></span><span class="line">      fx=3-mv; netF=[0,0];</span></span>
<span class="srcline"><span class="lineno"><a href="93,31" id="srcline31"> 31</a></span><span class="line">      for i=1:length(par1) <span class="comment">%total force for different parallel interactions</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,32" id="srcline32"> 32</a></span><span class="line">        vecTr=crd(mv,parX(i,mv)*2+(1:2))-crd(mv,parX(i,mv)*2+(-1:0)); vecTr=[-vecTr(2),vecTr(1)]; <span class="comment">%take unit vector perp to first parallel</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,33" id="srcline33"> 33</a></span><span class="line">        pIx=sub2ind([3,3],par1(i),par2(i)); <span class="comment">%linear index</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,34" id="srcline34"> 34</a></span><span class="line">        coOrient=-inters.parAdjacencyMatrix(pIx); <span class="comment">%+/-</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,35" id="srcline35"> 35</a></span><span class="line">        if(mv==1); sgn=1;</span></span>
<span class="srcline"><span class="lineno"><a href="93,36" id="srcline36"> 36</a></span><span class="line">        else; sgn=coOrient;</span></span>
<span class="srcline"><span class="lineno"><a href="93,37" id="srcline37"> 37</a></span><span class="line">        end</span></span>
<span class="srcline"><span class="lineno"><a href="93,38" id="srcline38"> 38</a></span><span class="line">        if(prevOrd(pIx))</span></span>
<span class="srcline"><span class="lineno"><a href="93,39" id="srcline39"> 39</a></span><span class="line">            sgnPrev=sign(prevOrd(pIx)); fDir=sgn*sgnPrev; </span></span>
<span class="srcline"><span class="lineno"><a href="93,40" id="srcline40"> 40</a></span><span class="line">            currOrd(pIx)=sgnPrev;</span></span>
<span class="srcline"><span class="lineno"><a href="93,41" id="srcline41"> 41</a></span><span class="line">        else </span></span>
<span class="srcline"><span class="lineno"><a href="93,42" id="srcline42"> 42</a></span><span class="line">            vec2m=(crd(mv,parX(i,mv)*2+(1:2))+crd(mv,parX(i,mv)*2+(-1:0)))-...</span></span>
<span class="srcline"><span class="lineno"><a href="93,43" id="srcline43"> 43</a></span><span class="line">                (crd(fx,parX(i,fx)*2+(1:2))+crd(fx,parX(i,fx)*2+(-1:0))); <span class="comment">%vector fixed -&gt; moving c.o.m.</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,44" id="srcline44"> 44</a></span><span class="line">            fDir=sign(vecTr*vec2m'); </span></span>
<span class="srcline"><span class="lineno"><a href="93,45" id="srcline45"> 45</a></span><span class="line">            currOrd(pIx)=sgn*fDir;</span></span>
<span class="srcline"><span class="lineno"><a href="93,46" id="srcline46"> 46</a></span><span class="line">        end</span></span>
<span class="srcline"><span class="lineno"><a href="93,47" id="srcline47"> 47</a></span><span class="line">        flipPar(pIx)=coOrient; <span class="comment">%tells what to do under smarticle swap</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,48" id="srcline48"> 48</a></span><span class="line">        netF=netF+fDir*vecTr;</span></span>
<span class="srcline"><span class="lineno"><a href="93,49" id="srcline49"> 49</a></span><span class="line">      end</span></span>
<span class="srcline"><span class="lineno"><a href="93,50" id="srcline50"> 50</a></span><span class="line">      xSm(mv,1:2)=xSm(mv,1:2)+netF/norm(netF+1E-5)*parShift;</span></span>
<span class="srcline"><span class="lineno"><a href="93,51" id="srcline51"> 51</a></span><span class="line">      xSm(mv,3)=xSm(mv,3)+(rand-0.5)*tRes; <span class="comment">%add angle fluctuation</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,52" id="srcline52"> 52</a></span><span class="line">      return; <span class="comment">%handle any intersections next time around</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,53" id="srcline53"> 53</a></span><span class="line">    end</span></span>
<span class="srcline"><span class="lineno"><a href="93,54" id="srcline54"> 54</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="93,55" id="srcline55"> 55</a></span><span class="line">    <span class="comment">% Handle intersections========================</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,56" id="srcline56"> 56</a></span><span class="line"><span class="comment">%     scatter(inters.intMatrixX(:),inters.intMatrixY(:),1000,'r.'); %mark collision points</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,57" id="srcline57"> 57</a></span><span class="line">    <span class="comment">% handle different possible intersection scenarios:-----------</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,58" id="srcline58"> 58</a></span><span class="line">    <span class="comment">% group corner intersections:</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,59" id="srcline59"> 59</a></span><span class="line">    tmpInt=inters.intAdjacencyMatrix; ii=1;</span></span>
<span class="srcline"><span class="lineno"><a href="93,60" id="srcline60"> 60</a></span><span class="line">    intList=zeros(3,6); <span class="comment">%[src,trg,sLk,tLk,beg,intDistTrg] - distinct intersections</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,61" id="srcline61"> 61</a></span><span class="line">    crn1=find(sum(tmpInt)==2 &amp; tmpInt(2,:)); <span class="comment">%corners: trg=2</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,62" id="srcline62"> 62</a></span><span class="line">    crn2=find(sum(tmpInt,2)==2 &amp; tmpInt(:,2)); <span class="comment">%corners: trg=1</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,63" id="srcline63"> 63</a></span><span class="line">    if(any(crn1) &amp;&amp; any(crn2)) <span class="comment">%take the smaller corner</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,64" id="srcline64"> 64</a></span><span class="line">        dist1=inters.intNormalizedDistance1To2(2,crn1(1)); dist1=min(dist1,1-dist1);</span></span>
<span class="srcline"><span class="lineno"><a href="93,65" id="srcline65"> 65</a></span><span class="line">        dist2=inters.intNormalizedDistance2To1(crn2(1),2); dist2=min(dist2,1-dist2);</span></span>
<span class="srcline"><span class="lineno"><a href="93,66" id="srcline66"> 66</a></span><span class="line">        if(dist1&gt;dist2); crn1=[];</span></span>
<span class="srcline"><span class="lineno"><a href="93,67" id="srcline67"> 67</a></span><span class="line">        else; crn2=[];</span></span>
<span class="srcline"><span class="lineno"><a href="93,68" id="srcline68"> 68</a></span><span class="line">        end</span></span>
<span class="srcline"><span class="lineno"><a href="93,69" id="srcline69"> 69</a></span><span class="line">    end</span></span>
<span class="srcline"><span class="lineno"><a href="93,70" id="srcline70"> 70</a></span><span class="line">    for i=1:length(crn1)</span></span>
<span class="srcline"><span class="lineno"><a href="93,71" id="srcline71"> 71</a></span><span class="line">        intDistTrg=sum(inters.intNormalizedDistance2To1(tmpInt(:,crn1(i)),crn1(i)))/2;</span></span>
<span class="srcline"><span class="lineno"><a href="93,72" id="srcline72"> 72</a></span><span class="line">        intList(ii,:)=[1,2,2,crn1(i),tmpInt(1,crn1(i)),intDistTrg];</span></span>
<span class="srcline"><span class="lineno"><a href="93,73" id="srcline73"> 73</a></span><span class="line">        ii=ii+1; tmpInt(:,crn1(i))=0; <span class="comment">%remove intersection from mx</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,74" id="srcline74"> 74</a></span><span class="line">    end</span></span>
<span class="srcline"><span class="lineno"><a href="93,75" id="srcline75"> 75</a></span><span class="line">    for i=1:length(crn2) </span></span>
<span class="srcline"><span class="lineno"><a href="93,76" id="srcline76"> 76</a></span><span class="line">        intDistTrg=sum(inters.intNormalizedDistance1To2(crn2(i),tmpInt(crn2(i),:)))/2;</span></span>
<span class="srcline"><span class="lineno"><a href="93,77" id="srcline77"> 77</a></span><span class="line"><span class="comment">%         ixRep=find(intList(:,6)&gt;0 &amp; (intDistTrg&gt;intList(:,6) | intDistTrg&gt;1-intList(:,6)));</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,78" id="srcline78"> 78</a></span><span class="line">        intList(ii,:)=[2,1,2,crn2(i),tmpInt(crn2(i),1),intDistTrg];</span></span>
<span class="srcline"><span class="lineno"><a href="93,79" id="srcline79"> 79</a></span><span class="line">        ii=ii+1; tmpInt(crn2(i),:)=0; <span class="comment">%remove intersection from mx</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,80" id="srcline80"> 80</a></span><span class="line">    end</span></span>
<span class="srcline"><span class="lineno"><a href="93,81" id="srcline81"> 81</a></span><span class="line">    if(tmpInt(2,2) &amp;&amp; sum(sum(tmpInt))&gt;1) <span class="comment">%two corners intersecting</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,82" id="srcline82"> 82</a></span><span class="line"><span class="comment">%     if(sum(tmpInt(2,:))==1 &amp;&amp; sum(tmpInt(:,2))==1 &amp;&amp; sum(sum(tmpInt))&gt;1) </span></span></span>
<span class="srcline"><span class="lineno"><a href="93,83" id="srcline83"> 83</a></span><span class="line">        tmpInt(2,2)=0; [ins1,ins2]=find(tmpInt);</span></span>
<span class="srcline"><span class="lineno"><a href="93,84" id="srcline84"> 84</a></span><span class="line">        ci=xor(inters.intNormalizedDistance1To2(ins1,ins2)&gt;1-inters.intNormalizedDistance1To2(ins1,ins2),ins1==3); <span class="comment">%end xor 3</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,85" id="srcline85"> 85</a></span><span class="line">        if(sum(ci)~=1); error('corners intersection problem'); end</span></span>
<span class="srcline"><span class="lineno"><a href="93,86" id="srcline86"> 86</a></span><span class="line">        intList(ii,:)=[1,2,2,2,ins1(ci)==1,ins2(ci)==3];</span></span>
<span class="srcline"><span class="lineno"><a href="93,87" id="srcline87"> 87</a></span><span class="line">        ii=ii+1; tmpInt(ins1(ci),ins2(ci))=0;</span></span>
<span class="srcline"><span class="lineno"><a href="93,88" id="srcline88"> 88</a></span><span class="line">    end</span></span>
<span class="srcline"><span class="lineno"><a href="93,89" id="srcline89"> 89</a></span><span class="line">    if(sum(tmpInt(2,:))==1 &amp;&amp; sum(tmpInt(:,2))==1) <span class="comment">%two corners intersecting</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,90" id="srcline90"> 90</a></span><span class="line">        ins1=find(tmpInt(:,2)); ins2=2;</span></span>
<span class="srcline"><span class="lineno"><a href="93,91" id="srcline91"> 91</a></span><span class="line">        ci=xor(inters.intNormalizedDistance1To2(ins1,ins2)&gt;1-inters.intNormalizedDistance1To2(ins1,ins2),ins1==3);</span></span>
<span class="srcline"><span class="lineno"><a href="93,92" id="srcline92"> 92</a></span><span class="line">        if(ci)</span></span>
<span class="srcline"><span class="lineno"><a href="93,93" id="srcline93"> 93</a></span><span class="line">            intList(ii,:)=[1,2,ins1,2,ins1==3,find(tmpInt(2,:))==3];</span></span>
<span class="srcline"><span class="lineno"><a href="93,94" id="srcline94"> 94</a></span><span class="line">            ii=ii+1; tmpInt(2,:)=0; tmpInt(:,2)=0;</span></span>
<span class="srcline"><span class="lineno"><a href="93,95" id="srcline95"> 95</a></span><span class="line">        end</span></span>
<span class="srcline"><span class="lineno"><a href="93,96" id="srcline96"> 96</a></span><span class="line">    end</span></span>
<span class="srcline"><span class="lineno"><a href="93,97" id="srcline97"> 97</a></span><span class="line">    [ins1,ins2]=find(tmpInt); inX=[ins1, ins2]; <span class="comment">%get intersection index</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,98" id="srcline98"> 98</a></span><span class="line">    for i=1:length(ins1) <span class="comment">%single intersections</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,99" id="srcline99"> 99</a></span><span class="line"><span class="comment">%         if(ins1(i)==2 &amp;&amp; ins2(i)==2); continue; end %just ignore it - probably a corner</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,100" id="srcline100">100</a></span><span class="line">        [src,trg,beg,intDistTrg]=findSrc(inters,ins1(i),ins2(i),lenVc); </span></span>
<span class="srcline"><span class="lineno"><a href="93,101" id="srcline101">101</a></span><span class="line">        intList(ii,:)=[src,trg,inX(i,src),inX(i,trg),beg,intDistTrg];</span></span>
<span class="srcline"><span class="lineno"><a href="93,102" id="srcline102">102</a></span><span class="line">        ii=ii+1;</span></span>
<span class="srcline"><span class="lineno"><a href="93,103" id="srcline103">103</a></span><span class="line">    end</span></span>
<span class="srcline"><span class="lineno"><a href="93,104" id="srcline104">104</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="93,105" id="srcline105">105</a></span><span class="line">    <span class="comment">% move according to type of interaction-------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,106" id="srcline106">106</a></span><span class="line">    switch ii <span class="comment">%switch on number of distinct contacts</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,107" id="srcline107">107</a></span><span class="line">        case 1 <span class="comment">%no intersections </span></span></span>
<span class="srcline"><span class="lineno"><a href="93,108" id="srcline108">108</a></span><span class="line">        case 2 <span class="comment">%if only one intersection: rotate------------------ </span></span></span>
<span class="srcline"><span class="lineno"><a href="93,109" id="srcline109">109</a></span><span class="line">    src=intList(1,1); trg=intList(1,2); sLk=intList(1,3); tLk=intList(1,4);</span></span>
<span class="srcline"><span class="lineno"><a href="93,110" id="srcline110">110</a></span><span class="line">    beg=intList(1,5); intDistTrg=intList(1,6);</span></span>
<span class="srcline"><span class="lineno"><a href="93,111" id="srcline111">111</a></span><span class="line">    <span class="comment">%find force:</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,112" id="srcline112">112</a></span><span class="line">    [fAng,fDir,vStickOut]=intForce(sm,crd,src,sLk,beg,trg,tLk,intDistTrg);</span></span>
<span class="srcline"><span class="lineno"><a href="93,113" id="srcline113">113</a></span><span class="line">    <span class="comment">%get force angle from what we are pushing on (normal to the surface):</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,114" id="srcline114">114</a></span><span class="line">    <span class="comment">%and calculate the response on the pushed smarticle:</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,115" id="srcline115">115</a></span><span class="line">    piv=zeros(2,3);</span></span>
<span class="srcline"><span class="lineno"><a href="93,116" id="srcline116">116</a></span><span class="line">    switch tLk <span class="comment">%pivot target</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,117" id="srcline117">117</a></span><span class="line">        case 1 <span class="comment">%left arm pushed</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,118" id="srcline118">118</a></span><span class="line">          piv(trg,:)=pivotArm(sm(trg,4), sm(trg,4)+pi/2, (1-intDistTrg)*A/B); </span></span>
<span class="srcline"><span class="lineno"><a href="93,119" id="srcline119">119</a></span><span class="line">          piv(trg,[1,3])=-piv(trg,[1,3]); <span class="comment">%flip x-axis</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,120" id="srcline120">120</a></span><span class="line">        case 2 <span class="comment">%body pushed</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,121" id="srcline121">121</a></span><span class="line">          piv(trg,:)=pivotBody(intDistTrg - 0.5);</span></span>
<span class="srcline"><span class="lineno"><a href="93,122" id="srcline122">122</a></span><span class="line">        case 3 <span class="comment">%right arm pushed</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,123" id="srcline123">123</a></span><span class="line">          piv(trg,:)=pivotArm(sm(trg,5), sm(trg,5)+pi/2, intDistTrg*A/B);</span></span>
<span class="srcline"><span class="lineno"><a href="93,124" id="srcline124">124</a></span><span class="line">    end</span></span>
<span class="srcline"><span class="lineno"><a href="93,125" id="srcline125">125</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="93,126" id="srcline126">126</a></span><span class="line">    <span class="comment">%calculate the response on the pushing smarticle:</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,127" id="srcline127">127</a></span><span class="line">    switch sLk</span></span>
<span class="srcline"><span class="lineno"><a href="93,128" id="srcline128">128</a></span><span class="line">        case 1  <span class="comment">%pushing with left arm tip</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,129" id="srcline129">129</a></span><span class="line">          piv(src,:)=pivotArm(sm(src,4), -fAng+sm(src,3)+pi/2, A/B); piv(src,[1,3])=-piv(src,[1,3]);</span></span>
<span class="srcline"><span class="lineno"><a href="93,130" id="srcline130">130</a></span><span class="line">        case 2</span></span>
<span class="srcline"><span class="lineno"><a href="93,131" id="srcline131">131</a></span><span class="line">          if(beg) <span class="comment">%pusing with left corner</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,132" id="srcline132">132</a></span><span class="line">            piv(src,:)=pivotArm(0, -fAng+sm(src,3)+pi/2, 0); piv(src,[1,3])=-piv(src,[1,3]);</span></span>
<span class="srcline"><span class="lineno"><a href="93,133" id="srcline133">133</a></span><span class="line">          else <span class="comment">%if pushing with right corner</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,134" id="srcline134">134</a></span><span class="line">            piv(src,:)=pivotArm(0, fAng-sm(src,3)+pi/2, 0);</span></span>
<span class="srcline"><span class="lineno"><a href="93,135" id="srcline135">135</a></span><span class="line">          end</span></span>
<span class="srcline"><span class="lineno"><a href="93,136" id="srcline136">136</a></span><span class="line">        case 3  <span class="comment">%if pushing with the right arm tip</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,137" id="srcline137">137</a></span><span class="line">          piv(src,:)=pivotArm(sm(src,5), fAng-sm(src,3)+pi/2, A/B);</span></span>
<span class="srcline"><span class="lineno"><a href="93,138" id="srcline138">138</a></span><span class="line">    end</span></span>
<span class="srcline"><span class="lineno"><a href="93,139" id="srcline139">139</a></span><span class="line">    piv(:,3)=piv(:,3).*fricCoeff; <span class="comment">%scale force by friction coefficients</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,140" id="srcline140">140</a></span><span class="line">    <span class="comment">%chose which of the two moves - random, but weighted by the required force:</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,141" id="srcline141">141</a></span><span class="line">    srcF=abs(piv(src,3)); trgF=abs(piv(trg,3));</span></span>
<span class="srcline"><span class="lineno"><a href="93,142" id="srcline142">142</a></span><span class="line">    if(((srcF-trgF)/(srcF+trgF))&lt;0.5*(rand-0.5)); mv=src; <span class="comment">%move source smarticle</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,143" id="srcline143">143</a></span><span class="line">    else; mv=trg; <span class="comment">%else move target smarticle</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,144" id="srcline144">144</a></span><span class="line">    end</span></span>
<span class="srcline"><span class="lineno"><a href="93,145" id="srcline145">145</a></span><span class="line">    cth=cos(sm(mv,3)-pi/2); sth=sin(sm(mv,3)-pi/2); rotMx=[[cth,-sth];[sth,cth]]; <span class="comment">%rotation matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,146" id="srcline146">146</a></span><span class="line">    pivCOM=(rotMx*piv(mv,1:2)'*B)'; <span class="comment">%pivot to smarticle COM in lab frame</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,147" id="srcline147">147</a></span><span class="line">    pivot=sm(mv,1:2)+pivCOM; <span class="comment">%pivot point in absolute coord</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,148" id="srcline148">148</a></span><span class="line">    pivRad=crd(src,(sLk-beg)*2+(1:2))-pivot; <span class="comment">%pivot to collision point</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,149" id="srcline149">149</a></span><span class="line">    [pivRad(1),pivRad(2)]=cart2pol(pivRad(1),pivRad(2));</span></span>
<span class="srcline"><span class="lineno"><a href="93,150" id="srcline150">150</a></span><span class="line">    pivAngle=abs(vStickOut(2)/pivRad(2).*cos(fAng-vStickOut(1))./sin(fAng-pivRad(1))); <span class="comment">%angle to pivot in order to resolve collision</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,151" id="srcline151">151</a></span><span class="line">    pivAngle=min(pivAngle, maxAngle); <span class="comment">%cap pivot angle</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,152" id="srcline152">152</a></span><span class="line"><span class="comment">%     pivAngle=max(pivAngle,tRes*3/pivRad(2)); %bound pivot angle from below</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,153" id="srcline153">153</a></span><span class="line">    pivAngle=(1-2*(mv==src))*fDir*sign(piv(mv,3))*(pivAngle+trEps*(1+rand)/max(pivRad(2),0.5*B)); <span class="comment">%rotate a little further to make sure, and orient</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,154" id="srcline154">154</a></span><span class="line">    sm12v=sm(mv,1:2)-sm(3-mv,1:2); <span class="comment">%vector between smarticles</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,155" id="srcline155">155</a></span><span class="line">    <span class="comment">%rotate COM; add repulsive noise to prevent sticking together:</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,156" id="srcline156">156</a></span><span class="line">    xSm(mv,1:2)=xSm(mv,1:2)+pivAngle*[1,-1].*flip(pivCOM)+trEps*abs(pivAngle)*sm12v/norm(sm12v)*rand; </span></span>
<span class="srcline"><span class="lineno"><a href="93,157" id="srcline157">157</a></span><span class="line">    xSm(mv,3)=xSm(mv,3)+pivAngle; <span class="comment">%rotate angle</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,158" id="srcline158">158</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="93,159" id="srcline159">159</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="93,160" id="srcline160">160</a></span><span class="line">        otherwise <span class="comment">%if &gt;=2 intersections: pushing off - parallel transport</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,161" id="srcline161">161</a></span><span class="line">          mv=1+((fricCoeff(2)-fricCoeff(1))/(fricCoeff(2)+fricCoeff(1))&lt;0.5*(rand-0.5)); <span class="comment">%move the one with smaller fricCoeff</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,162" id="srcline162">162</a></span><span class="line">          fNet=[0,0];</span></span>
<span class="srcline"><span class="lineno"><a href="93,163" id="srcline163">163</a></span><span class="line">          for i=1:ii-1 <span class="comment">%intList=[src,trg,sLk,tLk,beg,intDistTrg]</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,164" id="srcline164">164</a></span><span class="line">            [fAng,fDir,~]=intForce(sm,crd,intList(i,1),intList(i,3),intList(i,5),...</span></span>
<span class="srcline"><span class="lineno"><a href="93,165" id="srcline165">165</a></span><span class="line">                intList(i,2),intList(i,4),intList(i,6));</span></span>
<span class="srcline"><span class="lineno"><a href="93,166" id="srcline166">166</a></span><span class="line">            fNet=fNet + [cos(fAng),sin(fAng)]*(1-2*(mv==intList(i,1)))*fDir;</span></span>
<span class="srcline"><span class="lineno"><a href="93,167" id="srcline167">167</a></span><span class="line">          end</span></span>
<span class="srcline"><span class="lineno"><a href="93,168" id="srcline168">168</a></span><span class="line">          xSm(mv,1:2)=xSm(mv,1:2)+fNet/(ii-1)*parShift;</span></span>
<span class="srcline"><span class="lineno"><a href="93,169" id="srcline169">169</a></span><span class="line">          xSm(mv,3)=xSm(mv,3)+(rand-0.5)*tRes; <span class="comment">%add angle fluctuation</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,170" id="srcline170">170</a></span><span class="line">    end</span></span>
<span class="srcline"><span class="lineno"><a href="93,171" id="srcline171">171</a></span><span class="line"><span class="comment">%     if(any(any(isnan(xSm))))</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,172" id="srcline172">172</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="93,173" id="srcline173">173</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="93,174" id="srcline174">174</a></span><span class="line"><span class="comment">%characterize single intersection: who is pushing who</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,175" id="srcline175">175</a></span><span class="line"><span class="comment">%in: intersection structure, intersecting links</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,176" id="srcline176">176</a></span><span class="line"><span class="comment">%out: source and target smls, intersection in beginning of source?,</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,177" id="srcline177">177</a></span><span class="line"><span class="comment">%distances on target link</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,178" id="srcline178">178</a></span><span class="line">function [src,trg,beg,intDistTrg]=findSrc(inters,ins1,ins2,lenVc)</span></span>
<span class="srcline"><span class="lineno"><a href="93,179" id="srcline179">179</a></span><span class="line">    if(ins1==2) <span class="comment">%middle link is always target</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,180" id="srcline180">180</a></span><span class="line">        if(ins2==2)<span class="comment">%; cla; plot(crd(:,1:2:end)',crd(:,2:2:end)','-','LineWidth',2); %axis([-0.5,0.5,-0.5,0.5]*12);</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,181" id="srcline181">181</a></span><span class="line">            'Warning: intersection in the middle of smarticles!'</span></span>
<span class="srcline"><span class="lineno"><a href="93,182" id="srcline182">182</a></span><span class="line">        end</span></span>
<span class="srcline"><span class="lineno"><a href="93,183" id="srcline183">183</a></span><span class="line">        src=2; trg=1; beg=ins2==1; intDistTrg=inters.intNormalizedDistance1To2(ins1,ins2);</span></span>
<span class="srcline"><span class="lineno"><a href="93,184" id="srcline184">184</a></span><span class="line"><span class="comment">%         end</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,185" id="srcline185">185</a></span><span class="line">    else</span></span>
<span class="srcline"><span class="lineno"><a href="93,186" id="srcline186">186</a></span><span class="line">        if(ins2==2); src=1; trg=2; beg=ins1==1; intDistTrg=inters.intNormalizedDistance2To1(ins1,ins2);</span></span>
<span class="srcline"><span class="lineno"><a href="93,187" id="srcline187">187</a></span><span class="line">        else <span class="comment">%if neither link ==2, then pick shorter end</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,188" id="srcline188">188</a></span><span class="line">      if(ins1==1); dst1=inters.intNormalizedDistance1To2(ins1,ins2)*lenVc(1);</span></span>
<span class="srcline"><span class="lineno"><a href="93,189" id="srcline189">189</a></span><span class="line">      else; dst1=(1-inters.intNormalizedDistance1To2(ins1,ins2))*lenVc(3);</span></span>
<span class="srcline"><span class="lineno"><a href="93,190" id="srcline190">190</a></span><span class="line">      end <span class="comment">%always take length from beg of 1 or end of 3</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,191" id="srcline191">191</a></span><span class="line">      if(ins2==1); dst2=inters.intNormalizedDistance2To1(ins1,ins2)*lenVc(1);</span></span>
<span class="srcline"><span class="lineno"><a href="93,192" id="srcline192">192</a></span><span class="line">      else; dst2=(1-inters.intNormalizedDistance2To1(ins1,ins2))*lenVc(3);</span></span>
<span class="srcline"><span class="lineno"><a href="93,193" id="srcline193">193</a></span><span class="line">      end</span></span>
<span class="srcline"><span class="lineno"><a href="93,194" id="srcline194">194</a></span><span class="line">      src=1+(dst1&gt;dst2); trg=3-src; </span></span>
<span class="srcline"><span class="lineno"><a href="93,195" id="srcline195">195</a></span><span class="line">      if(src==1); beg=ins1==1; intDistTrg=inters.intNormalizedDistance2To1(ins1,ins2);</span></span>
<span class="srcline"><span class="lineno"><a href="93,196" id="srcline196">196</a></span><span class="line">      else; beg=ins2==1; intDistTrg=inters.intNormalizedDistance1To2(ins1,ins2);</span></span>
<span class="srcline"><span class="lineno"><a href="93,197" id="srcline197">197</a></span><span class="line">      end</span></span>
<span class="srcline"><span class="lineno"><a href="93,198" id="srcline198">198</a></span><span class="line">        end</span></span>
<span class="srcline"><span class="lineno"><a href="93,199" id="srcline199">199</a></span><span class="line">    end</span></span>
<span class="srcline"><span class="lineno"><a href="93,200" id="srcline200">200</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="93,201" id="srcline201">201</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="93,202" id="srcline202">202</a></span><span class="line"><span class="comment">%get the interaction force</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,203" id="srcline203">203</a></span><span class="line"><span class="comment">%in: 4 vertex coordinates, ...<span class="comment"> , relative distance to X on tLk</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="93,204" id="srcline204">204</a></span><span class="line"><span class="comment">%out: force angle and direction (+/-)</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,205" id="srcline205">205</a></span><span class="line">function [fAng,fDir,vStickOut]=intForce(sm,crd,src,sLk,beg,trg,tLk,tXLen)</span></span>
<span class="srcline"><span class="lineno"><a href="93,206" id="srcline206">206</a></span><span class="line">    fAng=0;    </span></span>
<span class="srcline"><span class="lineno"><a href="93,207" id="srcline207">207</a></span><span class="line">    switch tLk <span class="comment">%find force angle</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,208" id="srcline208">208</a></span><span class="line">        case 1; fAng=sm(trg,3)-sm(trg,4); <span class="comment">%left arm pushed</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,209" id="srcline209">209</a></span><span class="line">        case 2; fAng=sm(trg,3); <span class="comment">%center pushed</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,210" id="srcline210">210</a></span><span class="line">        case 3; fAng=sm(trg,3)+sm(trg,5); <span class="comment">%right arm pushed</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,211" id="srcline211">211</a></span><span class="line">    end</span></span>
<span class="srcline"><span class="lineno"><a href="93,212" id="srcline212">212</a></span><span class="line">    <span class="comment">%get force orientation (+/-):</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,213" id="srcline213">213</a></span><span class="line">    intCrd=crd(trg,2*tLk+(-1:0)) + tXLen*(crd(trg,2*tLk+(1:2))-crd(trg,2*tLk+(-1:0))); <span class="comment">%coordinate of the intersection</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,214" id="srcline214">214</a></span><span class="line">    vStickOut=crd(src,(sLk-beg)*2+(1:2))-intCrd; <span class="comment">%sLk-beg=[0,4] vertex index - gives the piece sticking through inters</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,215" id="srcline215">215</a></span><span class="line">    [vStickOut(1),vStickOut(2)]=cart2pol(vStickOut(1),vStickOut(2)); <span class="comment">%polar coordinates</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,216" id="srcline216">216</a></span><span class="line">    so2fAng=abs(mod(vStickOut(1)-fAng+pi,2*pi)-pi);</span></span>
<span class="srcline"><span class="lineno"><a href="93,217" id="srcline217">217</a></span><span class="line">    fDir=sign(pi/2-so2fAng); <span class="comment">%get the direction of the force on trg</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,218" id="srcline218">218</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="93,219" id="srcline219">219</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="93,220" id="srcline220">220</a></span><span class="line"><span class="comment">%response when force applied to the right arm or corner</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,221" id="srcline221">221</a></span><span class="line"><span class="comment">%in: arm angle, force angle, arm length (in units of B)</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,222" id="srcline222">222</a></span><span class="line"><span class="comment">%out: [px,py,f] = pivot coordinates (in units of B) and critical force</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,223" id="srcline223">223</a></span><span class="line"><span class="comment">%required to move (in units of friction force; f&gt;0 =&gt; CCW rotation)</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,224" id="srcline224">224</a></span><span class="line">function [out]=pivotArm(al,th,A)</span></span>
<span class="srcline"><span class="lineno"><a href="93,225" id="srcline225">225</a></span><span class="line">    secth=sec(th); tanth=tan(th);</span></span>
<span class="srcline"><span class="lineno"><a href="93,226" id="srcline226">226</a></span><span class="line">    <span class="comment">%the constant out front quantifies how far off the pivot can be (larger=&gt;further away). "right" value: 0.081</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,227" id="srcline227">227</a></span><span class="line">    py=0.081./(-2*A*secth.*sin(al-th)+tanth); <span class="comment">%approximation for py</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,228" id="srcline228">228</a></span><span class="line">    pylnpy2=-0.6*atan(10*py); <span class="comment">%differentiable approximation for py*log(py^2) for py in (-0.5,0.5)</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,229" id="srcline229">229</a></span><span class="line">    px=tanth/2.*pylnpy2;</span></span>
<span class="srcline"><span class="lineno"><a href="93,230" id="srcline230">230</a></span><span class="line">    f=-secth.*pylnpy2;</span></span>
<span class="srcline"><span class="lineno"><a href="93,231" id="srcline231">231</a></span><span class="line">    out=[px,py,f];</span></span>
<span class="srcline"><span class="lineno"><a href="93,232" id="srcline232">232</a></span><span class="line">end</span></span>
</pre>
</div>
<pre class="code">
<span class="srcline"><span class="lineno"><a href="93,233" id="srcline233">233</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="93,234" id="srcline234">234</a></span><span class="line"><span class="comment">%response when orthogonal force applied to the body</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,235" id="srcline235">235</a></span><span class="line"><span class="comment">%in: distance from center to push point (in units of B)</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,236" id="srcline236">236</a></span><span class="line"><span class="comment">%out: [px,py,f] = pivot coordinates (in units of B) and critical force required to move</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,237" id="srcline237">237</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S139T24U2243">out</span>]=pivotBody(<span class="var type1" id="S140T6U2246">x</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="93,238" id="srcline238">238</a></span><span class="line">    <span class="mxinfo " id="T6:U3"><span class="var type1" id="S141T6U2249">sq</span>=<span class="mxinfo " id="T6:U5">sqrt(<span class="mxinfo " id="T6:U6"><span class="mxinfo " id="T6:U7">1</span>+<span class="mxinfo " id="T6:U8"><span class="mxinfo " id="T6:U9">4</span>*<span class="mxinfo " id="T6:U10"><span class="var type1" id="S140T6U2257">x</span>.^2</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,239" id="srcline239">239</a></span><span class="line">    <span class="mxinfo " id="T24:U12"><span class="var type1" id="S139T24U2261">out</span>=<span class="mxinfo " id="T24:U14">[(<span class="mxinfo " id="T6:U15"><span class="var type1" id="S140T6U2266">x</span>-<span class="mxinfo " id="T6:U17"><span class="mxinfo " id="T6:U18"><span class="mxinfo " id="T6:U19">sign(<span class="var type1" id="S140T6U2271">x</span>)</span>.*<span class="var type1" id="S141T6U2272">sq</span></span>/<span class="mxinfo " id="T6:U22">2</span></span></span>), <span class="mxinfo " id="T6:U23">0</span>, <span class="mxinfo " id="T6:U24"><span class="mxinfo " id="T6:U25"><span class="mxinfo " id="T6:U26">-<span class="mxinfo " id="T6:U27">2</span></span>*<span class="var type1" id="S140T6U2279">x</span></span>+<span class="mxinfo " id="T6:U29"><span class="mxinfo " id="T6:U30">sign(<span class="var type1" id="S140T6U2283">x</span>)</span>.*<span class="var type1" id="S141T6U2284">sq</span></span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,240" id="srcline240">240</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
</body>
</html>
