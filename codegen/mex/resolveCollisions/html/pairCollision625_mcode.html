<html>
<body>
<script src="resources/eml_report_loadable_data.js"></script>
<pre class="code">
<span class="srcline"><span class="lineno"><a href="93,1" id="srcline1">  1</a></span><span class="line"><span class="comment">%resolve a pair-collision, returning new sm position values</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,2" id="srcline2">  2</a></span><span class="line"><span class="comment">%in: the two smcle 5-tuples, flag whether to resolve or just check collisions</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,3" id="srcline3">  3</a></span><span class="line"><span class="comment">%out: T/F if just checking, list of new 3-tuples (cx,cy,theta) if resolving</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,4" id="srcline4">  4</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T14U3">xSm</span>, <span class="var type1" id="S3T15U4">currOrd</span>,<span class="var type1" id="S4T15U5">flipPar</span>]=pairCollision(<span class="var type1" id="S5T17U8">sm</span>, <span class="var type1" id="S6T4U9">resolveFl</span>, <span class="var type1" id="S7T19U10">fricCoeff</span>, <span class="var type1" id="S8T15U11">prevOrd</span>) <span class="comment">%#codegen</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,5" id="srcline5">  5</a></span><span class="line">    <span class="keyword">global</span> <span class="var type0" id="S9T0U13">A</span> <span class="var type0" id="S10T0U14">B</span> <span class="var type0" id="S11T0U15">tRes</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,6" id="srcline6">  6</a></span><span class="line">    <span class="mxinfo " id="T24:U8"><span class="var type1" id="S12T24U18">lenVc</span>=<span class="mxinfo " id="T24:U10">[<span class="var type1" id="S9T6U21">A</span>,<span class="var type1" id="S10T6U22">B</span>,<span class="var type1" id="S9T6U23">A</span>]</span></span>; <span class="comment">%scales to get real-space distances</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,7" id="srcline7">  7</a></span><span class="line">    <span class="mxinfo " id="T59:U14"><span class="var type1" id="S13T59U26">lenMx</span>=<span class="mxinfo " id="T59:U16">repmat(<span class="var type1" id="S12T24U29">lenVc</span>,3,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,8" id="srcline8">  8</a></span><span class="line">    <span class="mxinfo " id="T6:U18"><span class="var type1" id="S15T6U34">trEps</span>=<span class="mxinfo " id="T6:U20"><span class="mxinfo " id="T6:U21"><span class="mxinfo " id="T6:U22">0.1</span>*<span class="var type1" id="S11T6U38">tRes</span></span>*<span class="var type1" id="S10T6U39">B</span></span></span>; <span class="mxinfo " id="T6:U25"><span class="var type1" id="S16T6U42">maxAngle</span>=<span class="var type1" id="S11T6U43">tRes</span></span>; <span class="mxinfo " id="T6:U28"><span class="var type1" id="S17T6U46">parThresh</span>=<span class="mxinfo " id="T6:U30"><span class="mxinfo " id="T6:U31">5</span>*<span class="var type1" id="S11T6U49">tRes</span></span></span>; <span class="mxinfo " id="T6:U33"><span class="var type1" id="S18T6U52">parShift</span>=<span class="mxinfo " id="T6:U35"><span class="var type1" id="S11T6U54">tRes</span>*<span class="var type1" id="S10T6U55">B</span></span></span>; <span class="comment">%perturbative scales</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,9" id="srcline9">  9</a></span><span class="line">    <span class="comment">% check for collisions:----------</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,10" id="srcline10"> 10</a></span><span class="line">    <span class="mxinfo " id="T62:U38"><span class="var type1" id="S19T62U58">crd</span>=<span class="mxinfo " id="T62:U40"><span class="fcn" id="F198N11:B60">smcle2coord</span>(<span class="var type1" id="S5T17U61">sm</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,11" id="srcline11"> 11</a></span><span class="line">    <span class="mxinfo " id="T15:U42"><span class="var type1" id="S3T15U64">currOrd</span>=<span class="var type1" id="S8T15U65">prevOrd</span></span>; <span class="comment">%order of parallel links - to know which way to shift next</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,12" id="srcline12"> 12</a></span><span class="line"><span class="comment">%     currOrd(abs(currOrd)&lt;0.1)=0; %decay over time and eventually forget</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,13" id="srcline13"> 13</a></span><span class="line">    <span class="mxinfo " id="T15:U45"><span class="var type1" id="S4T15U68">flipPar</span>=<span class="mxinfo " id="T15:U47">zeros(<span class="mxinfo " id="T6:U48">9</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,14" id="srcline14"> 14</a></span><span class="line"><span class="comment">%     cla; plot(crd(:,1:2:end)',crd(:,2:2:end)','-','LineWidth',2); %axis([-0.5,0.5,-0.5,0.5]*12);</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,15" id="srcline15"> 15</a></span><span class="line">    <span class="mxinfo " id="T69:U49"><span class="var type1" id="S22T69U75">inters</span> = <span class="mxinfo " id="T69:U51"><span class="fcn" id="F254N4:B77">lineSegmentIntersect</span>(<span class="mxinfo " id="T71:U52">[<span class="mxinfo " id="T123:U53"><span class="var type1" id="S19T62U81">crd</span>(<span class="mxinfo " id="T8:U55">1</span>,<span class="mxinfo " id="T124:U56">1:4</span>)</span>; <span class="mxinfo " id="T123:U57"><span class="var type1" id="S19T62U88">crd</span>(<span class="mxinfo " id="T8:U59">1</span>,<span class="mxinfo " id="T124:U60">3:6</span>)</span>; <span class="mxinfo " id="T123:U61"><span class="var type1" id="S19T62U95">crd</span>(<span class="mxinfo " id="T8:U63">1</span>,<span class="mxinfo " id="T124:U64">5:8</span>)</span>]</span>,<span class="mxinfo " id="T71:U65">[<span class="mxinfo " id="T123:U66"><span class="var type1" id="S19T62U103">crd</span>(<span class="mxinfo " id="T8:U68">2</span>,<span class="mxinfo " id="T124:U69">1:4</span>)</span>; <span class="mxinfo " id="T123:U70"><span class="var type1" id="S19T62U110">crd</span>(<span class="mxinfo " id="T8:U72">2</span>,<span class="mxinfo " id="T124:U73">3:6</span>)</span>; <span class="mxinfo " id="T123:U74"><span class="var type1" id="S19T62U117">crd</span>(<span class="mxinfo " id="T8:U76">2</span>,<span class="mxinfo " id="T124:U77">5:8</span>)</span>]</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,16" id="srcline16"> 16</a></span><span class="line">        <span class="mxinfo " id="T6:U78"><span class="var type1" id="S17T6U123">parThresh</span>*<span class="mxinfo " id="T6:U80"><span class="var type1" id="S10T6U125">B</span>^2</span></span>, <span class="mxinfo " id="T6:U82"><span class="mxinfo " id="T6:U83"><span class="var type1" id="S17T6U129">parThresh</span>*<span class="var type1" id="S10T6U130">B</span></span>/<span class="mxinfo " id="T6:U86">2</span></span>,<span class="var type1" id="S13T59U132">lenMx</span>)</span></span>; <span class="comment">%max value of cross-product and separation for parallel</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,17" id="srcline17"> 17</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T4:U88">~(<span class="mxinfo " id="T4:U89"><span class="mxinfo " id="T4:U90">any(<span class="mxinfo " id="T20:U91">any(<span class="mxinfo " id="T70:U92"><span class="var type1" id="S22T69U143">inters</span>.intAdjacencyMatrix</span>)</span>)</span> || <span class="mxinfo " id="T4:U94">any(<span class="mxinfo " id="T20:U95">any(<span class="mxinfo " id="T59:U96"><span class="var type1" id="S22T69U150">inters</span>.parAdjacencyMatrix</span>)</span>)</span></span>)</span>; <span class="mxinfo " id="T14:U98"><span class="var type1" id="S2T14U154">xSm</span>=<span class="mxinfo " id="T14:U100">zeros(<span class="mxinfo " id="T6:U101">2</span>,<span class="mxinfo " id="T6:U102">3</span>)</span></span>; <span class="keyword">return</span>; <span class="keyword">end</span> <span class="comment">%if no collision, return false</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,18" id="srcline18"> 18</a></span><span class="line">    <span class="keyword">if</span>(<span class="mxinfo " id="T4:U103">~<span class="var type1" id="S6T4U164">resolveFl</span></span>); <span class="mxinfo " id="T14:U105"><span class="var type1" id="S2T14U167">xSm</span>=<span class="mxinfo " id="T14:U107">ones(<span class="mxinfo " id="T6:U108">2</span>,<span class="mxinfo " id="T6:U109">3</span>)</span></span>; <span class="keyword">return</span>; <span class="keyword">end</span> <span class="comment">%if just checking for collisions</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,19" id="srcline19"> 19</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="93,20" id="srcline20"> 20</a></span><span class="line">    <span class="comment">% find out the type of interaction:===============</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,21" id="srcline21"> 21</a></span><span class="line">    <span class="mxinfo " id="T14:U110"><span class="var type1" id="S2T14U175">xSm</span>=<span class="mxinfo " id="T14:U112"><span class="var type1" id="S5T17U177">sm</span>(<span class="mxinfo " id="T13:U114">:</span>,<span class="mxinfo " id="T24:U115"><span class="mxinfo " id="T6:U116">1</span>:<span class="mxinfo " id="T6:U117">3</span></span>)</span></span>; <span class="comment">%setup the identity map</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,22" id="srcline22"> 22</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="93,23" id="srcline23"> 23</a></span><span class="line">    <span class="comment">% Separate any parallel links if present-------</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,24" id="srcline24"> 24</a></span><span class="line"><span class="comment">%     cla; plot(crd(:,1:2:end)',crd(:,2:2:end)','-','LineWidth',2); %axis([-0.5,0.5,-0.5,0.5]*12);</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,25" id="srcline25"> 25</a></span><span class="line">    [<span class="var type1" id="S26T75U185">par1</span>,<span class="var type1" id="S27T75U186">par2</span>]=find(<span class="mxinfo " id="T59:U120"><span class="var type1" id="S22T69U190">inters</span>.parAdjacencyMatrix</span>); <span class="comment">%get parallel nearby lines</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,26" id="srcline26"> 26</a></span><span class="line">    <span class="mxinfo " id="T82:U122"><span class="var type1" id="S29T82U194">parX</span>=<span class="mxinfo " id="T82:U124">[<span class="var type1" id="S26T75U197">par1</span>,<span class="var type1" id="S27T75U198">par2</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,27" id="srcline27"> 27</a></span><span class="line">    <span class="keyword">if</span>(<span class="mxinfo " id="T4:U127">~<span class="mxinfo " id="T4:U128">isempty(<span class="var type1" id="S26T75U205">par1</span>)</span></span>) <span class="comment">%number of parallel line</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,28" id="srcline28"> 28</a></span><span class="line"><span class="comment">%       cla; plot(crd(:,1:2:end)',crd(:,2:2:end)','-','LineWidth',2); %axis([-0.5,0.5,-0.5,0.5]*12);  </span></span></span>
<span class="srcline"><span class="lineno"><a href="93,29" id="srcline29"> 29</a></span><span class="line">      <span class="mxinfo " id="T6:U130"><span class="var type1" id="S31T6U208">mv</span>=<span class="mxinfo " id="T6:U132"><span class="mxinfo " id="T6:U133">1</span>+(<span class="mxinfo " id="T4:U134"><span class="mxinfo " id="T6:U135">(<span class="mxinfo " id="T6:U136"><span class="mxinfo " id="T6:U137"><span class="var type1" id="S7T19U217">fricCoeff</span>(<span class="mxinfo " id="T8:U139">2</span>)</span>-<span class="mxinfo " id="T6:U140"><span class="var type1" id="S7T19U220">fricCoeff</span>(<span class="mxinfo " id="T6:U142">1</span>)</span></span>)/(<span class="mxinfo " id="T6:U143"><span class="mxinfo " id="T6:U144"><span class="var type1" id="S7T19U225">fricCoeff</span>(<span class="mxinfo " id="T8:U146">2</span>)</span>+<span class="mxinfo " id="T6:U147"><span class="var type1" id="S7T19U228">fricCoeff</span>(<span class="mxinfo " id="T6:U149">1</span>)</span></span>)</span>&lt;<span class="mxinfo " id="T6:U150"><span class="mxinfo " id="T6:U151">0.5</span>*(<span class="mxinfo " id="T6:U152"><span class="mxinfo " id="T6:U153">rand</span>-<span class="mxinfo " id="T6:U154">0.5</span></span>)</span></span>)</span></span>; <span class="comment">%move the one with smaller fricCoeff</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,30" id="srcline30"> 30</a></span><span class="line">      <span class="mxinfo " id="T6:U155"><span class="var type1" id="S33T6U239">fx</span>=<span class="mxinfo " id="T6:U157"><span class="mxinfo " id="T6:U158">3</span>-<span class="var type1" id="S31T6U242">mv</span></span></span>; <span class="mxinfo " id="T12:U160"><span class="var type1" id="S34T12U245">netF</span>=<span class="mxinfo " id="T12:U162">[<span class="mxinfo " id="T6:U163">0</span>,<span class="mxinfo " id="T6:U164">0</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,31" id="srcline31"> 31</a></span><span class="line">      <span class="keyword">for</span> <span class="var type1" id="S35T6U252">i</span>=<span class="mxinfo " id="T6:U166">1</span>:<span class="mxinfo " id="T6:U167">length(<span class="var type1" id="S26T75U257">par1</span>)</span> <span class="comment">%total force for different parallel interactions</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,32" id="srcline32"> 32</a></span><span class="line">        <span class="mxinfo " id="T12:U169"><span class="var type1" id="S37T12U260">vecTr</span>=<span class="mxinfo " id="T12:U171"><span class="mxinfo " id="T12:U172"><span class="var type1" id="S19T62U263">crd</span>(<span class="var type1" id="S31T6U264">mv</span>,<span class="mxinfo " id="T12:U175"><span class="mxinfo " id="T6:U176"><span class="mxinfo " id="T6:U177"><span class="var type1" id="S29T82U268">parX</span>(<span class="var type1" id="S35T6U269">i</span>,<span class="var type1" id="S31T6U270">mv</span>)</span>*<span class="mxinfo " id="T6:U181">2</span></span>+(<span class="mxinfo " id="T12:U182">1:2</span>)</span>)</span>-<span class="mxinfo " id="T12:U183"><span class="var type1" id="S19T62U277">crd</span>(<span class="var type1" id="S31T6U278">mv</span>,<span class="mxinfo " id="T12:U186"><span class="mxinfo " id="T6:U187"><span class="mxinfo " id="T6:U188"><span class="var type1" id="S29T82U282">parX</span>(<span class="var type1" id="S35T6U283">i</span>,<span class="var type1" id="S31T6U284">mv</span>)</span>*<span class="mxinfo " id="T6:U192">2</span></span>+(<span class="mxinfo " id="T12:U193">-1:0</span>)</span>)</span></span></span>; <span class="mxinfo " id="T12:U194"><span class="var type1" id="S37T12U293">vecTr</span>=<span class="mxinfo " id="T12:U196">[<span class="mxinfo " id="T6:U197">-<span class="mxinfo " id="T6:U198"><span class="var type1" id="S37T12U298">vecTr</span>(<span class="mxinfo " id="T8:U200">2</span>)</span></span>,<span class="mxinfo " id="T6:U201"><span class="var type1" id="S37T12U301">vecTr</span>(<span class="mxinfo " id="T8:U203">1</span>)</span>]</span></span>; <span class="comment">%take unit vector perp to first parallel</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,33" id="srcline33"> 33</a></span><span class="line">        <span class="mxinfo " id="T6:U204"><span class="var type1" id="S38T6U305">pIx</span>=<span class="mxinfo " id="T6:U206">sub2ind([3,3],<span class="mxinfo " id="T6:U207"><span class="var type1" id="S26T75U313">par1</span>(<span class="var type1" id="S35T6U314">i</span>)</span>,<span class="mxinfo " id="T6:U210"><span class="var type1" id="S27T75U316">par2</span>(<span class="var type1" id="S35T6U317">i</span>)</span>)</span></span>; <span class="comment">%linear index</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,34" id="srcline34"> 34</a></span><span class="line">        <span class="mxinfo " id="T6:U213"><span class="var type1" id="S40T6U320">coOrient</span>=<span class="mxinfo " id="T6:U215">-<span class="mxinfo " id="T6:U216"><span class="mxinfo " id="T59:U217"><span class="var type1" id="S22T69U324">inters</span>.parAdjacencyMatrix</span>(<span class="var type1" id="S38T6U326">pIx</span>)</span></span></span>; <span class="comment">%+/-</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,35" id="srcline35"> 35</a></span><span class="line">        <span class="keyword">if</span>(<span class="mxinfo " id="T4:U220"><span class="var type1" id="S31T6U331">mv</span>==<span class="mxinfo " id="T6:U222">1</span></span>); <span class="mxinfo " id="T6:U223"><span class="var type1" id="S41T6U335">sgn</span>=<span class="mxinfo " id="T6:U225">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,36" id="srcline36"> 36</a></span><span class="line">        <span class="keyword">else</span>; <span class="mxinfo " id="T6:U226"><span class="var type1" id="S41T6U340">sgn</span>=<span class="var type1" id="S40T6U341">coOrient</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,37" id="srcline37"> 37</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,38" id="srcline38"> 38</a></span><span class="line">        <span class="keyword">if</span>(<span class="mxinfo " id="T6:U229"><span class="var type1" id="S8T15U346">prevOrd</span>(<span class="var type1" id="S38T6U347">pIx</span>)</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="93,39" id="srcline39"> 39</a></span><span class="line">            <span class="mxinfo " id="T6:U232"><span class="var type1" id="S42T6U350">sgnPrev</span>=<span class="mxinfo " id="T6:U234">sign(<span class="mxinfo " id="T6:U235"><span class="var type1" id="S8T15U354">prevOrd</span>(<span class="var type1" id="S38T6U355">pIx</span>)</span>)</span></span>; <span class="mxinfo " id="T6:U238"><span class="var type1" id="S44T6U358">fDir</span>=<span class="mxinfo " id="T6:U240"><span class="var type1" id="S41T6U360">sgn</span>*<span class="var type1" id="S42T6U361">sgnPrev</span></span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="93,40" id="srcline40"> 40</a></span><span class="line">            <span class="mxinfo " id="T6:U243"><span class="mxinfo " id="T6:U244"><span class="var type1" id="S3T15U365">currOrd</span>(<span class="var type1" id="S38T6U366">pIx</span>)</span>=<span class="var type1" id="S42T6U367">sgnPrev</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,41" id="srcline41"> 41</a></span><span class="line">        <span class="keyword">else</span> </span></span>
<span class="srcline"><span class="lineno"><a href="93,42" id="srcline42"> 42</a></span><span class="line">            <span class="mxinfo " id="T12:U248"><span class="var type1" id="S45T12U371">vec2m</span>=<span class="mxinfo " id="T12:U250">(<span class="mxinfo " id="T12:U251"><span class="mxinfo " id="T12:U252"><span class="var type1" id="S19T62U376">crd</span>(<span class="var type1" id="S31T6U377">mv</span>,<span class="mxinfo " id="T12:U255"><span class="mxinfo " id="T6:U256"><span class="mxinfo " id="T6:U257"><span class="var type1" id="S29T82U381">parX</span>(<span class="var type1" id="S35T6U382">i</span>,<span class="var type1" id="S31T6U383">mv</span>)</span>*<span class="mxinfo " id="T6:U261">2</span></span>+(<span class="mxinfo " id="T12:U262">1:2</span>)</span>)</span>+<span class="mxinfo " id="T12:U263"><span class="var type1" id="S19T62U390">crd</span>(<span class="var type1" id="S31T6U391">mv</span>,<span class="mxinfo " id="T12:U266"><span class="mxinfo " id="T6:U267"><span class="mxinfo " id="T6:U268"><span class="var type1" id="S29T82U395">parX</span>(<span class="var type1" id="S35T6U396">i</span>,<span class="var type1" id="S31T6U397">mv</span>)</span>*<span class="mxinfo " id="T6:U272">2</span></span>+(<span class="mxinfo " id="T12:U273">-1:0</span>)</span>)</span></span>)-<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,43" id="srcline43"> 43</a></span><span class="line">                (<span class="mxinfo " id="T12:U274"><span class="mxinfo " id="T12:U275"><span class="var type1" id="S19T62U407">crd</span>(<span class="var type1" id="S33T6U408">fx</span>,<span class="mxinfo " id="T12:U278"><span class="mxinfo " id="T6:U279"><span class="mxinfo " id="T6:U280"><span class="var type1" id="S29T82U412">parX</span>(<span class="var type1" id="S35T6U413">i</span>,<span class="var type1" id="S33T6U414">fx</span>)</span>*<span class="mxinfo " id="T6:U284">2</span></span>+(<span class="mxinfo " id="T12:U285">1:2</span>)</span>)</span>+<span class="mxinfo " id="T12:U286"><span class="var type1" id="S19T62U421">crd</span>(<span class="var type1" id="S33T6U422">fx</span>,<span class="mxinfo " id="T12:U289"><span class="mxinfo " id="T6:U290"><span class="mxinfo " id="T6:U291"><span class="var type1" id="S29T82U426">parX</span>(<span class="var type1" id="S35T6U427">i</span>,<span class="var type1" id="S33T6U428">fx</span>)</span>*<span class="mxinfo " id="T6:U295">2</span></span>+(<span class="mxinfo " id="T12:U296">-1:0</span>)</span>)</span></span>)</span></span>; <span class="comment">%vector fixed -&gt; moving c.o.m.</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,44" id="srcline44"> 44</a></span><span class="line">            <span class="mxinfo " id="T6:U297"><span class="var type1" id="S44T6U437">fDir</span>=<span class="mxinfo " id="T6:U299">sign(<span class="mxinfo " id="T6:U300"><span class="var type1" id="S37T12U441">vecTr</span>*<span class="mxinfo " id="T19:U302"><span class="var type1" id="S45T12U443">vec2m</span>'</span></span>)</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="93,45" id="srcline45"> 45</a></span><span class="line">            <span class="mxinfo " id="T6:U304"><span class="mxinfo " id="T6:U305"><span class="var type1" id="S3T15U447">currOrd</span>(<span class="var type1" id="S38T6U448">pIx</span>)</span>=<span class="mxinfo " id="T6:U308"><span class="var type1" id="S41T6U450">sgn</span>*<span class="var type1" id="S44T6U451">fDir</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,46" id="srcline46"> 46</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,47" id="srcline47"> 47</a></span><span class="line">        <span class="mxinfo " id="T6:U311"><span class="mxinfo " id="T6:U312"><span class="var type1" id="S4T15U455">flipPar</span>(<span class="var type1" id="S38T6U456">pIx</span>)</span>=<span class="var type1" id="S40T6U457">coOrient</span></span>; <span class="comment">%tells what to do under smarticle swap</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,48" id="srcline48"> 48</a></span><span class="line">        <span class="mxinfo " id="T12:U316"><span class="var type1" id="S34T12U460">netF</span>=<span class="mxinfo " id="T12:U318"><span class="var type1" id="S34T12U462">netF</span>+<span class="mxinfo " id="T12:U320"><span class="var type1" id="S44T6U464">fDir</span>*<span class="var type1" id="S37T12U465">vecTr</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,49" id="srcline49"> 49</a></span><span class="line">      <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,50" id="srcline50"> 50</a></span><span class="line">      <span class="mxinfo " id="T12:U323"><span class="mxinfo " id="T12:U324"><span class="var type1" id="S2T14U469">xSm</span>(<span class="var type1" id="S31T6U470">mv</span>,<span class="mxinfo " id="T12:U327"><span class="mxinfo " id="T6:U328">1</span>:<span class="mxinfo " id="T6:U329">2</span></span>)</span>=<span class="mxinfo " id="T12:U330"><span class="mxinfo " id="T12:U331"><span class="var type1" id="S2T14U476">xSm</span>(<span class="var type1" id="S31T6U477">mv</span>,<span class="mxinfo " id="T12:U334"><span class="mxinfo " id="T6:U335">1</span>:<span class="mxinfo " id="T6:U336">2</span></span>)</span>+<span class="mxinfo " id="T12:U337"><span class="mxinfo " id="T12:U338"><span class="var type1" id="S34T12U483">netF</span>/<span class="mxinfo " id="T6:U340">norm(<span class="mxinfo " id="T12:U341"><span class="var type1" id="S34T12U487">netF</span>+<span class="mxinfo " id="T6:U343">1E-5</span></span>)</span></span>*<span class="var type1" id="S18T6U489">parShift</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,51" id="srcline51"> 51</a></span><span class="line">      <span class="mxinfo " id="T6:U345"><span class="mxinfo " id="T6:U346"><span class="var type1" id="S2T14U493">xSm</span>(<span class="var type1" id="S31T6U494">mv</span>,<span class="mxinfo " id="T6:U349">3</span>)</span>=<span class="mxinfo " id="T6:U350"><span class="mxinfo " id="T6:U351"><span class="var type1" id="S2T14U498">xSm</span>(<span class="var type1" id="S31T6U499">mv</span>,<span class="mxinfo " id="T6:U354">3</span>)</span>+<span class="mxinfo " id="T6:U355">(<span class="mxinfo " id="T6:U356"><span class="mxinfo " id="T6:U357">rand</span>-<span class="mxinfo " id="T6:U358">0.5</span></span>)*<span class="var type1" id="S11T6U507">tRes</span></span></span></span>; <span class="comment">%add angle fluctuation</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,52" id="srcline52"> 52</a></span><span class="line">      <span class="keyword">return</span>; <span class="comment">%handle any intersections next time around</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,53" id="srcline53"> 53</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,54" id="srcline54"> 54</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="93,55" id="srcline55"> 55</a></span><span class="line">    <span class="comment">% Handle intersections========================</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,56" id="srcline56"> 56</a></span><span class="line"><span class="comment">%     scatter(inters.intMatrixX(:),inters.intMatrixY(:),1000,'r.'); %mark collision points</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,57" id="srcline57"> 57</a></span><span class="line">    <span class="comment">% handle different possible intersection scenarios:-----------</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,58" id="srcline58"> 58</a></span><span class="line">    <span class="comment">% group corner intersections:</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,59" id="srcline59"> 59</a></span><span class="line">    <span class="mxinfo " id="T70:U360"><span class="var type1" id="S47T70U511">tmpInt</span>=<span class="mxinfo " id="T70:U362"><span class="var type1" id="S22T69U513">inters</span>.intAdjacencyMatrix</span></span>; <span class="mxinfo " id="T6:U364"><span class="var type1" id="S48T6U517">ii</span>=<span class="mxinfo " id="T6:U366">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,60" id="srcline60"> 60</a></span><span class="line">    <span class="mxinfo " id="T125:U367"><span class="var type1" id="S49T125U521">intList</span>=<span class="mxinfo " id="T125:U369">zeros(<span class="mxinfo " id="T6:U370">3</span>,<span class="mxinfo " id="T6:U371">6</span>)</span></span>; <span class="comment">%[src,trg,sLk,tLk,beg,intDistTrg] - distinct intersections</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,61" id="srcline61"> 61</a></span><span class="line">    <span class="mxinfo " id="T90:U372"><span class="var type1" id="S50T90U528">crn1</span>=<span class="mxinfo " id="T90:U374">find(<span class="mxinfo " id="T20:U375"><span class="mxinfo " id="T20:U376"><span class="mxinfo " id="T24:U377">sum(<span class="var type1" id="S47T70U535">tmpInt</span>)</span>==<span class="mxinfo " id="T6:U379">2</span></span> &amp; <span class="mxinfo " id="T20:U380"><span class="var type1" id="S47T70U538">tmpInt</span>(<span class="mxinfo " id="T6:U382">2</span>,<span class="mxinfo " id="T22:U383">:</span>)</span></span>)</span></span>; <span class="comment">%corners: trg=2</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,62" id="srcline62"> 62</a></span><span class="line">    <span class="mxinfo " id="T93:U384"><span class="var type1" id="S52T93U543">crn2</span>=<span class="mxinfo " id="T93:U386">find(<span class="mxinfo " id="T58:U387"><span class="mxinfo " id="T58:U388"><span class="mxinfo " id="T63:U389">sum(<span class="var type1" id="S47T70U550">tmpInt</span>,2)</span>==<span class="mxinfo " id="T6:U391">2</span></span> &amp; <span class="mxinfo " id="T58:U392"><span class="var type1" id="S47T70U554">tmpInt</span>(<span class="mxinfo " id="T22:U394">:</span>,<span class="mxinfo " id="T6:U395">2</span>)</span></span>)</span></span>; <span class="comment">%corners: trg=1</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,63" id="srcline63"> 63</a></span><span class="line">    <span class="keyword">if</span>(<span class="mxinfo " id="T4:U396">any(<span class="var type1" id="S50T90U563">crn1</span>)</span> &amp;&amp; <span class="mxinfo " id="T4:U398">any(<span class="var type1" id="S52T93U566">crn2</span>)</span>) <span class="comment">%take the smaller corner</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,64" id="srcline64"> 64</a></span><span class="line">        <span class="mxinfo " id="T6:U400"><span class="var type1" id="S53T6U569">dist1</span>=<span class="mxinfo " id="T6:U402"><span class="mxinfo " id="T59:U403"><span class="var type1" id="S22T69U572">inters</span>.intNormalizedDistance1To2</span>(<span class="mxinfo " id="T8:U405">2</span>,<span class="mxinfo " id="T6:U406"><span class="var type1" id="S50T90U576">crn1</span>(<span class="mxinfo " id="T6:U408">1</span>)</span>)</span></span>; <span class="mxinfo " id="T6:U409"><span class="var type1" id="S53T6U580">dist1</span>=<span class="mxinfo " id="T6:U411">min(<span class="var type1" id="S53T6U583">dist1</span>,<span class="mxinfo " id="T6:U413"><span class="mxinfo " id="T6:U414">1</span>-<span class="var type1" id="S53T6U586">dist1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,65" id="srcline65"> 65</a></span><span class="line">        <span class="mxinfo " id="T6:U416"><span class="var type1" id="S55T6U589">dist2</span>=<span class="mxinfo " id="T6:U418"><span class="mxinfo " id="T59:U419"><span class="var type1" id="S22T69U592">inters</span>.intNormalizedDistance2To1</span>(<span class="mxinfo " id="T6:U421"><span class="var type1" id="S52T93U595">crn2</span>(<span class="mxinfo " id="T6:U423">1</span>)</span>,<span class="mxinfo " id="T8:U424">2</span>)</span></span>; <span class="mxinfo " id="T6:U425"><span class="var type1" id="S55T6U600">dist2</span>=<span class="mxinfo " id="T6:U427">min(<span class="var type1" id="S55T6U603">dist2</span>,<span class="mxinfo " id="T6:U429"><span class="mxinfo " id="T6:U430">1</span>-<span class="var type1" id="S55T6U606">dist2</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,66" id="srcline66"> 66</a></span><span class="line">        <span class="keyword">if</span>(<span class="mxinfo " id="T4:U432"><span class="var type1" id="S53T6U611">dist1</span>&gt;<span class="var type1" id="S55T6U612">dist2</span></span>); <span class="mxinfo " id="T90:U435"><span class="message warning" id="M1F625C"><span class="var type1" id="S50T90U615">crn1</span>=[]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,67" id="srcline67"> 67</a></span><span class="line">        <span class="keyword">else</span>; <span class="mxinfo " id="T93:U437"><span class="message warning" id="M2F625C"><span class="var type1" id="S52T93U621">crn2</span>=[]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,68" id="srcline68"> 68</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,69" id="srcline69"> 69</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,70" id="srcline70"> 70</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S35T6U626">i</span>=<span class="mxinfo " id="T6:U440">1</span>:<span class="mxinfo " id="T6:U441">length(<span class="var type1" id="S50T90U631">crn1</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,71" id="srcline71"> 71</a></span><span class="line">        <span class="mxinfo " id="T6:U443"><span class="var type1" id="S56T6U634">intDistTrg</span>=<span class="mxinfo " id="T6:U445"><span class="mxinfo " id="T6:U446">sum(<span class="mxinfo " id="T93:U447"><span class="mxinfo " id="T59:U448"><span class="var type1" id="S22T69U640">inters</span>.intNormalizedDistance2To1</span>(<span class="mxinfo " id="T58:U450"><span class="var type1" id="S47T70U643">tmpInt</span>(<span class="mxinfo " id="T22:U452">:</span>,<span class="mxinfo " id="T6:U453"><span class="var type1" id="S50T90U646">crn1</span>(<span class="var type1" id="S35T6U647">i</span>)</span>)</span>,<span class="mxinfo " id="T6:U456"><span class="var type1" id="S50T90U649">crn1</span>(<span class="var type1" id="S35T6U650">i</span>)</span>)</span>)</span>/<span class="mxinfo " id="T6:U459">2</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,72" id="srcline72"> 72</a></span><span class="line">        <span class="mxinfo " id="T102:U460"><span class="mxinfo " id="T102:U461"><span class="var type1" id="S49T125U655">intList</span>(<span class="var type1" id="S48T6U656">ii</span>,<span class="mxinfo " id="T126:U464">:</span>)</span>=<span class="mxinfo " id="T102:U465">[<span class="mxinfo " id="T6:U466">1</span>,<span class="mxinfo " id="T6:U467">2</span>,<span class="mxinfo " id="T6:U468">2</span>,<span class="mxinfo " id="T6:U469"><span class="var type1" id="S50T90U664">crn1</span>(<span class="var type1" id="S35T6U665">i</span>)</span>,<span class="mxinfo " id="T4:U472"><span class="var type1" id="S47T70U667">tmpInt</span>(<span class="mxinfo " id="T6:U474">1</span>,<span class="mxinfo " id="T6:U475"><span class="var type1" id="S50T90U670">crn1</span>(<span class="var type1" id="S35T6U671">i</span>)</span>)</span>,<span class="var type1" id="S56T6U672">intDistTrg</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,73" id="srcline73"> 73</a></span><span class="line">        <span class="mxinfo " id="T6:U479"><span class="var type1" id="S48T6U675">ii</span>=<span class="mxinfo " id="T6:U481"><span class="var type1" id="S48T6U677">ii</span>+<span class="mxinfo " id="T6:U483">1</span></span></span>; <span class="mxinfo " id="T58:U484"><span class="mxinfo " id="T58:U485"><span class="var type1" id="S47T70U682">tmpInt</span>(<span class="mxinfo " id="T22:U487">:</span>,<span class="mxinfo " id="T6:U488"><span class="var type1" id="S50T90U685">crn1</span>(<span class="var type1" id="S35T6U686">i</span>)</span>)</span>=<span class="mxinfo " id="T6:U491">0</span></span>; <span class="comment">%remove intersection from mx</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,74" id="srcline74"> 74</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,75" id="srcline75"> 75</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S35T6U690">i</span>=<span class="mxinfo " id="T6:U493">1</span>:<span class="mxinfo " id="T6:U494">length(<span class="var type1" id="S52T93U695">crn2</span>)</span> </span></span>
<span class="srcline"><span class="lineno"><a href="93,76" id="srcline76"> 76</a></span><span class="line">        <span class="mxinfo " id="T6:U496"><span class="var type1" id="S56T6U698">intDistTrg</span>=<span class="mxinfo " id="T6:U498"><span class="mxinfo " id="T6:U499">sum(<span class="mxinfo " id="T90:U500"><span class="mxinfo " id="T59:U501"><span class="var type1" id="S22T69U704">inters</span>.intNormalizedDistance1To2</span>(<span class="mxinfo " id="T6:U503"><span class="var type1" id="S52T93U707">crn2</span>(<span class="var type1" id="S35T6U708">i</span>)</span>,<span class="mxinfo " id="T20:U506"><span class="var type1" id="S47T70U710">tmpInt</span>(<span class="mxinfo " id="T6:U508"><span class="var type1" id="S52T93U712">crn2</span>(<span class="var type1" id="S35T6U713">i</span>)</span>,<span class="mxinfo " id="T22:U511">:</span>)</span>)</span>)</span>/<span class="mxinfo " id="T6:U512">2</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,77" id="srcline77"> 77</a></span><span class="line"><span class="comment">%         ixRep=find(intList(:,6)&gt;0 &amp; (intDistTrg&gt;intList(:,6) | intDistTrg&gt;1-intList(:,6)));</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,78" id="srcline78"> 78</a></span><span class="line">        <span class="mxinfo " id="T102:U513"><span class="mxinfo " id="T102:U514"><span class="var type1" id="S49T125U719">intList</span>(<span class="var type1" id="S48T6U720">ii</span>,<span class="mxinfo " id="T126:U517">:</span>)</span>=<span class="mxinfo " id="T102:U518">[<span class="mxinfo " id="T6:U519">2</span>,<span class="mxinfo " id="T6:U520">1</span>,<span class="mxinfo " id="T6:U521">2</span>,<span class="mxinfo " id="T6:U522"><span class="var type1" id="S52T93U728">crn2</span>(<span class="var type1" id="S35T6U729">i</span>)</span>,<span class="mxinfo " id="T4:U525"><span class="var type1" id="S47T70U731">tmpInt</span>(<span class="mxinfo " id="T6:U527"><span class="var type1" id="S52T93U733">crn2</span>(<span class="var type1" id="S35T6U734">i</span>)</span>,<span class="mxinfo " id="T6:U530">1</span>)</span>,<span class="var type1" id="S56T6U736">intDistTrg</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,79" id="srcline79"> 79</a></span><span class="line">        <span class="mxinfo " id="T6:U532"><span class="var type1" id="S48T6U739">ii</span>=<span class="mxinfo " id="T6:U534"><span class="var type1" id="S48T6U741">ii</span>+<span class="mxinfo " id="T6:U536">1</span></span></span>; <span class="mxinfo " id="T20:U537"><span class="mxinfo " id="T20:U538"><span class="var type1" id="S47T70U746">tmpInt</span>(<span class="mxinfo " id="T6:U540"><span class="var type1" id="S52T93U748">crn2</span>(<span class="var type1" id="S35T6U749">i</span>)</span>,<span class="mxinfo " id="T22:U543">:</span>)</span>=<span class="mxinfo " id="T6:U544">0</span></span>; <span class="comment">%remove intersection from mx</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,80" id="srcline80"> 80</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,81" id="srcline81"> 81</a></span><span class="line">    <span class="keyword">if</span>(<span class="mxinfo " id="T4:U545"><span class="var type1" id="S47T70U757">tmpInt</span>(<span class="mxinfo " id="T8:U547">2</span>,<span class="mxinfo " id="T8:U548">2</span>)</span> &amp;&amp; <span class="mxinfo " id="T4:U549"><span class="mxinfo " id="T6:U550">sum(<span class="mxinfo " id="T24:U551">sum(<span class="var type1" id="S47T70U765">tmpInt</span>)</span>)</span>&gt;<span class="mxinfo " id="T6:U553">1</span></span>) <span class="comment">%two corners intersecting</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,82" id="srcline82"> 82</a></span><span class="line"><span class="comment">%     if(sum(tmpInt(2,:))==1 &amp;&amp; sum(tmpInt(:,2))==1 &amp;&amp; sum(sum(tmpInt))&gt;1) </span></span></span>
<span class="srcline"><span class="lineno"><a href="93,83" id="srcline83"> 83</a></span><span class="line">        <span class="mxinfo " id="T4:U554"><span class="mxinfo " id="T4:U555"><span class="var type1" id="S47T70U770">tmpInt</span>(<span class="mxinfo " id="T8:U557">2</span>,<span class="mxinfo " id="T8:U558">2</span>)</span>=0</span>; [<span class="var type1" id="S57T75U777">ins1</span>,<span class="var type1" id="S58T75U778">ins2</span>]=find(<span class="var type1" id="S47T70U781">tmpInt</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="93,84" id="srcline84"> 84</a></span><span class="line">        <span class="mxinfo " id="T95:U562"><span class="var type1" id="S59T95U784">ci</span>=<span class="mxinfo " id="T95:U564">xor(<span class="mxinfo " id="T97:U565"><span class="mxinfo " id="T127:U566"><span class="mxinfo " id="T59:U567"><span class="var type1" id="S22T69U790">inters</span>.intNormalizedDistance1To2</span>(<span class="var type1" id="S57T75U792">ins1</span>,<span class="var type1" id="S58T75U793">ins2</span>)</span>&gt;<span class="mxinfo " id="T127:U571"><span class="mxinfo " id="T6:U572">1</span>-<span class="mxinfo " id="T127:U573"><span class="mxinfo " id="T59:U574"><span class="var type1" id="S22T69U798">inters</span>.intNormalizedDistance1To2</span>(<span class="var type1" id="S57T75U800">ins1</span>,<span class="var type1" id="S58T75U801">ins2</span>)</span></span></span>,<span class="mxinfo " id="T95:U578"><span class="var type1" id="S57T75U803">ins1</span>==<span class="mxinfo " id="T6:U580">3</span></span>)</span></span>; <span class="comment">%end xor 3</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,85" id="srcline85"> 85</a></span><span class="line">        <span class="keyword">if</span>(<span class="mxinfo " id="T4:U581"><span class="mxinfo " id="T6:U582">sum(<span class="var type1" id="S59T95U811">ci</span>)</span>~=<span class="mxinfo " id="T6:U584">1</span></span>); error(<span class="string">'corners intersection problem'</span>); <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,86" id="srcline86"> 86</a></span><span class="line">        <span class="mxinfo " id="T102:U585"><span class="mxinfo " id="T102:U586"><span class="var type1" id="S49T125U820">intList</span>(<span class="var type1" id="S48T6U821">ii</span>,<span class="mxinfo " id="T126:U589">:</span>)</span>=<span class="mxinfo " id="T102:U590">[1,2,2,2,<span class="mxinfo " id="T95:U591"><span class="mxinfo " id="T75:U592"><span class="var type1" id="S57T75U831">ins1</span>(<span class="var type1" id="S59T95U832">ci</span>)</span>==<span class="mxinfo " id="T6:U595">1</span></span>,<span class="mxinfo " id="T95:U596"><span class="mxinfo " id="T75:U597"><span class="var type1" id="S58T75U836">ins2</span>(<span class="var type1" id="S59T95U837">ci</span>)</span>==<span class="mxinfo " id="T6:U600">3</span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,87" id="srcline87"> 87</a></span><span class="line">        <span class="mxinfo " id="T6:U601"><span class="var type1" id="S48T6U841">ii</span>=<span class="mxinfo " id="T6:U603"><span class="var type1" id="S48T6U843">ii</span>+<span class="mxinfo " id="T6:U605">1</span></span></span>; <span class="mxinfo " id="T97:U606"><span class="mxinfo " id="T97:U607"><span class="var type1" id="S47T70U848">tmpInt</span>(<span class="mxinfo " id="T75:U609"><span class="var type1" id="S57T75U850">ins1</span>(<span class="var type1" id="S59T95U851">ci</span>)</span>,<span class="mxinfo " id="T75:U612"><span class="var type1" id="S58T75U853">ins2</span>(<span class="var type1" id="S59T95U854">ci</span>)</span>)</span>=<span class="mxinfo " id="T6:U615">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,88" id="srcline88"> 88</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,89" id="srcline89"> 89</a></span><span class="line">    <span class="keyword">if</span>(<span class="mxinfo " id="T4:U616"><span class="mxinfo " id="T6:U617">sum(<span class="mxinfo " id="T20:U618"><span class="var type1" id="S47T70U864">tmpInt</span>(<span class="mxinfo " id="T8:U620">2</span>,<span class="mxinfo " id="T22:U621">:</span>)</span>)</span>==<span class="mxinfo " id="T6:U622">1</span></span> &amp;&amp; <span class="mxinfo " id="T4:U623"><span class="mxinfo " id="T6:U624">sum(<span class="mxinfo " id="T58:U625"><span class="var type1" id="S47T70U872">tmpInt</span>(<span class="mxinfo " id="T22:U627">:</span>,<span class="mxinfo " id="T8:U628">2</span>)</span>)</span>==<span class="mxinfo " id="T6:U629">1</span></span>) <span class="comment">%two corners intersecting</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,90" id="srcline90"> 90</a></span><span class="line">        <span class="mxinfo " id="T75:U630"><span class="var type1" id="S57T75U878">ins1</span>=<span class="mxinfo " id="T93:U632">find(<span class="mxinfo " id="T58:U633"><span class="var type1" id="S47T70U882">tmpInt</span>(<span class="mxinfo " id="T22:U635">:</span>,<span class="mxinfo " id="T8:U636">2</span>)</span>)</span></span>; <span class="mxinfo " id="T6:U637"><span class="var type1" id="S58T6U887">ins2</span>=<span class="mxinfo " id="T6:U639">2</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,91" id="srcline91"> 91</a></span><span class="line">        <span class="mxinfo " id="T95:U640"><span class="var type1" id="S59T95U891">ci</span>=<span class="mxinfo " id="T105:U642">xor(<span class="mxinfo " id="T105:U643"><span class="mxinfo " id="T93:U644"><span class="mxinfo " id="T59:U645"><span class="var type1" id="S22T69U897">inters</span>.intNormalizedDistance1To2</span>(<span class="var type1" id="S57T75U899">ins1</span>,<span class="var type1" id="S58T6U900">ins2</span>)</span>&gt;<span class="mxinfo " id="T93:U649"><span class="mxinfo " id="T6:U650">1</span>-<span class="mxinfo " id="T93:U651"><span class="mxinfo " id="T59:U652"><span class="var type1" id="S22T69U905">inters</span>.intNormalizedDistance1To2</span>(<span class="var type1" id="S57T75U907">ins1</span>,<span class="var type1" id="S58T6U908">ins2</span>)</span></span></span>,<span class="mxinfo " id="T105:U656"><span class="var type1" id="S57T75U910">ins1</span>==<span class="mxinfo " id="T6:U658">3</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,92" id="srcline92"> 92</a></span><span class="line">        <span class="mxinfo " id="T4:U659"><span class="keyword">if</span>(<span class="var type1" id="S59T95U915">ci</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="93,93" id="srcline93"> 93</a></span><span class="line">            <span class="mxinfo " id="T102:U661"><span class="mxinfo " id="T102:U662"><span class="var type1" id="S49T125U919">intList</span>(<span class="var type1" id="S48T6U920">ii</span>,<span class="mxinfo " id="T126:U665">:</span>)</span>=<span class="mxinfo " id="T110:U666">[1,2,<span class="var type1" id="S57T75U926">ins1</span>,2,<span class="mxinfo " id="T105:U668"><span class="var type1" id="S57T75U929">ins1</span>==<span class="mxinfo " id="T6:U670">3</span></span>,<span class="mxinfo " id="T109:U671"><span class="mxinfo " id="T90:U672">find(<span class="mxinfo " id="T20:U673"><span class="var type1" id="S47T70U935">tmpInt</span>(<span class="mxinfo " id="T8:U675">2</span>,<span class="mxinfo " id="T22:U676">:</span>)</span>)</span>==<span class="mxinfo " id="T6:U677">3</span></span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,94" id="srcline94"> 94</a></span><span class="line">            <span class="mxinfo " id="T6:U678"><span class="var type1" id="S48T6U941">ii</span>=<span class="mxinfo " id="T6:U680"><span class="var type1" id="S48T6U943">ii</span>+<span class="mxinfo " id="T6:U682">1</span></span></span>; <span class="mxinfo " id="T20:U683"><span class="mxinfo " id="T20:U684"><span class="var type1" id="S47T70U948">tmpInt</span>(<span class="mxinfo " id="T8:U686">2</span>,<span class="mxinfo " id="T22:U687">:</span>)</span>=<span class="mxinfo " id="T6:U688">0</span></span>; <span class="mxinfo " id="T58:U689"><span class="mxinfo " id="T58:U690"><span class="var type1" id="S47T70U955">tmpInt</span>(<span class="mxinfo " id="T22:U692">:</span>,<span class="mxinfo " id="T8:U693">2</span>)</span>=<span class="mxinfo " id="T6:U694">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,95" id="srcline95"> 95</a></span><span class="line">        <span class="keyword">end</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="93,96" id="srcline96"> 96</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,97" id="srcline97"> 97</a></span><span class="line">    [<span class="var type1" id="S57T75U962">ins1</span>,<span class="var type1" id="S58T75U963">ins2</span>]=find(<span class="var type1" id="S47T70U966">tmpInt</span>); <span class="mxinfo " id="T82:U698"><span class="var type1" id="S62T82U969">inX</span>=<span class="mxinfo " id="T82:U700">[<span class="var type1" id="S57T75U972">ins1</span>, <span class="var type1" id="S58T75U973">ins2</span>]</span></span>; <span class="comment">%get intersection index</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,98" id="srcline98"> 98</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S35T6U976">i</span>=<span class="mxinfo " id="T6:U704">1</span>:<span class="mxinfo " id="T6:U705">length(<span class="var type1" id="S57T75U981">ins1</span>)</span> <span class="comment">%single intersections</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,99" id="srcline99"> 99</a></span><span class="line"><span class="comment">%         if(ins1(i)==2 &amp;&amp; ins2(i)==2); continue; end %just ignore it - probably a corner</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,100" id="srcline100">100</a></span><span class="line">        [<span class="var type1" id="S63T6U985">src</span>,<span class="var type1" id="S64T6U986">trg</span>,<span class="var type1" id="S65T4U987">beg</span>,<span class="var type1" id="S56T6U988">intDistTrg</span>]=<span class="fcn" id="F558N6:B990">findSrc</span>(<span class="var type1" id="S22T69U991">inters</span>,<span class="mxinfo " id="T6:U712"><span class="var type1" id="S57T75U993">ins1</span>(<span class="var type1" id="S35T6U994">i</span>)</span>,<span class="mxinfo " id="T6:U715"><span class="var type1" id="S58T75U996">ins2</span>(<span class="var type1" id="S35T6U997">i</span>)</span>,<span class="var type1" id="S12T24U998">lenVc</span>); </span></span>
<span class="srcline"><span class="lineno"><a href="93,101" id="srcline101">101</a></span><span class="line">        <span class="mxinfo " id="T102:U719"><span class="mxinfo " id="T102:U720"><span class="var type1" id="S49T125U1002">intList</span>(<span class="var type1" id="S48T6U1003">ii</span>,<span class="mxinfo " id="T126:U723">:</span>)</span>=<span class="mxinfo " id="T102:U724">[<span class="var type1" id="S63T6U1007">src</span>,<span class="var type1" id="S64T6U1008">trg</span>,<span class="mxinfo " id="T6:U727"><span class="var type1" id="S62T82U1010">inX</span>(<span class="var type1" id="S35T6U1011">i</span>,<span class="var type1" id="S63T6U1012">src</span>)</span>,<span class="mxinfo " id="T6:U731"><span class="var type1" id="S62T82U1014">inX</span>(<span class="var type1" id="S35T6U1015">i</span>,<span class="var type1" id="S64T6U1016">trg</span>)</span>,<span class="var type1" id="S65T4U1017">beg</span>,<span class="var type1" id="S56T6U1018">intDistTrg</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,102" id="srcline102">102</a></span><span class="line">        <span class="mxinfo " id="T6:U737"><span class="var type1" id="S48T6U1021">ii</span>=<span class="mxinfo " id="T6:U739"><span class="var type1" id="S48T6U1023">ii</span>+<span class="mxinfo " id="T6:U741">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,103" id="srcline103">103</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,104" id="srcline104">104</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="93,105" id="srcline105">105</a></span><span class="line">    <span class="comment">% move according to type of interaction-------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,106" id="srcline106">106</a></span><span class="line">    <span class="keyword">switch</span> <span class="var type1" id="S48T6U1026">ii</span> <span class="comment">%switch on number of distinct contacts</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,107" id="srcline107">107</a></span><span class="line">        <span class="keyword">case</span> <span class="mxinfo " id="T6:U743">1</span> <span class="comment">%no intersections </span></span></span>
<span class="srcline"><span class="lineno"><a href="93,108" id="srcline108">108</a></span><span class="line">        <span class="keyword">case</span> <span class="mxinfo " id="T6:U744">2</span> <span class="comment">%if only one intersection: rotate------------------ </span></span></span>
<span class="srcline"><span class="lineno"><a href="93,109" id="srcline109">109</a></span><span class="line">    <span class="mxinfo " id="T6:U745"><span class="var type1" id="S63T6U1033">src</span>=<span class="mxinfo " id="T6:U747"><span class="var type1" id="S49T125U1035">intList</span>(<span class="mxinfo " id="T8:U749">1</span>,<span class="mxinfo " id="T8:U750">1</span>)</span></span>; <span class="mxinfo " id="T6:U751"><span class="var type1" id="S64T6U1040">trg</span>=<span class="mxinfo " id="T6:U753"><span class="var type1" id="S49T125U1042">intList</span>(<span class="mxinfo " id="T8:U755">1</span>,<span class="mxinfo " id="T8:U756">2</span>)</span></span>; <span class="mxinfo " id="T6:U757"><span class="var type1" id="S67T6U1047">sLk</span>=<span class="mxinfo " id="T6:U759"><span class="var type1" id="S49T125U1049">intList</span>(<span class="mxinfo " id="T8:U761">1</span>,<span class="mxinfo " id="T8:U762">3</span>)</span></span>; <span class="mxinfo " id="T6:U763"><span class="var type1" id="S68T6U1054">tLk</span>=<span class="mxinfo " id="T6:U765"><span class="var type1" id="S49T125U1056">intList</span>(<span class="mxinfo " id="T8:U767">1</span>,<span class="mxinfo " id="T8:U768">4</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,110" id="srcline110">110</a></span><span class="line">    <span class="mxinfo " id="T6:U769"><span class="var type1" id="S65T6U1061">beg</span>=<span class="mxinfo " id="T6:U771"><span class="var type1" id="S49T125U1063">intList</span>(<span class="mxinfo " id="T8:U773">1</span>,<span class="mxinfo " id="T8:U774">5</span>)</span></span>; <span class="mxinfo " id="T6:U775"><span class="var type1" id="S56T6U1068">intDistTrg</span>=<span class="mxinfo " id="T6:U777"><span class="var type1" id="S49T125U1070">intList</span>(<span class="mxinfo " id="T8:U779">1</span>,<span class="mxinfo " id="T8:U780">6</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,111" id="srcline111">111</a></span><span class="line">    <span class="comment">%find force:</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,112" id="srcline112">112</a></span><span class="line">    [<span class="var type1" id="S69T6U1076">fAng</span>,<span class="var type1" id="S44T6U1077">fDir</span>,<span class="var type1" id="S70T12U1078">vStickOut</span>]=<span class="fcn" id="F576N7:B1080">intForce</span>(<span class="var type1" id="S5T17U1081">sm</span>,<span class="var type1" id="S19T62U1082">crd</span>,<span class="var type1" id="S63T6U1083">src</span>,<span class="var type1" id="S67T6U1084">sLk</span>,<span class="var type1" id="S65T6U1085">beg</span>,<span class="var type1" id="S64T6U1086">trg</span>,<span class="var type1" id="S68T6U1087">tLk</span>,<span class="var type1" id="S56T6U1088">intDistTrg</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="93,113" id="srcline113">113</a></span><span class="line">    <span class="comment">%get force angle from what we are pushing on (normal to the surface):</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,114" id="srcline114">114</a></span><span class="line">    <span class="comment">%and calculate the response on the pushed smarticle:</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,115" id="srcline115">115</a></span><span class="line">    <span class="mxinfo " id="T14:U792"><span class="var type1" id="S72T14U1091">piv</span>=<span class="mxinfo " id="T14:U794">zeros(<span class="mxinfo " id="T6:U795">2</span>,<span class="mxinfo " id="T6:U796">3</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,116" id="srcline116">116</a></span><span class="line">    <span class="keyword">switch</span> <span class="var type1" id="S68T6U1097">tLk</span> <span class="comment">%pivot target</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,117" id="srcline117">117</a></span><span class="line">        <span class="keyword">case</span> <span class="mxinfo " id="T6:U798">1</span> <span class="comment">%left arm pushed</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,118" id="srcline118">118</a></span><span class="line">          <span class="mxinfo " id="T24:U799"><span class="mxinfo " id="T24:U800"><span class="var type1" id="S72T14U1103">piv</span>(<span class="var type1" id="S64T6U1104">trg</span>,<span class="mxinfo " id="T22:U803">:</span>)</span>=<span class="mxinfo " id="T24:U804"><span class="fcn" id="F588N8:B1107">pivotArm</span>(<span class="mxinfo " id="T6:U805"><span class="var type1" id="S5T17U1109">sm</span>(<span class="var type1" id="S64T6U1110">trg</span>,<span class="mxinfo " id="T8:U808">4</span>)</span>, <span class="mxinfo " id="T6:U809"><span class="mxinfo " id="T6:U810"><span class="var type1" id="S5T17U1114">sm</span>(<span class="var type1" id="S64T6U1115">trg</span>,<span class="mxinfo " id="T8:U813">4</span>)</span>+<span class="mxinfo " id="T6:U814"><span class="mxinfo " id="T6:U815">pi</span>/<span class="mxinfo " id="T6:U816">2</span></span></span>, <span class="mxinfo " id="T6:U817"><span class="mxinfo " id="T6:U818">(<span class="mxinfo " id="T6:U819"><span class="mxinfo " id="T6:U820">1</span>-<span class="var type1" id="S56T6U1126">intDistTrg</span></span>)*<span class="var type1" id="S9T6U1127">A</span></span>/<span class="var type1" id="S10T6U1128">B</span></span>)</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="93,119" id="srcline119">119</a></span><span class="line">          <span class="mxinfo " id="T12:U824"><span class="mxinfo " id="T12:U825"><span class="var type1" id="S72T14U1132">piv</span>(<span class="var type1" id="S64T6U1133">trg</span>,<span class="mxinfo " id="T12:U828">[<span class="mxinfo " id="T6:U829">1</span>,<span class="mxinfo " id="T6:U830">3</span>]</span>)</span>=<span class="mxinfo " id="T12:U831">-<span class="mxinfo " id="T12:U832"><span class="var type1" id="S72T14U1140">piv</span>(<span class="var type1" id="S64T6U1141">trg</span>,<span class="mxinfo " id="T12:U835">[<span class="mxinfo " id="T6:U836">1</span>,<span class="mxinfo " id="T6:U837">3</span>]</span>)</span></span></span>; <span class="comment">%flip x-axis</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,120" id="srcline120">120</a></span><span class="line">        <span class="keyword">case</span> <span class="mxinfo " id="T6:U838">2</span> <span class="comment">%body pushed</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,121" id="srcline121">121</a></span><span class="line">          <span class="mxinfo " id="T24:U839"><span class="mxinfo " id="T24:U840"><span class="var type1" id="S72T14U1151">piv</span>(<span class="var type1" id="S64T6U1152">trg</span>,<span class="mxinfo " id="T22:U843">:</span>)</span>=<span class="mxinfo " id="T24:U844"><span class="fcn" id="F595N9:B1155">pivotBody</span>(<span class="mxinfo " id="T6:U845"><span class="var type1" id="S56T6U1157">intDistTrg</span> - <span class="mxinfo " id="T6:U847">0.5</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,122" id="srcline122">122</a></span><span class="line">        <span class="keyword">case</span> <span class="mxinfo " id="T6:U848">3</span> <span class="comment">%right arm pushed</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,123" id="srcline123">123</a></span><span class="line">          <span class="mxinfo " id="T24:U849"><span class="mxinfo " id="T24:U850"><span class="var type1" id="S72T14U1164">piv</span>(<span class="var type1" id="S64T6U1165">trg</span>,<span class="mxinfo " id="T22:U853">:</span>)</span>=<span class="mxinfo " id="T24:U854"><span class="fcn" id="F588N8:B1168">pivotArm</span>(<span class="mxinfo " id="T6:U855"><span class="var type1" id="S5T17U1170">sm</span>(<span class="var type1" id="S64T6U1171">trg</span>,<span class="mxinfo " id="T8:U858">5</span>)</span>, <span class="mxinfo " id="T6:U859"><span class="mxinfo " id="T6:U860"><span class="var type1" id="S5T17U1175">sm</span>(<span class="var type1" id="S64T6U1176">trg</span>,<span class="mxinfo " id="T8:U863">5</span>)</span>+<span class="mxinfo " id="T6:U864"><span class="mxinfo " id="T6:U865">pi</span>/<span class="mxinfo " id="T6:U866">2</span></span></span>, <span class="mxinfo " id="T6:U867"><span class="mxinfo " id="T6:U868"><span class="var type1" id="S56T6U1184">intDistTrg</span>*<span class="var type1" id="S9T6U1185">A</span></span>/<span class="var type1" id="S10T6U1186">B</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,124" id="srcline124">124</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,125" id="srcline125">125</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="93,126" id="srcline126">126</a></span><span class="line">    <span class="comment">%calculate the response on the pushing smarticle:</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,127" id="srcline127">127</a></span><span class="line">    <span class="keyword">switch</span> <span class="var type1" id="S67T6U1188">sLk</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,128" id="srcline128">128</a></span><span class="line">        <span class="keyword">case</span> <span class="mxinfo " id="T6:U873">1</span>  <span class="comment">%pushing with left arm tip</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,129" id="srcline129">129</a></span><span class="line">          <span class="mxinfo " id="T24:U874"><span class="mxinfo " id="T24:U875"><span class="var type1" id="S72T14U1194">piv</span>(<span class="var type1" id="S63T6U1195">src</span>,<span class="mxinfo " id="T22:U878">:</span>)</span>=<span class="mxinfo " id="T24:U879"><span class="fcn" id="F588N8:B1198">pivotArm</span>(<span class="mxinfo " id="T6:U880"><span class="var type1" id="S5T17U1200">sm</span>(<span class="var type1" id="S63T6U1201">src</span>,<span class="mxinfo " id="T8:U883">4</span>)</span>, <span class="mxinfo " id="T6:U884"><span class="mxinfo " id="T6:U885"><span class="mxinfo " id="T6:U886">-<span class="var type1" id="S69T6U1206">fAng</span></span>+<span class="mxinfo " id="T6:U888"><span class="var type1" id="S5T17U1208">sm</span>(<span class="var type1" id="S63T6U1209">src</span>,<span class="mxinfo " id="T6:U891">3</span>)</span></span>+<span class="mxinfo " id="T6:U892"><span class="mxinfo " id="T6:U893">pi</span>/<span class="mxinfo " id="T6:U894">2</span></span></span>, <span class="mxinfo " id="T6:U895"><span class="var type1" id="S9T6U1216">A</span>/<span class="var type1" id="S10T6U1217">B</span></span>)</span></span>; <span class="mxinfo " id="T12:U898"><span class="mxinfo " id="T12:U899"><span class="var type1" id="S72T14U1221">piv</span>(<span class="var type1" id="S63T6U1222">src</span>,<span class="mxinfo " id="T12:U902">[<span class="mxinfo " id="T6:U903">1</span>,<span class="mxinfo " id="T6:U904">3</span>]</span>)</span>=<span class="mxinfo " id="T12:U905">-<span class="mxinfo " id="T12:U906"><span class="var type1" id="S72T14U1229">piv</span>(<span class="var type1" id="S63T6U1230">src</span>,<span class="mxinfo " id="T12:U909">[<span class="mxinfo " id="T6:U910">1</span>,<span class="mxinfo " id="T6:U911">3</span>]</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,130" id="srcline130">130</a></span><span class="line">        <span class="keyword">case</span> <span class="mxinfo " id="T6:U912">2</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,131" id="srcline131">131</a></span><span class="line">          <span class="keyword">if</span>(<span class="var type1" id="S65T6U1240">beg</span>) <span class="comment">%pusing with left corner</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,132" id="srcline132">132</a></span><span class="line">            <span class="mxinfo " id="T24:U914"><span class="mxinfo " id="T24:U915"><span class="var type1" id="S72T14U1244">piv</span>(<span class="var type1" id="S63T6U1245">src</span>,<span class="mxinfo " id="T22:U918">:</span>)</span>=<span class="mxinfo " id="T24:U919"><span class="fcn" id="F588N8:B1248">pivotArm</span>(<span class="mxinfo " id="T6:U920">0</span>, <span class="mxinfo " id="T6:U921"><span class="mxinfo " id="T6:U922"><span class="mxinfo " id="T6:U923">-<span class="var type1" id="S69T6U1253">fAng</span></span>+<span class="mxinfo " id="T6:U925"><span class="var type1" id="S5T17U1255">sm</span>(<span class="var type1" id="S63T6U1256">src</span>,<span class="mxinfo " id="T6:U928">3</span>)</span></span>+<span class="mxinfo " id="T6:U929"><span class="mxinfo " id="T6:U930">pi</span>/<span class="mxinfo " id="T6:U931">2</span></span></span>, <span class="mxinfo " id="T6:U932">0</span>)</span></span>; <span class="mxinfo " id="T12:U933"><span class="mxinfo " id="T12:U934"><span class="var type1" id="S72T14U1266">piv</span>(<span class="var type1" id="S63T6U1267">src</span>,<span class="mxinfo " id="T12:U937">[<span class="mxinfo " id="T6:U938">1</span>,<span class="mxinfo " id="T6:U939">3</span>]</span>)</span>=<span class="mxinfo " id="T12:U940">-<span class="mxinfo " id="T12:U941"><span class="var type1" id="S72T14U1274">piv</span>(<span class="var type1" id="S63T6U1275">src</span>,<span class="mxinfo " id="T12:U944">[<span class="mxinfo " id="T6:U945">1</span>,<span class="mxinfo " id="T6:U946">3</span>]</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,133" id="srcline133">133</a></span><span class="line">          <span class="keyword">else</span> <span class="comment">%if pushing with right corner</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,134" id="srcline134">134</a></span><span class="line">            <span class="mxinfo " id="T24:U947"><span class="mxinfo " id="T24:U948"><span class="var type1" id="S72T14U1284">piv</span>(<span class="var type1" id="S63T6U1285">src</span>,<span class="mxinfo " id="T22:U951">:</span>)</span>=<span class="mxinfo " id="T24:U952"><span class="fcn" id="F588N8:B1288">pivotArm</span>(<span class="mxinfo " id="T6:U953">0</span>, <span class="mxinfo " id="T6:U954"><span class="mxinfo " id="T6:U955"><span class="var type1" id="S69T6U1292">fAng</span>-<span class="mxinfo " id="T6:U957"><span class="var type1" id="S5T17U1294">sm</span>(<span class="var type1" id="S63T6U1295">src</span>,<span class="mxinfo " id="T6:U960">3</span>)</span></span>+<span class="mxinfo " id="T6:U961"><span class="mxinfo " id="T6:U962">pi</span>/<span class="mxinfo " id="T6:U963">2</span></span></span>, <span class="mxinfo " id="T6:U964">0</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,135" id="srcline135">135</a></span><span class="line">          <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,136" id="srcline136">136</a></span><span class="line">        <span class="keyword">case</span> <span class="mxinfo " id="T6:U965">3</span>  <span class="comment">%if pushing with the right arm tip</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,137" id="srcline137">137</a></span><span class="line">          <span class="mxinfo " id="T24:U966"><span class="mxinfo " id="T24:U967"><span class="var type1" id="S72T14U1307">piv</span>(<span class="var type1" id="S63T6U1308">src</span>,<span class="mxinfo " id="T22:U970">:</span>)</span>=<span class="mxinfo " id="T24:U971"><span class="fcn" id="F588N8:B1311">pivotArm</span>(<span class="mxinfo " id="T6:U972"><span class="var type1" id="S5T17U1313">sm</span>(<span class="var type1" id="S63T6U1314">src</span>,<span class="mxinfo " id="T8:U975">5</span>)</span>, <span class="mxinfo " id="T6:U976"><span class="mxinfo " id="T6:U977"><span class="var type1" id="S69T6U1318">fAng</span>-<span class="mxinfo " id="T6:U979"><span class="var type1" id="S5T17U1320">sm</span>(<span class="var type1" id="S63T6U1321">src</span>,<span class="mxinfo " id="T6:U982">3</span>)</span></span>+<span class="mxinfo " id="T6:U983"><span class="mxinfo " id="T6:U984">pi</span>/<span class="mxinfo " id="T6:U985">2</span></span></span>, <span class="mxinfo " id="T6:U986"><span class="var type1" id="S9T6U1328">A</span>/<span class="var type1" id="S10T6U1329">B</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,138" id="srcline138">138</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,139" id="srcline139">139</a></span><span class="line">    <span class="mxinfo " id="T19:U989"><span class="mxinfo " id="T19:U990"><span class="var type1" id="S72T14U1333">piv</span>(<span class="mxinfo " id="T13:U992">:</span>,<span class="mxinfo " id="T8:U993">3</span>)</span>=<span class="mxinfo " id="T19:U994"><span class="mxinfo " id="T19:U995"><span class="var type1" id="S72T14U1338">piv</span>(<span class="mxinfo " id="T13:U997">:</span>,<span class="mxinfo " id="T8:U998">3</span>)</span>.*<span class="var type1" id="S7T19U1341">fricCoeff</span></span></span>; <span class="comment">%scale force by friction coefficients</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,140" id="srcline140">140</a></span><span class="line">    <span class="comment">%chose which of the two moves - random, but weighted by the required force:</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,141" id="srcline141">141</a></span><span class="line">    <span class="mxinfo " id="T6:U1000"><span class="var type1" id="S76T6U1344">srcF</span>=<span class="mxinfo " id="T6:U1002">abs(<span class="mxinfo " id="T6:U1003"><span class="var type1" id="S72T14U1348">piv</span>(<span class="var type1" id="S63T6U1349">src</span>,<span class="mxinfo " id="T8:U1006">3</span>)</span>)</span></span>; <span class="mxinfo " id="T6:U1007"><span class="var type1" id="S78T6U1353">trgF</span>=<span class="mxinfo " id="T6:U1009">abs(<span class="mxinfo " id="T6:U1010"><span class="var type1" id="S72T14U1357">piv</span>(<span class="var type1" id="S64T6U1358">trg</span>,<span class="mxinfo " id="T8:U1013">3</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,142" id="srcline142">142</a></span><span class="line">    <span class="keyword">if</span>(<span class="mxinfo " id="T4:U1014">(<span class="mxinfo " id="T6:U1015">(<span class="mxinfo " id="T6:U1016"><span class="var type1" id="S76T6U1368">srcF</span>-<span class="var type1" id="S78T6U1369">trgF</span></span>)/(<span class="mxinfo " id="T6:U1019"><span class="var type1" id="S76T6U1372">srcF</span>+<span class="var type1" id="S78T6U1373">trgF</span></span>)</span>)&lt;<span class="mxinfo " id="T6:U1022"><span class="mxinfo " id="T6:U1023">0.5</span>*(<span class="mxinfo " id="T6:U1024"><span class="mxinfo " id="T6:U1025">rand</span>-<span class="mxinfo " id="T6:U1026">0.5</span></span>)</span></span>); <span class="mxinfo " id="T6:U1027"><span class="var type1" id="S31T6U1383">mv</span>=<span class="var type1" id="S63T6U1384">src</span></span>; <span class="comment">%move source smarticle</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,143" id="srcline143">143</a></span><span class="line">    <span class="keyword">else</span>; <span class="mxinfo " id="T6:U1030"><span class="var type1" id="S31T6U1388">mv</span>=<span class="var type1" id="S64T6U1389">trg</span></span>; <span class="comment">%else move target smarticle</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,144" id="srcline144">144</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,145" id="srcline145">145</a></span><span class="line">    <span class="mxinfo " id="T6:U1033"><span class="var type1" id="S79T6U1392">cth</span>=<span class="mxinfo " id="T6:U1035">cos(<span class="mxinfo " id="T6:U1036"><span class="mxinfo " id="T6:U1037"><span class="var type1" id="S5T17U1397">sm</span>(<span class="var type1" id="S31T6U1398">mv</span>,<span class="mxinfo " id="T8:U1040">3</span>)</span>-<span class="mxinfo " id="T6:U1041"><span class="mxinfo " id="T6:U1042">pi</span>/<span class="mxinfo " id="T6:U1043">2</span></span></span>)</span></span>; <span class="mxinfo " id="T6:U1044"><span class="var type1" id="S81T6U1406">sth</span>=<span class="mxinfo " id="T6:U1046">sin(<span class="mxinfo " id="T6:U1047"><span class="mxinfo " id="T6:U1048"><span class="var type1" id="S5T17U1411">sm</span>(<span class="var type1" id="S31T6U1412">mv</span>,<span class="mxinfo " id="T8:U1051">3</span>)</span>-<span class="mxinfo " id="T6:U1052"><span class="mxinfo " id="T6:U1053">pi</span>/<span class="mxinfo " id="T6:U1054">2</span></span></span>)</span></span>; <span class="mxinfo " id="T23:U1055"><span class="var type1" id="S83T23U1420">rotMx</span>=<span class="mxinfo " id="T23:U1057">[<span class="mxinfo " id="T12:U1058">[<span class="var type1" id="S79T6U1425">cth</span>,<span class="mxinfo " id="T6:U1060">-<span class="var type1" id="S81T6U1427">sth</span></span>]</span>;<span class="mxinfo " id="T12:U1062">[<span class="var type1" id="S81T6U1431">sth</span>,<span class="var type1" id="S79T6U1432">cth</span>]</span>]</span></span>; <span class="comment">%rotation matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,146" id="srcline146">146</a></span><span class="line">    <span class="mxinfo " id="T12:U1065"><span class="var type1" id="S84T12U1435">pivCOM</span>=<span class="mxinfo " id="T12:U1067">(<span class="mxinfo " id="T19:U1068"><span class="mxinfo " id="T19:U1069"><span class="var type1" id="S83T23U1440">rotMx</span>*<span class="mxinfo " id="T19:U1071"><span class="mxinfo " id="T12:U1072"><span class="var type1" id="S72T14U1443">piv</span>(<span class="var type1" id="S31T6U1444">mv</span>,<span class="mxinfo " id="T13:U1075">1:2</span>)</span>'</span></span>*<span class="var type1" id="S10T6U1448">B</span></span>)'</span></span>; <span class="comment">%pivot to smarticle COM in lab frame</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,147" id="srcline147">147</a></span><span class="line">    <span class="mxinfo " id="T12:U1077"><span class="var type1" id="S85T12U1451">pivot</span>=<span class="mxinfo " id="T12:U1079"><span class="mxinfo " id="T12:U1080"><span class="var type1" id="S5T17U1454">sm</span>(<span class="var type1" id="S31T6U1455">mv</span>,<span class="mxinfo " id="T12:U1083"><span class="mxinfo " id="T6:U1084">1</span>:<span class="mxinfo " id="T6:U1085">2</span></span>)</span>+<span class="var type1" id="S84T12U1459">pivCOM</span></span></span>; <span class="comment">%pivot point in absolute coord</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,148" id="srcline148">148</a></span><span class="line">    <span class="mxinfo " id="T12:U1087"><span class="var type1" id="S86T12U1462">pivRad</span>=<span class="mxinfo " id="T12:U1089"><span class="mxinfo " id="T12:U1090"><span class="var type1" id="S19T62U1465">crd</span>(<span class="var type1" id="S63T6U1466">src</span>,<span class="mxinfo " id="T12:U1093"><span class="mxinfo " id="T6:U1094">(<span class="mxinfo " id="T6:U1095"><span class="var type1" id="S67T6U1471">sLk</span>-<span class="var type1" id="S65T6U1472">beg</span></span>)*<span class="mxinfo " id="T6:U1098">2</span></span>+(<span class="mxinfo " id="T12:U1099">1:2</span>)</span>)</span>-<span class="var type1" id="S85T12U1478">pivot</span></span></span>; <span class="comment">%pivot to collision point</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,149" id="srcline149">149</a></span><span class="line">    [<span class="mxinfo " id="T6:U1101"><span class="var type1" id="S86T12U1483">pivRad</span>(<span class="mxinfo " id="T8:U1103">1</span>)</span>,<span class="mxinfo " id="T6:U1104"><span class="var type1" id="S86T12U1486">pivRad</span>(<span class="mxinfo " id="T8:U1106">2</span>)</span>]=cart2pol(<span class="mxinfo " id="T6:U1107"><span class="var type1" id="S86T12U1491">pivRad</span>(<span class="mxinfo " id="T8:U1109">1</span>)</span>,<span class="mxinfo " id="T6:U1110"><span class="var type1" id="S86T12U1494">pivRad</span>(<span class="mxinfo " id="T8:U1112">2</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="93,150" id="srcline150">150</a></span><span class="line">    <span class="mxinfo " id="T6:U1113"><span class="var type1" id="S88T6U1498">pivAngle</span>=<span class="mxinfo " id="T6:U1115">abs(<span class="mxinfo " id="T6:U1116"><span class="mxinfo " id="T6:U1117"><span class="mxinfo " id="T6:U1118"><span class="mxinfo " id="T6:U1119"><span class="var type1" id="S70T12U1505">vStickOut</span>(<span class="mxinfo " id="T8:U1121">2</span>)</span>/<span class="mxinfo " id="T6:U1122"><span class="var type1" id="S86T12U1508">pivRad</span>(<span class="mxinfo " id="T8:U1124">2</span>)</span></span>.*<span class="mxinfo " id="T6:U1125">cos(<span class="mxinfo " id="T6:U1126"><span class="var type1" id="S69T6U1513">fAng</span>-<span class="mxinfo " id="T6:U1128"><span class="var type1" id="S70T12U1515">vStickOut</span>(<span class="mxinfo " id="T6:U1130">1</span>)</span></span>)</span></span>./<span class="mxinfo " id="T6:U1131">sin(<span class="mxinfo " id="T6:U1132"><span class="var type1" id="S69T6U1520">fAng</span>-<span class="mxinfo " id="T6:U1134"><span class="var type1" id="S86T12U1522">pivRad</span>(<span class="mxinfo " id="T6:U1136">1</span>)</span></span>)</span></span>)</span></span>; <span class="comment">%angle to pivot in order to resolve collision</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,151" id="srcline151">151</a></span><span class="line">    <span class="mxinfo " id="T6:U1137"><span class="var type1" id="S88T6U1526">pivAngle</span>=<span class="mxinfo " id="T6:U1139">min(<span class="var type1" id="S88T6U1529">pivAngle</span>, <span class="var type1" id="S16T6U1530">maxAngle</span>)</span></span>; <span class="comment">%cap pivot angle</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,152" id="srcline152">152</a></span><span class="line"><span class="comment">%     pivAngle=max(pivAngle,tRes*3/pivRad(2)); %bound pivot angle from below</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,153" id="srcline153">153</a></span><span class="line">    <span class="mxinfo " id="T6:U1142"><span class="var type1" id="S88T6U1533">pivAngle</span>=<span class="mxinfo " id="T6:U1144"><span class="mxinfo " id="T6:U1145"><span class="mxinfo " id="T6:U1146">(<span class="mxinfo " id="T6:U1147"><span class="mxinfo " id="T6:U1148">1</span>-<span class="mxinfo " id="T6:U1149">2*(<span class="mxinfo " id="T4:U1150"><span class="var type1" id="S31T6U1544">mv</span>==<span class="var type1" id="S63T6U1545">src</span></span>)</span></span>)*<span class="var type1" id="S44T6U1546">fDir</span></span>*<span class="mxinfo " id="T6:U1154">sign(<span class="mxinfo " id="T6:U1155"><span class="var type1" id="S72T14U1550">piv</span>(<span class="var type1" id="S31T6U1551">mv</span>,<span class="mxinfo " id="T8:U1158">3</span>)</span>)</span></span>*(<span class="mxinfo " id="T6:U1159"><span class="var type1" id="S88T6U1555">pivAngle</span>+<span class="mxinfo " id="T6:U1161"><span class="mxinfo " id="T6:U1162"><span class="var type1" id="S15T6U1558">trEps</span>*(<span class="mxinfo " id="T6:U1164"><span class="mxinfo " id="T6:U1165">1</span>+<span class="mxinfo " id="T6:U1166">rand</span></span>)</span>/<span class="mxinfo " id="T6:U1167">max(<span class="mxinfo " id="T6:U1168"><span class="var type1" id="S86T12U1567">pivRad</span>(<span class="mxinfo " id="T8:U1170">2</span>)</span>,<span class="mxinfo " id="T6:U1171"><span class="mxinfo " id="T6:U1172">0.5</span>*<span class="var type1" id="S10T6U1571">B</span></span>)</span></span></span>)</span></span>; <span class="comment">%rotate a little further to make sure, and orient</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,154" id="srcline154">154</a></span><span class="line">    <span class="mxinfo " id="T12:U1174"><span class="var type1" id="S90T12U1574">sm12v</span>=<span class="mxinfo " id="T12:U1176"><span class="mxinfo " id="T12:U1177"><span class="var type1" id="S5T17U1577">sm</span>(<span class="var type1" id="S31T6U1578">mv</span>,<span class="mxinfo " id="T13:U1180">1:2</span>)</span>-<span class="mxinfo " id="T12:U1181"><span class="var type1" id="S5T17U1583">sm</span>(<span class="mxinfo " id="T6:U1183"><span class="mxinfo " id="T6:U1184">3</span>-<span class="var type1" id="S31T6U1586">mv</span></span>,<span class="mxinfo " id="T12:U1186"><span class="mxinfo " id="T6:U1187">1</span>:<span class="mxinfo " id="T6:U1188">2</span></span>)</span></span></span>; <span class="comment">%vector between smarticles</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,155" id="srcline155">155</a></span><span class="line">    <span class="comment">%rotate COM; add repulsive noise to prevent sticking together:</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,156" id="srcline156">156</a></span><span class="line">    <span class="mxinfo " id="T12:U1189"><span class="mxinfo " id="T12:U1190"><span class="var type1" id="S2T14U1593">xSm</span>(<span class="var type1" id="S31T6U1594">mv</span>,<span class="mxinfo " id="T12:U1193"><span class="mxinfo " id="T6:U1194">1</span>:<span class="mxinfo " id="T6:U1195">2</span></span>)</span>=<span class="mxinfo " id="T12:U1196"><span class="mxinfo " id="T12:U1197"><span class="mxinfo " id="T12:U1198"><span class="var type1" id="S2T14U1601">xSm</span>(<span class="var type1" id="S31T6U1602">mv</span>,<span class="mxinfo " id="T12:U1201"><span class="mxinfo " id="T6:U1202">1</span>:<span class="mxinfo " id="T6:U1203">2</span></span>)</span>+<span class="mxinfo " id="T12:U1204"><span class="mxinfo " id="T12:U1205"><span class="var type1" id="S88T6U1608">pivAngle</span>*<span class="mxinfo " id="T12:U1207">[1,-1]</span></span>.*<span class="mxinfo " id="T12:U1208">flip(<span class="var type1" id="S84T12U1616">pivCOM</span>)</span></span></span>+<span class="mxinfo " id="T12:U1210"><span class="mxinfo " id="T12:U1211"><span class="mxinfo " id="T12:U1212"><span class="mxinfo " id="T6:U1213"><span class="var type1" id="S15T6U1621">trEps</span>*<span class="mxinfo " id="T6:U1215">abs(<span class="var type1" id="S88T6U1624">pivAngle</span>)</span></span>*<span class="var type1" id="S90T12U1625">sm12v</span></span>/<span class="mxinfo " id="T6:U1218">norm(<span class="var type1" id="S90T12U1628">sm12v</span>)</span></span>*<span class="mxinfo " id="T6:U1220">rand</span></span></span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="93,157" id="srcline157">157</a></span><span class="line">    <span class="mxinfo " id="T6:U1221"><span class="mxinfo " id="T6:U1222"><span class="var type1" id="S2T14U1634">xSm</span>(<span class="var type1" id="S31T6U1635">mv</span>,<span class="mxinfo " id="T6:U1225">3</span>)</span>=<span class="mxinfo " id="T6:U1226"><span class="mxinfo " id="T6:U1227"><span class="var type1" id="S2T14U1639">xSm</span>(<span class="var type1" id="S31T6U1640">mv</span>,<span class="mxinfo " id="T6:U1230">3</span>)</span>+<span class="var type1" id="S88T6U1642">pivAngle</span></span></span>; <span class="comment">%rotate angle</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,158" id="srcline158">158</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="93,159" id="srcline159">159</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="93,160" id="srcline160">160</a></span><span class="line">        <span class="keyword">otherwise</span> <span class="comment">%if &gt;=2 intersections: pushing off - parallel transport</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,161" id="srcline161">161</a></span><span class="line">          <span class="mxinfo " id="T6:U1232"><span class="var type1" id="S31T6U1646">mv</span>=<span class="mxinfo " id="T6:U1234"><span class="mxinfo " id="T6:U1235">1</span>+(<span class="mxinfo " id="T4:U1236"><span class="mxinfo " id="T6:U1237">(<span class="mxinfo " id="T6:U1238"><span class="mxinfo " id="T6:U1239"><span class="var type1" id="S7T19U1655">fricCoeff</span>(<span class="mxinfo " id="T8:U1241">2</span>)</span>-<span class="mxinfo " id="T6:U1242"><span class="var type1" id="S7T19U1658">fricCoeff</span>(<span class="mxinfo " id="T6:U1244">1</span>)</span></span>)/(<span class="mxinfo " id="T6:U1245"><span class="mxinfo " id="T6:U1246"><span class="var type1" id="S7T19U1663">fricCoeff</span>(<span class="mxinfo " id="T8:U1248">2</span>)</span>+<span class="mxinfo " id="T6:U1249"><span class="var type1" id="S7T19U1666">fricCoeff</span>(<span class="mxinfo " id="T6:U1251">1</span>)</span></span>)</span>&lt;<span class="mxinfo " id="T6:U1252"><span class="mxinfo " id="T6:U1253">0.5</span>*(<span class="mxinfo " id="T6:U1254"><span class="mxinfo " id="T6:U1255">rand</span>-<span class="mxinfo " id="T6:U1256">0.5</span></span>)</span></span>)</span></span>; <span class="comment">%move the one with smaller fricCoeff</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,162" id="srcline162">162</a></span><span class="line">          <span class="mxinfo " id="T12:U1257"><span class="var type1" id="S92T12U1677">fNet</span>=<span class="mxinfo " id="T12:U1259">[<span class="mxinfo " id="T6:U1260">0</span>,<span class="mxinfo " id="T6:U1261">0</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,163" id="srcline163">163</a></span><span class="line">          <span class="keyword">for</span> <span class="var type1" id="S35T6U1684">i</span>=<span class="mxinfo " id="T6:U1263">1</span>:<span class="mxinfo " id="T6:U1264"><span class="var type1" id="S48T6U1688">ii</span>-<span class="mxinfo " id="T6:U1266">1</span></span> <span class="comment">%intList=[src,trg,sLk,tLk,beg,intDistTrg]</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,164" id="srcline164">164</a></span><span class="line">            [<span class="var type1" id="S69T6U1693">fAng</span>,<span class="var type1" id="S44T6U1694">fDir</span>,<span class="mxinfo " id="T12:U1269">~</span>]=<span class="fcn" id="F576N7:B1697">intForce</span>(<span class="var type1" id="S5T17U1698">sm</span>,<span class="var type1" id="S19T62U1699">crd</span>,<span class="mxinfo " id="T6:U1272"><span class="var type1" id="S49T125U1701">intList</span>(<span class="var type1" id="S35T6U1702">i</span>,<span class="mxinfo " id="T8:U1275">1</span>)</span>,<span class="mxinfo " id="T6:U1276"><span class="var type1" id="S49T125U1705">intList</span>(<span class="var type1" id="S35T6U1706">i</span>,<span class="mxinfo " id="T8:U1279">3</span>)</span>,<span class="mxinfo " id="T6:U1280"><span class="var type1" id="S49T125U1709">intList</span>(<span class="var type1" id="S35T6U1710">i</span>,<span class="mxinfo " id="T8:U1283">5</span>)</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,165" id="srcline165">165</a></span><span class="line">                <span class="mxinfo " id="T6:U1284"><span class="var type1" id="S49T125U1713">intList</span>(<span class="var type1" id="S35T6U1714">i</span>,<span class="mxinfo " id="T8:U1287">2</span>)</span>,<span class="mxinfo " id="T6:U1288"><span class="var type1" id="S49T125U1717">intList</span>(<span class="var type1" id="S35T6U1718">i</span>,<span class="mxinfo " id="T8:U1291">4</span>)</span>,<span class="mxinfo " id="T6:U1292"><span class="var type1" id="S49T125U1721">intList</span>(<span class="var type1" id="S35T6U1722">i</span>,<span class="mxinfo " id="T8:U1295">6</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="93,166" id="srcline166">166</a></span><span class="line">            <span class="mxinfo " id="T12:U1296"><span class="var type1" id="S92T12U1726">fNet</span>=<span class="mxinfo " id="T12:U1298"><span class="var type1" id="S92T12U1728">fNet</span> + <span class="mxinfo " id="T12:U1300"><span class="mxinfo " id="T12:U1301"><span class="mxinfo " id="T12:U1302">[<span class="mxinfo " id="T6:U1303">cos(<span class="var type1" id="S69T6U1735">fAng</span>)</span>,<span class="mxinfo " id="T6:U1305">sin(<span class="var type1" id="S69T6U1738">fAng</span>)</span>]</span>*(<span class="mxinfo " id="T6:U1307"><span class="mxinfo " id="T6:U1308">1</span>-<span class="mxinfo " id="T6:U1309">2*(<span class="mxinfo " id="T4:U1310"><span class="var type1" id="S31T6U1746">mv</span>==<span class="mxinfo " id="T6:U1312"><span class="var type1" id="S49T125U1748">intList</span>(<span class="var type1" id="S35T6U1749">i</span>,<span class="mxinfo " id="T6:U1315">1</span>)</span></span>)</span></span>)</span>*<span class="var type1" id="S44T6U1751">fDir</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,167" id="srcline167">167</a></span><span class="line">          <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,168" id="srcline168">168</a></span><span class="line">          <span class="mxinfo " id="T12:U1317"><span class="mxinfo " id="T12:U1318"><span class="var type1" id="S2T14U1755">xSm</span>(<span class="var type1" id="S31T6U1756">mv</span>,<span class="mxinfo " id="T12:U1321"><span class="mxinfo " id="T6:U1322">1</span>:<span class="mxinfo " id="T6:U1323">2</span></span>)</span>=<span class="mxinfo " id="T12:U1324"><span class="mxinfo " id="T12:U1325"><span class="var type1" id="S2T14U1762">xSm</span>(<span class="var type1" id="S31T6U1763">mv</span>,<span class="mxinfo " id="T12:U1328"><span class="mxinfo " id="T6:U1329">1</span>:<span class="mxinfo " id="T6:U1330">2</span></span>)</span>+<span class="mxinfo " id="T12:U1331"><span class="mxinfo " id="T12:U1332"><span class="var type1" id="S92T12U1769">fNet</span>/(<span class="mxinfo " id="T6:U1334"><span class="var type1" id="S48T6U1772">ii</span>-<span class="mxinfo " id="T6:U1336">1</span></span>)</span>*<span class="var type1" id="S18T6U1774">parShift</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="93,169" id="srcline169">169</a></span><span class="line">          <span class="mxinfo " id="T6:U1338"><span class="mxinfo " id="T6:U1339"><span class="var type1" id="S2T14U1778">xSm</span>(<span class="var type1" id="S31T6U1779">mv</span>,<span class="mxinfo " id="T6:U1342">3</span>)</span>=<span class="mxinfo " id="T6:U1343"><span class="mxinfo " id="T6:U1344"><span class="var type1" id="S2T14U1783">xSm</span>(<span class="var type1" id="S31T6U1784">mv</span>,<span class="mxinfo " id="T6:U1347">3</span>)</span>+<span class="mxinfo " id="T6:U1348">(<span class="mxinfo " id="T6:U1349"><span class="mxinfo " id="T6:U1350">rand</span>-<span class="mxinfo " id="T6:U1351">0.5</span></span>)*<span class="var type1" id="S11T6U1792">tRes</span></span></span></span>; <span class="comment">%add angle fluctuation</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,170" id="srcline170">170</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,171" id="srcline171">171</a></span><span class="line"><span class="comment">%     if(any(any(isnan(xSm))))</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,172" id="srcline172">172</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,173" id="srcline173">173</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="93,174" id="srcline174">174</a></span><span class="line"><span class="comment">%characterize single intersection: who is pushing who</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,175" id="srcline175">175</a></span><span class="line"><span class="comment">%in: intersection structure, intersecting links</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,176" id="srcline176">176</a></span><span class="line"><span class="comment">%out: source and target smls, intersection in beginning of source?,</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,177" id="srcline177">177</a></span><span class="line"><span class="comment">%distances on target link</span></span></span>
</pre>
<div class="dead">
<pre class="code">
<span class="srcline"><span class="lineno"><a href="93,178" id="srcline178">178</a></span><span class="line">function [src,trg,beg,intDistTrg]=findSrc(inters,ins1,ins2,lenVc)</span></span>
<span class="srcline"><span class="lineno"><a href="93,179" id="srcline179">179</a></span><span class="line">    if(ins1==2) <span class="comment">%middle link is always target</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,180" id="srcline180">180</a></span><span class="line">        if(ins2==2)<span class="comment">%; cla; plot(crd(:,1:2:end)',crd(:,2:2:end)','-','LineWidth',2); %axis([-0.5,0.5,-0.5,0.5]*12);</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,181" id="srcline181">181</a></span><span class="line">            'Warning: intersection in the middle of smarticles!'</span></span>
<span class="srcline"><span class="lineno"><a href="93,182" id="srcline182">182</a></span><span class="line">        end</span></span>
<span class="srcline"><span class="lineno"><a href="93,183" id="srcline183">183</a></span><span class="line">        src=2; trg=1; beg=ins2==1; intDistTrg=inters.intNormalizedDistance1To2(ins1,ins2);</span></span>
<span class="srcline"><span class="lineno"><a href="93,184" id="srcline184">184</a></span><span class="line"><span class="comment">%         end</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,185" id="srcline185">185</a></span><span class="line">    else</span></span>
<span class="srcline"><span class="lineno"><a href="93,186" id="srcline186">186</a></span><span class="line">        if(ins2==2); src=1; trg=2; beg=ins1==1; intDistTrg=inters.intNormalizedDistance2To1(ins1,ins2);</span></span>
<span class="srcline"><span class="lineno"><a href="93,187" id="srcline187">187</a></span><span class="line">        else <span class="comment">%if neither link ==2, then pick shorter end</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,188" id="srcline188">188</a></span><span class="line">      if(ins1==1); dst1=inters.intNormalizedDistance1To2(ins1,ins2)*lenVc(1);</span></span>
<span class="srcline"><span class="lineno"><a href="93,189" id="srcline189">189</a></span><span class="line">      else; dst1=(1-inters.intNormalizedDistance1To2(ins1,ins2))*lenVc(3);</span></span>
<span class="srcline"><span class="lineno"><a href="93,190" id="srcline190">190</a></span><span class="line">      end <span class="comment">%always take length from beg of 1 or end of 3</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,191" id="srcline191">191</a></span><span class="line">      if(ins2==1); dst2=inters.intNormalizedDistance2To1(ins1,ins2)*lenVc(1);</span></span>
<span class="srcline"><span class="lineno"><a href="93,192" id="srcline192">192</a></span><span class="line">      else; dst2=(1-inters.intNormalizedDistance2To1(ins1,ins2))*lenVc(3);</span></span>
<span class="srcline"><span class="lineno"><a href="93,193" id="srcline193">193</a></span><span class="line">      end</span></span>
<span class="srcline"><span class="lineno"><a href="93,194" id="srcline194">194</a></span><span class="line">      src=1+(dst1&gt;dst2); trg=3-src; </span></span>
<span class="srcline"><span class="lineno"><a href="93,195" id="srcline195">195</a></span><span class="line">      if(src==1); beg=ins1==1; intDistTrg=inters.intNormalizedDistance2To1(ins1,ins2);</span></span>
<span class="srcline"><span class="lineno"><a href="93,196" id="srcline196">196</a></span><span class="line">      else; beg=ins2==1; intDistTrg=inters.intNormalizedDistance1To2(ins1,ins2);</span></span>
<span class="srcline"><span class="lineno"><a href="93,197" id="srcline197">197</a></span><span class="line">      end</span></span>
<span class="srcline"><span class="lineno"><a href="93,198" id="srcline198">198</a></span><span class="line">        end</span></span>
<span class="srcline"><span class="lineno"><a href="93,199" id="srcline199">199</a></span><span class="line">    end</span></span>
<span class="srcline"><span class="lineno"><a href="93,200" id="srcline200">200</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="93,201" id="srcline201">201</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="93,202" id="srcline202">202</a></span><span class="line"><span class="comment">%get the interaction force</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,203" id="srcline203">203</a></span><span class="line"><span class="comment">%in: 4 vertex coordinates, ...<span class="comment"> , relative distance to X on tLk</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="93,204" id="srcline204">204</a></span><span class="line"><span class="comment">%out: force angle and direction (+/-)</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,205" id="srcline205">205</a></span><span class="line">function [fAng,fDir,vStickOut]=intForce(sm,crd,src,sLk,beg,trg,tLk,tXLen)</span></span>
<span class="srcline"><span class="lineno"><a href="93,206" id="srcline206">206</a></span><span class="line">    fAng=0;    </span></span>
<span class="srcline"><span class="lineno"><a href="93,207" id="srcline207">207</a></span><span class="line">    switch tLk <span class="comment">%find force angle</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,208" id="srcline208">208</a></span><span class="line">        case 1; fAng=sm(trg,3)-sm(trg,4); <span class="comment">%left arm pushed</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,209" id="srcline209">209</a></span><span class="line">        case 2; fAng=sm(trg,3); <span class="comment">%center pushed</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,210" id="srcline210">210</a></span><span class="line">        case 3; fAng=sm(trg,3)+sm(trg,5); <span class="comment">%right arm pushed</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,211" id="srcline211">211</a></span><span class="line">    end</span></span>
<span class="srcline"><span class="lineno"><a href="93,212" id="srcline212">212</a></span><span class="line">    <span class="comment">%get force orientation (+/-):</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,213" id="srcline213">213</a></span><span class="line">    intCrd=crd(trg,2*tLk+(-1:0)) + tXLen*(crd(trg,2*tLk+(1:2))-crd(trg,2*tLk+(-1:0))); <span class="comment">%coordinate of the intersection</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,214" id="srcline214">214</a></span><span class="line">    vStickOut=crd(src,(sLk-beg)*2+(1:2))-intCrd; <span class="comment">%sLk-beg=[0,4] vertex index - gives the piece sticking through inters</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,215" id="srcline215">215</a></span><span class="line">    [vStickOut(1),vStickOut(2)]=cart2pol(vStickOut(1),vStickOut(2)); <span class="comment">%polar coordinates</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,216" id="srcline216">216</a></span><span class="line">    so2fAng=abs(mod(vStickOut(1)-fAng+pi,2*pi)-pi);</span></span>
<span class="srcline"><span class="lineno"><a href="93,217" id="srcline217">217</a></span><span class="line">    fDir=sign(pi/2-so2fAng); <span class="comment">%get the direction of the force on trg</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,218" id="srcline218">218</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="93,219" id="srcline219">219</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="93,220" id="srcline220">220</a></span><span class="line"><span class="comment">%response when force applied to the right arm or corner</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,221" id="srcline221">221</a></span><span class="line"><span class="comment">%in: arm angle, force angle, arm length (in units of B)</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,222" id="srcline222">222</a></span><span class="line"><span class="comment">%out: [px,py,f] = pivot coordinates (in units of B) and critical force</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,223" id="srcline223">223</a></span><span class="line"><span class="comment">%required to move (in units of friction force; f&gt;0 =&gt; CCW rotation)</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,224" id="srcline224">224</a></span><span class="line">function [out]=pivotArm(al,th,A)</span></span>
<span class="srcline"><span class="lineno"><a href="93,225" id="srcline225">225</a></span><span class="line">    secth=sec(th); tanth=tan(th);</span></span>
<span class="srcline"><span class="lineno"><a href="93,226" id="srcline226">226</a></span><span class="line">    <span class="comment">%the constant out front quantifies how far off the pivot can be (larger=&gt;further away). "right" value: 0.081</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,227" id="srcline227">227</a></span><span class="line">    py=0.081./(-2*A*secth.*sin(al-th)+tanth); <span class="comment">%approximation for py</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,228" id="srcline228">228</a></span><span class="line">    pylnpy2=-0.6*atan(10*py); <span class="comment">%differentiable approximation for py*log(py^2) for py in (-0.5,0.5)</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,229" id="srcline229">229</a></span><span class="line">    px=tanth/2.*pylnpy2;</span></span>
<span class="srcline"><span class="lineno"><a href="93,230" id="srcline230">230</a></span><span class="line">    f=-secth.*pylnpy2;</span></span>
<span class="srcline"><span class="lineno"><a href="93,231" id="srcline231">231</a></span><span class="line">    out=[px,py,f];</span></span>
<span class="srcline"><span class="lineno"><a href="93,232" id="srcline232">232</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="93,233" id="srcline233">233</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="93,234" id="srcline234">234</a></span><span class="line"><span class="comment">%response when orthogonal force applied to the body</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,235" id="srcline235">235</a></span><span class="line"><span class="comment">%in: distance from center to push point (in units of B)</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,236" id="srcline236">236</a></span><span class="line"><span class="comment">%out: [px,py,f] = pivot coordinates (in units of B) and critical force required to move</span></span></span>
<span class="srcline"><span class="lineno"><a href="93,237" id="srcline237">237</a></span><span class="line">function [out]=pivotBody(x)</span></span>
<span class="srcline"><span class="lineno"><a href="93,238" id="srcline238">238</a></span><span class="line">    sq=sqrt(1+4*x.^2);</span></span>
<span class="srcline"><span class="lineno"><a href="93,239" id="srcline239">239</a></span><span class="line">    out=[(x-sign(x).*sq/2), 0, -2*x+sign(x).*sq];</span></span>
<span class="srcline"><span class="lineno"><a href="93,240" id="srcline240">240</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="93,241" id="srcline241">241</a></span><span class="line"> </span></span>
</pre>
</div>
</body>
</html>
