<html>
<body>
<script src="resources/eml_report_loadable_data.js"></script>
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1"> 1</a></span><span class="line"><span class="comment">%resolve all collisions sequentially and iteratively until clear, returning new sm position values</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2"> 2</a></span><span class="line"><span class="comment">%in: list of smcle 5-tuples, flag whether to resolve or just check collisions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3"> 3</a></span><span class="line"><span class="comment">%out: T/F if just checking, list of new 3-tuples (cx,cy,theta) if resolving</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4"> 4</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T1U3">xSm</span>,<span class="var type1" id="S3T2U4">parOrd</span>]=resolveCollisions(<span class="var type1" id="S4T3U7">sm</span>, <span class="var type1" id="S5T4U8">resolveFl</span>, <span class="var type1" id="S6T5U9">fricCoeff</span>, <span class="var type1" id="S3T2U10">parOrd</span>) <span class="comment">%#codegen</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5"> 5</a></span><span class="line">    <span class="keyword">global</span> <span class="var type0" id="S7T0U12">A</span> <span class="var type0" id="S8T0U13">B</span> <span class="var type0" id="S9T0U14">tRes</span>; <span class="mxinfo " id="T6:U7"><span class="var type1" id="S10T6U17">Nsm</span>=<span class="mxinfo " id="T6:U9">length(<span class="mxinfo " id="T5:U10"><span class="var type1" id="S4T3U21">sm</span>(<span class="mxinfo " id="T7:U12">:</span>,<span class="mxinfo " id="T8:U13">1</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6"> 6</a></span><span class="line">    <span class="mxinfo " id="T4:U14"><span class="var type1" id="S12T4U26">collFl</span>=<span class="mxinfo " id="T4:U16">true</span></span>; <span class="mxinfo " id="T6:U17"><span class="var type1" id="S14T6U31">whCnt</span>=<span class="mxinfo " id="T6:U19">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7"> 7</a></span><span class="line">    <span class="keyword">while</span>(<span class="var type1" id="S12T4U35">collFl</span>) <span class="comment">%sequentially resolve all collisions until none left</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8"> 8</a></span><span class="line">        <span class="mxinfo " id="T4:U21"><span class="var type1" id="S12T4U38">collFl</span>=<span class="mxinfo " id="T4:U23">false</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9"> 9</a></span><span class="line">      <span class="mxinfo " id="T9:U24"><span class="var type1" id="S16T9U43">iterOrd</span>=<span class="mxinfo " id="T9:U26">randperm(<span class="var type1" id="S10T6U46">Nsm</span>)</span></span>; <span class="comment">%randomize each pass to enhance stability</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10">10</a></span><span class="line">      <span class="keyword">for</span> <span class="var type1" id="S18T6U49">smi</span>=<span class="mxinfo " id="T6:U29">1</span>:<span class="var type1" id="S10T6U52">Nsm</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11">11</a></span><span class="line">        <span class="mxinfo " id="T6:U31"><span class="var type1" id="S18T6U55">smi</span>=<span class="mxinfo " id="T6:U33"><span class="var type1" id="S16T9U57">iterOrd</span>(<span class="var type1" id="S18T6U58">smi</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12">12</a></span><span class="line">        <span class="comment">%check for potential collisions based on distance to other smarticles:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13">13</a></span><span class="line">        <span class="mxinfo " id="T5:U36"><span class="var type1" id="S19T5U61">smC</span> = <span class="mxinfo " id="T5:U38">find(<span class="mxinfo " id="T10:U39"><span class="mxinfo " id="T5:U40">sum(<span class="mxinfo " id="T11:U41">(<span class="mxinfo " id="T11:U42"><span class="mxinfo " id="T11:U43">repmat(<span class="mxinfo " id="T12:U44"><span class="var type1" id="S4T3U73">sm</span>(<span class="var type1" id="S18T6U74">smi</span>,<span class="mxinfo " id="T13:U47">1:2</span>)</span>,<span class="var type1" id="S10T6U78">Nsm</span>,1)</span>-<span class="mxinfo " id="T11:U49"><span class="var type1" id="S4T3U81">sm</span>(<span class="mxinfo " id="T7:U51">:</span>,<span class="mxinfo " id="T12:U52"><span class="mxinfo " id="T6:U53">1</span>:<span class="mxinfo " id="T6:U54">2</span></span>)</span></span>).^2</span>,2)</span> &lt; <span class="mxinfo " id="T6:U55">(<span class="mxinfo " id="T6:U56"><span class="mxinfo " id="T6:U57"><span class="mxinfo " id="T6:U58">2</span>*<span class="var type1" id="S7T6U93">A</span></span>+<span class="var type1" id="S8T6U94">B</span></span>).^2</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14">14</a></span><span class="line">        <span class="keyword">for</span> <span class="var type1" id="S23T6U98">ci</span>=<span class="mxinfo " id="T6:U62">1</span>:<span class="mxinfo " id="T6:U63">length(<span class="var type1" id="S19T5U103">smC</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15">15</a></span><span class="line">            <span class="mxinfo " id="T6:U65"><span class="var type1" id="S24T6U106">smci</span>=<span class="mxinfo " id="T6:U67"><span class="var type1" id="S19T5U108">smC</span>(<span class="var type1" id="S23T6U109">ci</span>)</span></span>; <span class="comment">%index of the colliding smcle</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16">16</a></span><span class="line">            <span class="keyword">if</span>(<span class="mxinfo " id="T4:U70"><span class="var type1" id="S24T6U114">smci</span>==<span class="var type1" id="S18T6U115">smi</span></span>); <span class="keyword">continue</span>; <span class="keyword">end</span> <span class="comment">%no collision with itself</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17">17</a></span><span class="line"><span class="comment">%             if(resolveFl) %plot current pair being checked:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18">18</a></span><span class="line"><span class="comment">%                 crd=smcle2coord(sm([smi,smci],:));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19">19</a></span><span class="line"><span class="comment">%                 cla; plot(crd(:,1:2:end)',crd(:,2:2:end)','-o','LineWidth',2); axis([-0.5,0.5,-0.5,0.5]*12);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20">20</a></span><span class="line"><span class="comment">% %                 pause();</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21">21</a></span><span class="line"><span class="comment">%             end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22">22</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23">23</a></span><span class="line">            [<span class="var type1" id="S25T14U120">res</span>,<span class="mxinfo " id="T15:U74"><span class="var type1" id="S3T2U122">parOrd</span>(<span class="mxinfo " id="T16:U76">:</span>,<span class="var type1" id="S18T6U124">smi</span>,<span class="var type1" id="S24T6U125">smci</span>)</span>,<span class="var type1" id="S26T15U126">flipPar</span>]=<span class="fcn" id="F625N5:B128">pairCollision</span>(<span class="mxinfo " id="T17:U80"><span class="var type1" id="S4T3U130">sm</span>(<span class="mxinfo " id="T12:U82">[<span class="var type1" id="S18T6U133">smi</span>,<span class="var type1" id="S24T6U134">smci</span>]</span>,<span class="mxinfo " id="T18:U85">:</span>)</span>,<span class="var type1" id="S5T4U136">resolveFl</span>,<span class="mxinfo " id="T19:U87"><span class="var type1" id="S6T5U138">fricCoeff</span>(<span class="mxinfo " id="T12:U89">[<span class="var type1" id="S18T6U141">smi</span>,<span class="var type1" id="S24T6U142">smci</span>]</span>)</span>,<span class="mxinfo " id="T15:U92"><span class="var type1" id="S3T2U144">parOrd</span>(<span class="mxinfo " id="T16:U94">:</span>,<span class="var type1" id="S18T6U146">smi</span>,<span class="var type1" id="S24T6U147">smci</span>)</span>); <span class="comment">%resolve pair collision</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24">24</a></span><span class="line">            <span class="keyword">if</span>(<span class="mxinfo " id="T4:U97">any(<span class="var type1" id="S26T15U153">flipPar</span>)</span>); <span class="mxinfo " id="T15:U99"><span class="mxinfo " id="T15:U100"><span class="var type1" id="S3T2U157">parOrd</span>(<span class="mxinfo " id="T16:U102">:</span>,<span class="var type1" id="S24T6U159">smci</span>,<span class="var type1" id="S18T6U160">smi</span>)</span>=<span class="mxinfo " id="T15:U105"><span class="var type1" id="S26T15U162">flipPar</span>.*<span class="mxinfo " id="T15:U107"><span class="var type1" id="S3T2U164">parOrd</span>(<span class="mxinfo " id="T16:U109">:</span>,<span class="var type1" id="S18T6U166">smi</span>,<span class="var type1" id="S24T6U167">smci</span>)</span></span></span>; <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25">25</a></span><span class="line">            <span class="mxinfo " id="T4:U112"><span class="keyword">if</span> <span class="mxinfo " id="T20:U113">all(<span class="mxinfo " id="T21:U114">~<span class="var type1" id="S25T14U173">res</span></span>)</span>; <span class="keyword">continue</span>; <span class="keyword">end</span></span> <span class="comment">%if no collision, continue</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26">26</a></span><span class="line">            <span class="keyword">if</span> <span class="mxinfo " id="T4:U116"><span class="var type1" id="S14T6U178">whCnt</span>&gt;<span class="mxinfo " id="T6:U118"><span class="mxinfo " id="T6:U119">100</span>*<span class="var type1" id="S10T6U181">Nsm</span></span></span>; <span class="keyword">continue</span>; <span class="keyword">end</span> <span class="comment">%if can't resolve, just move on</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27">27</a></span><span class="line">            <span class="mxinfo " id="T4:U121"><span class="var type1" id="S12T4U185">collFl</span>=<span class="mxinfo " id="T4:U123">true</span></span>; <span class="comment">%else set collision flag</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28">28</a></span><span class="line">            <span class="mxinfo " id="T14:U124"><span class="mxinfo " id="T14:U125"><span class="var type1" id="S4T3U191">sm</span>(<span class="mxinfo " id="T12:U127">[<span class="var type1" id="S18T6U194">smi</span>,<span class="var type1" id="S24T6U195">smci</span>]</span>,<span class="mxinfo " id="T22:U130">1:3</span>)</span>=<span class="var type1" id="S25T14U199">res</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29">29</a></span><span class="line">            <span class="mxinfo " id="T12:U132"><span class="var type1" id="S30T12U202">sm12v</span>=<span class="mxinfo " id="T12:U134"><span class="mxinfo " id="T12:U135"><span class="var type1" id="S4T3U205">sm</span>(<span class="var type1" id="S18T6U206">smi</span>,<span class="mxinfo " id="T13:U138">1:2</span>)</span>-<span class="mxinfo " id="T12:U139"><span class="var type1" id="S4T3U211">sm</span>(<span class="var type1" id="S24T6U212">smci</span>,<span class="mxinfo " id="T12:U142"><span class="mxinfo " id="T6:U143">1</span>:<span class="mxinfo " id="T6:U144">2</span></span>)</span></span></span>; <span class="mxinfo " id="T6:U145"><span class="var type1" id="S31T6U218">n12v</span>=<span class="mxinfo " id="T6:U147">norm(<span class="var type1" id="S30T12U221">sm12v</span>)</span></span>; <span class="comment">%vector between smarticles</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30">30</a></span><span class="line">            <span class="keyword">if</span>(<span class="mxinfo " id="T4:U149"><span class="var type1" id="S31T6U227">n12v</span>&lt;<span class="mxinfo " id="T6:U151"><span class="mxinfo " id="T6:U152">0.2</span>*<span class="var type1" id="S8T6U230">B</span></span></span> || (<span class="mxinfo " id="T4:U154"><span class="var type1" id="S14T6U234">whCnt</span>&gt;<span class="mxinfo " id="T6:U156"><span class="mxinfo " id="T6:U157">10</span>*<span class="var type1" id="S10T6U237">Nsm</span></span></span> &amp;&amp; <span class="mxinfo " id="T4:U159"><span class="mxinfo " id="T6:U160">mod(<span class="var type1" id="S14T6U241">whCnt</span>,3)</span>&lt;<span class="mxinfo " id="T6:U162">1</span></span>)) <span class="comment">%can't resolve collisions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31">31</a></span><span class="line">                <span class="mxinfo " id="T23:U163"><span class="mxinfo " id="T23:U164"><span class="var type1" id="S4T3U247">sm</span>(<span class="mxinfo " id="T12:U166">[<span class="var type1" id="S18T6U250">smi</span>,<span class="var type1" id="S24T6U251">smci</span>]</span>,<span class="mxinfo " id="T12:U169"><span class="mxinfo " id="T6:U170">1</span>:<span class="mxinfo " id="T6:U171">2</span></span>)</span>=<span class="mxinfo " id="T23:U172"><span class="mxinfo " id="T23:U173"><span class="var type1" id="S4T3U257">sm</span>(<span class="mxinfo " id="T12:U175">[<span class="var type1" id="S18T6U260">smi</span>,<span class="var type1" id="S24T6U261">smci</span>]</span>,<span class="mxinfo " id="T12:U178"><span class="mxinfo " id="T6:U179">1</span>:<span class="mxinfo " id="T6:U180">2</span></span>)</span>+<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32">32</a></span><span class="line">                    <span class="mxinfo " id="T23:U181"><span class="mxinfo " id="T23:U182"><span class="mxinfo " id="T23:U183"><span class="mxinfo " id="T23:U184"><span class="mxinfo " id="T23:U185"><span class="mxinfo " id="T23:U186">[<span class="var type1" id="S30T12U272">sm12v</span>;<span class="mxinfo " id="T12:U188">-<span class="var type1" id="S30T12U275">sm12v</span></span>]</span>/<span class="var type1" id="S31T6U276">n12v</span></span>*<span class="mxinfo " id="T6:U191">rand</span></span>*<span class="mxinfo " id="T6:U192">0.03</span></span>*<span class="var type1" id="S8T6U280">B</span></span>./<span class="mxinfo " id="T23:U194">[<span class="mxinfo " id="T19:U195"><span class="var type1" id="S6T5U284">fricCoeff</span>(<span class="mxinfo " id="T12:U197">[<span class="var type1" id="S18T6U287">smi</span>,<span class="var type1" id="S24T6U288">smci</span>]</span>)</span>,<span class="mxinfo " id="T19:U200"><span class="var type1" id="S6T5U290">fricCoeff</span>(<span class="mxinfo " id="T12:U202">[<span class="var type1" id="S18T6U293">smi</span>,<span class="var type1" id="S24T6U294">smci</span>]</span>)</span>]</span></span></span></span>; <span class="comment">%rotate COM; add repulsive noise to prevent sticking together</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33">33</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34">34</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35">35</a></span><span class="line">      <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36">36</a></span><span class="line">      <span class="keyword">if</span>(<span class="mxinfo " id="T4:U205">~<span class="var type1" id="S5T4U299">resolveFl</span></span>); <span class="mxinfo " id="T1:U207"><span class="var type1" id="S2T1U302">xSm</span>=<span class="mxinfo " id="T1:U209"><span class="var type1" id="S12T4U304">collFl</span>*<span class="mxinfo " id="T1:U211">ones(<span class="var type1" id="S10T6U307">Nsm</span>,<span class="mxinfo " id="T6:U213">3</span>)</span></span></span>; <span class="keyword">return</span>; <span class="keyword">end</span> <span class="comment">%if just checking collisions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37">37</a></span><span class="line"><span class="comment">%       collFl=false;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38">38</a></span><span class="line">      <span class="mxinfo " id="T6:U214"><span class="var type1" id="S14T6U312">whCnt</span>=<span class="mxinfo " id="T6:U216"><span class="var type1" id="S14T6U314">whCnt</span>+<span class="mxinfo " id="T6:U218">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39">39</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40">40</a></span><span class="line"><span class="comment">%     whCnt</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41">41</a></span><span class="line">    <span class="mxinfo " id="T1:U219"><span class="var type1" id="S2T1U318">xSm</span>=<span class="mxinfo " id="T1:U221"><span class="var type1" id="S4T3U320">sm</span>(<span class="mxinfo " id="T7:U223">:</span>,<span class="mxinfo " id="T24:U224"><span class="mxinfo " id="T6:U225">1</span>:<span class="mxinfo " id="T6:U226">3</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42">42</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
</body>
</html>
