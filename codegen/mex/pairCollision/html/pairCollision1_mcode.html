<html>
<body>
<script src="resources/eml_report_loadable_data.js"></script>
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="comment">%resolve a pair-collision, returning new sm position values</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line"><span class="comment">%in: the two smcle 5-tuples, flag whether to resolve or just check collisions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line"><span class="comment">%out: T/F if just checking, list of new 3-tuples (cx,cy,theta) if resolving</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T1U3">xSm</span>]=pairCollision(<span class="var type1" id="S3T2U6">sm</span>, <span class="var type1" id="S4T3U7">resolveFl</span>, <span class="var type1" id="S5T4U8">fricCoeff</span>, <span class="var type1" id="S6T5U9">nextAl</span>) <span class="comment">%#codegen</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line">    <span class="keyword">global</span> <span class="var type0" id="S7T0U11">A</span> <span class="var type0" id="S8T0U12">B</span> <span class="var type0" id="S9T0U13">tRes</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line">    <span class="comment">% check for collisions:----------</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line">    <span class="mxinfo " id="T6:U6"><span class="var type1" id="S10T6U16">crd</span>=<span class="mxinfo " id="T6:U8"><span class="fcn" id="F2N7:B18">smcle2coord</span>(<span class="var type1" id="S3T2U19">sm</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line">    <span class="mxinfo " id="T7:U10"><span class="var type1" id="S12T7U22">inters</span> = <span class="mxinfo " id="T7:U12"><span class="fcn" id="F33N3:B24">lineSegmentIntersect</span>(<span class="mxinfo " id="T10:U13">[<span class="mxinfo " id="T11:U14"><span class="var type1" id="S10T6U28">crd</span>(<span class="mxinfo " id="T12:U16">1</span>,<span class="mxinfo " id="T13:U17">1:4</span>)</span>; <span class="mxinfo " id="T11:U18"><span class="var type1" id="S10T6U35">crd</span>(<span class="mxinfo " id="T12:U20">1</span>,<span class="mxinfo " id="T13:U21">3:6</span>)</span>; <span class="mxinfo " id="T11:U22"><span class="var type1" id="S10T6U42">crd</span>(<span class="mxinfo " id="T12:U24">1</span>,<span class="mxinfo " id="T13:U25">5:8</span>)</span>]</span>,<span class="mxinfo " id="T10:U26">[<span class="mxinfo " id="T11:U27"><span class="var type1" id="S10T6U50">crd</span>(<span class="mxinfo " id="T12:U29">2</span>,<span class="mxinfo " id="T13:U30">1:4</span>)</span>; <span class="mxinfo " id="T11:U31"><span class="var type1" id="S10T6U57">crd</span>(<span class="mxinfo " id="T12:U33">2</span>,<span class="mxinfo " id="T13:U34">3:6</span>)</span>; <span class="mxinfo " id="T11:U35"><span class="var type1" id="S10T6U64">crd</span>(<span class="mxinfo " id="T12:U37">2</span>,<span class="mxinfo " id="T13:U38">5:8</span>)</span>]</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line">    <span class="mxinfo " id="T3:U39"><span class="keyword">if</span> <span class="mxinfo " id="T14:U40">all(<span class="mxinfo " id="T8:U41">~<span class="mxinfo " id="T8:U42"><span class="var type1" id="S12T7U75">inters</span>.intAdjacencyMatrix</span></span>)</span>; <span class="mxinfo " id="T1:U44"><span class="var type1" id="S2T1U79">xSm</span>=<span class="mxinfo " id="T1:U46">zeros(<span class="mxinfo " id="T15:U47">2</span>,<span class="mxinfo " id="T15:U48">3</span>)</span></span>; <span class="keyword">return</span>; <span class="keyword">end</span></span> <span class="comment">%if no collision, return false</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line">    <span class="keyword">if</span>(<span class="mxinfo " id="T3:U49">~<span class="var type1" id="S4T3U89">resolveFl</span></span>); <span class="mxinfo " id="T1:U51"><span class="var type1" id="S2T1U92">xSm</span>=<span class="mxinfo " id="T1:U53">ones(<span class="mxinfo " id="T15:U54">2</span>,<span class="mxinfo " id="T15:U55">3</span>)</span></span>; <span class="keyword">return</span>; <span class="keyword">end</span> <span class="comment">%if just checking for collisions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line"><span class="comment">%     cla; plot(crd(:,1:2:end)',crd(:,2:2:end)','-o','LineWidth',2); axis([-0.5,0.5,-0.5,0.5]*12);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line"><span class="comment">%     scatter(inters.intMatrixX(:),inters.intMatrixY(:),1000,'r.'); %mark collision points</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line">    <span class="comment">% find out who is pushing who:-------</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line">    <span class="mxinfo " id="T9:U56"><span class="var type1" id="S17T9U100">lenMx</span>=<span class="mxinfo " id="T9:U58">repmat(<span class="mxinfo " id="T16:U59">[<span class="var type1" id="S7T15U105">A</span>;<span class="var type1" id="S8T15U107">B</span>;<span class="var type1" id="S7T15U109">A</span>]</span>,1,3)</span></span>; <span class="mxinfo " id="T9:U63"><span class="var type1" id="S19T9U114">lenMx2</span>=<span class="mxinfo " id="T9:U65"><span class="var type1" id="S17T9U116">lenMx</span>'</span></span>; <span class="comment">%scales to get real-space distances</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line">    <span class="mxinfo " id="T17:U67"><span class="var type1" id="S20T17U119">inX</span>=<span class="mxinfo " id="T17:U69">find(<span class="mxinfo " id="T8:U70"><span class="var type1" id="S12T7U123">inters</span>.intAdjacencyMatrix</span>)</span></span>; <span class="mxinfo " id="T15:U72"><span class="var type1" id="S20T15U127">inX</span>=<span class="mxinfo " id="T15:U74"><span class="var type1" id="S20T17U129">inX</span>(<span class="mxinfo " id="T15:U76">1</span>)</span></span>; <span class="comment">%get intersection index</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line">    <span class="mxinfo " id="T15:U77"><span class="var type1" id="S22T15U133">dBeg12</span>=<span class="mxinfo " id="T15:U79"><span class="mxinfo " id="T9:U80"><span class="var type1" id="S12T7U136">inters</span>.intNormalizedDistance1To2</span>(<span class="var type1" id="S20T15U138">inX</span>)</span></span>; <span class="mxinfo " id="T15:U83"><span class="var type1" id="S23T15U141">dEnd12</span>=<span class="mxinfo " id="T15:U85">(<span class="mxinfo " id="T15:U86"><span class="mxinfo " id="T15:U87">1</span>-<span class="var type1" id="S22T15U146">dBeg12</span></span>).*<span class="mxinfo " id="T15:U89"><span class="var type1" id="S17T9U148">lenMx</span>(<span class="var type1" id="S20T15U149">inX</span>)</span></span></span>; <span class="mxinfo " id="T15:U92"><span class="var type1" id="S22T15U152">dBeg12</span>=<span class="mxinfo " id="T15:U94"><span class="var type1" id="S22T15U154">dBeg12</span>.*<span class="mxinfo " id="T15:U96"><span class="var type1" id="S17T9U156">lenMx</span>(<span class="var type1" id="S20T15U157">inX</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line">    <span class="mxinfo " id="T15:U99"><span class="var type1" id="S24T15U160">dBeg21</span>=<span class="mxinfo " id="T15:U101"><span class="mxinfo " id="T9:U102"><span class="var type1" id="S12T7U163">inters</span>.intNormalizedDistance2To1</span>(<span class="var type1" id="S20T15U165">inX</span>)</span></span>; <span class="mxinfo " id="T15:U105"><span class="var type1" id="S25T15U168">dEnd21</span>=<span class="mxinfo " id="T15:U107">(<span class="mxinfo " id="T15:U108"><span class="mxinfo " id="T15:U109">1</span>-<span class="var type1" id="S24T15U173">dBeg21</span></span>).*<span class="mxinfo " id="T15:U111"><span class="var type1" id="S19T9U175">lenMx2</span>(<span class="var type1" id="S20T15U176">inX</span>)</span></span></span>; <span class="mxinfo " id="T15:U114"><span class="var type1" id="S24T15U179">dBeg21</span>=<span class="mxinfo " id="T15:U116"><span class="var type1" id="S24T15U181">dBeg21</span>.*<span class="mxinfo " id="T15:U118"><span class="var type1" id="S19T9U183">lenMx2</span>(<span class="var type1" id="S20T15U184">inX</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line">    <span class="mxinfo " id="T11:U121"><span class="var type1" id="S26T11U187">intDistVc</span>=<span class="mxinfo " id="T11:U123">[<span class="var type1" id="S22T15U190">dBeg12</span>, <span class="var type1" id="S23T15U191">dEnd12</span>, <span class="var type1" id="S24T15U192">dBeg21</span>, <span class="var type1" id="S25T15U193">dEnd21</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line">    <span class="comment">%decide by min sticking-out length:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line">    [<span class="var type1" id="S27T15U197">minDist</span>,<span class="var type1" id="S28T15U198">mIx</span>]=min(<span class="var type1" id="S26T11U201">intDistVc</span>); <span class="comment">%find shortest distance to intersec</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line"><span class="comment">%     if(minDist&gt;B/3) %error - need higher resolution (ambiguous pusing/pushed)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line"><span class="comment">%         "warning: collision orientation ambiguous"</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"><span class="comment">%     end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line">    <span class="keyword">if</span>(<span class="mxinfo " id="T3:U131"><span class="var type1" id="S28T15U206">mIx</span>&lt;=<span class="mxinfo " id="T15:U133">2</span></span>); <span class="mxinfo " id="T15:U134"><span class="var type1" id="S30T15U210">src</span>=<span class="mxinfo " id="T15:U136">1</span></span>; <span class="mxinfo " id="T15:U137"><span class="var type1" id="S31T15U214">trg</span>=<span class="mxinfo " id="T15:U139">2</span></span>; <span class="mxinfo " id="T15:U140"><span class="var type1" id="S32T15U218">sLk</span>=<span class="mxinfo " id="T15:U142"><span class="mxinfo " id="T15:U143">mod(<span class="mxinfo " id="T15:U144"><span class="var type1" id="S20T15U223">inX</span>-<span class="mxinfo " id="T15:U146">1</span></span>,3)</span>+<span class="mxinfo " id="T15:U147">1</span></span></span>; <span class="mxinfo " id="T15:U148"><span class="var type1" id="S34T15U229">tLk</span>=<span class="mxinfo " id="T15:U150">ceil(<span class="mxinfo " id="T15:U151"><span class="var type1" id="S20T15U233">inX</span>/<span class="mxinfo " id="T15:U153">3</span></span>)</span></span>; <span class="comment">%src - pushing, trg - pushed</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line">    <span class="keyword">else</span>; <span class="mxinfo " id="T15:U154"><span class="var type1" id="S30T15U238">src</span>=<span class="mxinfo " id="T15:U156">2</span></span>; <span class="mxinfo " id="T15:U157"><span class="var type1" id="S31T15U242">trg</span>=<span class="mxinfo " id="T15:U159">1</span></span>; <span class="mxinfo " id="T15:U160"><span class="var type1" id="S34T15U246">tLk</span>=<span class="mxinfo " id="T15:U162"><span class="mxinfo " id="T15:U163">mod(<span class="mxinfo " id="T15:U164"><span class="var type1" id="S20T15U251">inX</span>-<span class="mxinfo " id="T15:U166">1</span></span>,3)</span>+<span class="mxinfo " id="T15:U167">1</span></span></span>; <span class="mxinfo " id="T15:U168"><span class="var type1" id="S32T15U257">sLk</span>=<span class="mxinfo " id="T15:U170">ceil(<span class="mxinfo " id="T15:U171"><span class="var type1" id="S20T15U261">inX</span>/<span class="mxinfo " id="T15:U173">3</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line">    <span class="mxinfo " id="T3:U174"><span class="var type1" id="S36T3U265">beg</span>=<span class="mxinfo " id="T3:U176">logical(<span class="mxinfo " id="T15:U177">mod(<span class="var type1" id="S28T15U270">mIx</span>,2)</span>)</span></span>; <span class="comment">%src is at beginning of the sLk link? </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line">    <span class="keyword">if</span>(<span class="mxinfo " id="T3:U179"><span class="var type1" id="S32T15U278">sLk</span>==<span class="mxinfo " id="T15:U181">2</span></span> || (<span class="mxinfo " id="T3:U182"><span class="var type1" id="S32T15U283">sLk</span>==<span class="mxinfo " id="T15:U184">3</span></span> &amp;&amp; <span class="var type1" id="S36T3U285">beg</span>) || (<span class="mxinfo " id="T3:U186"><span class="var type1" id="S32T15U289">sLk</span>==<span class="mxinfo " id="T15:U188">1</span></span> &amp;&amp; <span class="mxinfo " id="T3:U189">~<span class="var type1" id="S36T3U292">beg</span></span>)) <span class="comment">%ensure that corner - check other intersection</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line">        <span class="keyword">if</span>(<span class="mxinfo " id="T3:U191">~(<span class="mxinfo " id="T3:U192"><span class="mxinfo " id="T3:U193"><span class="var type1" id="S30T15U301">src</span>==<span class="mxinfo " id="T15:U195">1</span></span> &amp;&amp; <span class="mxinfo " id="T3:U196"><span class="mxinfo " id="T15:U197">sum(<span class="mxinfo " id="T18:U198"><span class="mxinfo " id="T8:U199"><span class="var type1" id="S12T7U308">inters</span>.intAdjacencyMatrix</span>(<span class="mxinfo " id="T19:U201">:</span>,<span class="var type1" id="S34T15U311">tLk</span>)</span>)</span>==<span class="mxinfo " id="T15:U203">2</span></span></span>)</span> <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line">                &amp;&amp; <span class="mxinfo " id="T3:U204">~(<span class="mxinfo " id="T3:U205"><span class="mxinfo " id="T3:U206"><span class="var type1" id="S30T15U317">src</span>==<span class="mxinfo " id="T15:U208">2</span></span> &amp;&amp; <span class="mxinfo " id="T3:U209"><span class="mxinfo " id="T15:U210">sum(<span class="mxinfo " id="T14:U211"><span class="mxinfo " id="T8:U212"><span class="var type1" id="S12T7U324">inters</span>.intAdjacencyMatrix</span>(<span class="var type1" id="S34T15U326">tLk</span>,<span class="mxinfo " id="T19:U215">:</span>)</span>)</span>==<span class="mxinfo " id="T15:U216">2</span></span></span>)</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line">            <span class="mxinfo " id="T15:U217"><span class="var type1" id="S28T15U331">mIx</span>=<span class="mxinfo " id="T15:U219">(<span class="mxinfo " id="T3:U220"><span class="var type1" id="S28T15U335">mIx</span>&lt;=<span class="mxinfo " id="T15:U222">2</span></span>)*2</span></span>; [<span class="mxinfo " id="T15:U223">~</span>,<span class="var type1" id="S39T15U342">tmp</span>]=min(<span class="mxinfo " id="T4:U225"><span class="var type1" id="S26T11U346">intDistVc</span>(<span class="mxinfo " id="T4:U227"><span class="var type1" id="S28T15U348">mIx</span>+(<span class="mxinfo " id="T4:U229">1:2</span>)</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line">            <span class="mxinfo " id="T15:U230"><span class="var type1" id="S28T15U355">mIx</span>=<span class="mxinfo " id="T15:U232"><span class="var type1" id="S28T15U357">mIx</span>+<span class="var type1" id="S39T15U358">tmp</span></span></span>; <span class="mxinfo " id="T3:U235"><span class="var type1" id="S36T3U361">beg</span>=<span class="mxinfo " id="T3:U237">logical(<span class="mxinfo " id="T15:U238">mod(<span class="var type1" id="S28T15U366">mIx</span>,2)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line">            <span class="mxinfo " id="T15:U240"><span class="var type1" id="S39T15U370">tmp</span>=<span class="var type1" id="S30T15U371">src</span></span>; <span class="mxinfo " id="T15:U243"><span class="var type1" id="S30T15U374">src</span>=<span class="var type1" id="S31T15U375">trg</span></span>; <span class="mxinfo " id="T15:U246"><span class="var type1" id="S31T15U378">trg</span>=<span class="var type1" id="S39T15U379">tmp</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line">            <span class="mxinfo " id="T15:U249"><span class="var type1" id="S39T15U382">tmp</span>=<span class="var type1" id="S32T15U383">sLk</span></span>; <span class="mxinfo " id="T15:U252"><span class="var type1" id="S32T15U386">sLk</span>=<span class="var type1" id="S34T15U387">tLk</span></span>; <span class="mxinfo " id="T15:U255"><span class="var type1" id="S34T15U390">tLk</span>=<span class="var type1" id="S39T15U391">tmp</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line">        <span class="keyword">end</span> <span class="comment">%else make the other link source</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line">    <span class="comment">% Do move calculation:----------</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line">    <span class="mxinfo " id="T15:U258"><span class="var type1" id="S40T15U394">trEps</span>=<span class="mxinfo " id="T15:U260"><span class="mxinfo " id="T15:U261"><span class="mxinfo " id="T15:U262">0.5</span>*<span class="var type1" id="S9T15U398">tRes</span></span>*<span class="var type1" id="S8T15U399">B</span></span></span>; <span class="mxinfo " id="T15:U265"><span class="var type1" id="S41T15U402">maxAngle</span>=<span class="mxinfo " id="T15:U267">0.2</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line">    <span class="comment">%get force angle from what we are pushing on (normal to the surface):</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line">    <span class="comment">%and calculate the response on the pushed smarticle:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line">    <span class="mxinfo " id="T1:U268"><span class="var type1" id="S42T1U406">piv</span>=<span class="mxinfo " id="T1:U270">zeros(<span class="mxinfo " id="T15:U271">2</span>,<span class="mxinfo " id="T15:U272">3</span>)</span></span>; <span class="mxinfo " id="T15:U273"><span class="var type1" id="S43T15U413">fAng</span>=<span class="mxinfo " id="T15:U275">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line">    <span class="keyword">if</span>(<span class="mxinfo " id="T3:U276"><span class="var type1" id="S34T15U419">tLk</span>==<span class="mxinfo " id="T15:U278">3</span></span>); <span class="mxinfo " id="T15:U279"><span class="var type1" id="S43T15U423">fAng</span>=<span class="mxinfo " id="T15:U281"><span class="mxinfo " id="T15:U282"><span class="var type1" id="S3T2U426">sm</span>(<span class="var type1" id="S31T15U427">trg</span>,<span class="mxinfo " id="T15:U285">3</span>)</span>+<span class="mxinfo " id="T15:U286"><span class="var type1" id="S3T2U430">sm</span>(<span class="var type1" id="S31T15U431">trg</span>,<span class="mxinfo " id="T15:U289">5</span>)</span></span></span>; <span class="comment">%right arm pushed</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line">        <span class="mxinfo " id="T20:U290"><span class="mxinfo " id="T20:U291"><span class="var type1" id="S42T1U436">piv</span>(<span class="var type1" id="S31T15U437">trg</span>,<span class="mxinfo " id="T19:U294">:</span>)</span>=<span class="mxinfo " id="T20:U295"><span class="fcn" id="F243N5:B440">pivotArm</span>(<span class="mxinfo " id="T15:U296"><span class="var type1" id="S3T2U442">sm</span>(<span class="var type1" id="S31T15U443">trg</span>,<span class="mxinfo " id="T12:U299">5</span>)</span>, <span class="mxinfo " id="T15:U300"><span class="mxinfo " id="T15:U301"><span class="var type1" id="S3T2U447">sm</span>(<span class="var type1" id="S31T15U448">trg</span>,<span class="mxinfo " id="T12:U304">5</span>)</span>+<span class="mxinfo " id="T15:U305"><span class="mxinfo " id="T15:U306">pi</span>/<span class="mxinfo " id="T15:U307">2</span></span></span>, <span class="mxinfo " id="T15:U308"><span class="mxinfo " id="T15:U309"><span class="var type1" id="S26T11U456">intDistVc</span>(<span class="mxinfo " id="T15:U311"><span class="mxinfo " id="T15:U312"><span class="mxinfo " id="T15:U313">2</span>*<span class="var type1" id="S31T15U460">trg</span></span>-<span class="mxinfo " id="T15:U315">1</span></span>)</span>/<span class="var type1" id="S8T15U462">B</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line">    <span class="keyword">elseif</span>(<span class="mxinfo " id="T3:U317"><span class="var type1" id="S34T15U466">tLk</span>==<span class="mxinfo " id="T15:U319">2</span></span>); <span class="mxinfo " id="T15:U320"><span class="var type1" id="S43T15U470">fAng</span>=<span class="mxinfo " id="T15:U322"><span class="var type1" id="S3T2U472">sm</span>(<span class="var type1" id="S31T15U473">trg</span>,<span class="mxinfo " id="T15:U325">3</span>)</span></span>; <span class="comment">%body pushed</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line">        <span class="mxinfo " id="T20:U326"><span class="mxinfo " id="T20:U327"><span class="var type1" id="S42T1U478">piv</span>(<span class="var type1" id="S31T15U479">trg</span>,<span class="mxinfo " id="T19:U330">:</span>)</span>=<span class="mxinfo " id="T20:U331"><span class="fcn" id="F255N6:B482">pivotBody</span>(<span class="mxinfo " id="T15:U332"><span class="mxinfo " id="T15:U333"><span class="mxinfo " id="T15:U334"><span class="var type1" id="S26T11U486">intDistVc</span>(<span class="mxinfo " id="T15:U336"><span class="mxinfo " id="T15:U337"><span class="mxinfo " id="T15:U338">2</span>*<span class="var type1" id="S31T15U490">trg</span></span>-<span class="mxinfo " id="T15:U340">1</span></span>)</span>/<span class="var type1" id="S8T15U492">B</span></span> - <span class="mxinfo " id="T15:U342">0.5</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line">    <span class="keyword">elseif</span>(<span class="mxinfo " id="T3:U343"><span class="var type1" id="S34T15U497">tLk</span>==<span class="mxinfo " id="T15:U345">1</span></span>); <span class="mxinfo " id="T15:U346"><span class="var type1" id="S43T15U501">fAng</span>=<span class="mxinfo " id="T15:U348"><span class="mxinfo " id="T15:U349"><span class="var type1" id="S3T2U504">sm</span>(<span class="var type1" id="S31T15U505">trg</span>,<span class="mxinfo " id="T15:U352">3</span>)</span>-<span class="mxinfo " id="T15:U353"><span class="var type1" id="S3T2U508">sm</span>(<span class="var type1" id="S31T15U509">trg</span>,<span class="mxinfo " id="T15:U356">4</span>)</span></span></span>; <span class="comment">%left arm pushed</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line">        <span class="mxinfo " id="T20:U357"><span class="mxinfo " id="T20:U358"><span class="var type1" id="S42T1U514">piv</span>(<span class="var type1" id="S31T15U515">trg</span>,<span class="mxinfo " id="T19:U361">:</span>)</span>=<span class="mxinfo " id="T20:U362"><span class="fcn" id="F243N5:B518">pivotArm</span>(<span class="mxinfo " id="T15:U363"><span class="var type1" id="S3T2U520">sm</span>(<span class="var type1" id="S31T15U521">trg</span>,<span class="mxinfo " id="T12:U366">4</span>)</span>, <span class="mxinfo " id="T15:U367"><span class="mxinfo " id="T15:U368"><span class="var type1" id="S3T2U525">sm</span>(<span class="var type1" id="S31T15U526">trg</span>,<span class="mxinfo " id="T12:U371">4</span>)</span>+<span class="mxinfo " id="T15:U372"><span class="mxinfo " id="T15:U373">pi</span>/<span class="mxinfo " id="T15:U374">2</span></span></span>, <span class="mxinfo " id="T15:U375"><span class="mxinfo " id="T15:U376"><span class="var type1" id="S26T11U534">intDistVc</span>(<span class="mxinfo " id="T15:U378"><span class="mxinfo " id="T15:U379">2</span>*<span class="var type1" id="S31T15U537">trg</span></span>)</span>/<span class="var type1" id="S8T15U538">B</span></span>)</span></span>; <span class="mxinfo " id="T4:U382"><span class="mxinfo " id="T4:U383"><span class="var type1" id="S42T1U542">piv</span>(<span class="var type1" id="S31T15U543">trg</span>,<span class="mxinfo " id="T4:U386">[<span class="mxinfo " id="T15:U387">1</span>,<span class="mxinfo " id="T15:U388">3</span>]</span>)</span>=<span class="mxinfo " id="T4:U389">-<span class="mxinfo " id="T4:U390"><span class="var type1" id="S42T1U550">piv</span>(<span class="var type1" id="S31T15U551">trg</span>,<span class="mxinfo " id="T4:U393">[<span class="mxinfo " id="T15:U394">1</span>,<span class="mxinfo " id="T15:U395">3</span>]</span>)</span></span></span>; <span class="comment">%flip x-axis</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line">    <span class="comment">%get force orientation:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line">    <span class="mxinfo " id="T4:U396"><span class="var type1" id="S47T4U558">vStickOut</span>=<span class="mxinfo " id="T4:U398"><span class="mxinfo " id="T4:U399"><span class="var type1" id="S10T6U561">crd</span>(<span class="var type1" id="S30T15U562">src</span>,<span class="mxinfo " id="T4:U402"><span class="mxinfo " id="T15:U403">(<span class="mxinfo " id="T15:U404"><span class="var type1" id="S32T15U567">sLk</span>-<span class="var type1" id="S36T3U568">beg</span></span>)*<span class="mxinfo " id="T15:U407">2</span></span>+(<span class="mxinfo " id="T4:U408">1:2</span>)</span>)</span>-<span class="mxinfo " id="T4:U409">[<span class="mxinfo " id="T15:U410"><span class="mxinfo " id="T9:U411"><span class="var type1" id="S12T7U578">inters</span>.intMatrixX</span>(<span class="var type1" id="S20T15U580">inX</span>)</span>,<span class="mxinfo " id="T15:U414"><span class="mxinfo " id="T9:U415"><span class="var type1" id="S12T7U583">inters</span>.intMatrixY</span>(<span class="var type1" id="S20T15U585">inX</span>)</span>]</span></span></span>; <span class="comment">%sLk-beg=[0,4] vertex index - gives the piece sticking through inters</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line">    [<span class="mxinfo " id="T15:U418"><span class="var type1" id="S47T4U590">vStickOut</span>(<span class="mxinfo " id="T12:U420">1</span>)</span>,<span class="mxinfo " id="T15:U421"><span class="var type1" id="S47T4U593">vStickOut</span>(<span class="mxinfo " id="T12:U423">2</span>)</span>]=cart2pol(<span class="mxinfo " id="T15:U424"><span class="var type1" id="S47T4U598">vStickOut</span>(<span class="mxinfo " id="T12:U426">1</span>)</span>,<span class="mxinfo " id="T15:U427"><span class="var type1" id="S47T4U601">vStickOut</span>(<span class="mxinfo " id="T12:U429">2</span>)</span>); <span class="comment">%polar coordinates</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line">    <span class="mxinfo " id="T15:U430"><span class="var type1" id="S49T15U605">so2fAng</span>=<span class="mxinfo " id="T15:U432">abs(<span class="mxinfo " id="T15:U433"><span class="mxinfo " id="T15:U434">mod(<span class="mxinfo " id="T15:U435"><span class="mxinfo " id="T15:U436"><span class="mxinfo " id="T15:U437"><span class="var type1" id="S47T4U614">vStickOut</span>(<span class="mxinfo " id="T12:U439">1</span>)</span>-<span class="var type1" id="S43T15U616">fAng</span></span>+<span class="mxinfo " id="T15:U441">pi</span></span>,2*pi)</span>-<span class="mxinfo " id="T15:U442">pi</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line">    <span class="mxinfo " id="T15:U443"><span class="var type1" id="S51T15U627">fDir</span>=<span class="mxinfo " id="T15:U445">sign(<span class="mxinfo " id="T15:U446"><span class="mxinfo " id="T15:U447"><span class="mxinfo " id="T15:U448">pi</span>/<span class="mxinfo " id="T15:U449">2</span></span>-<span class="var type1" id="S49T15U635">so2fAng</span></span>)</span></span>; <span class="comment">%get the direction of the force on trg</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line">    <span class="mxinfo " id="T1:U451"><span class="var type1" id="S2T1U638">xSm</span>=<span class="mxinfo " id="T1:U453"><span class="var type1" id="S3T2U640">sm</span>(<span class="mxinfo " id="T21:U455">:</span>,<span class="mxinfo " id="T20:U456"><span class="mxinfo " id="T15:U457">1</span>:<span class="mxinfo " id="T15:U458">3</span></span>)</span></span>; <span class="comment">%setup the identity map</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line">    <span class="comment">%calculate the response on the pushing smarticle:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line">    <span class="keyword">if</span>(<span class="mxinfo " id="T3:U459">~<span class="var type1" id="S36T3U650">beg</span></span> &amp;&amp; <span class="mxinfo " id="T3:U461"><span class="var type1" id="S32T15U652">sLk</span>==<span class="mxinfo " id="T15:U463">3</span></span>) <span class="comment">%if pushing with the right arm tip</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line">        <span class="mxinfo " id="T20:U464"><span class="mxinfo " id="T20:U465"><span class="var type1" id="S42T1U657">piv</span>(<span class="var type1" id="S30T15U658">src</span>,<span class="mxinfo " id="T19:U468">:</span>)</span>=<span class="mxinfo " id="T20:U469"><span class="fcn" id="F243N5:B661">pivotArm</span>(<span class="mxinfo " id="T15:U470"><span class="var type1" id="S3T2U663">sm</span>(<span class="var type1" id="S30T15U664">src</span>,<span class="mxinfo " id="T12:U473">5</span>)</span>, <span class="mxinfo " id="T15:U474"><span class="mxinfo " id="T15:U475"><span class="var type1" id="S43T15U668">fAng</span>-<span class="mxinfo " id="T15:U477"><span class="var type1" id="S3T2U670">sm</span>(<span class="var type1" id="S30T15U671">src</span>,<span class="mxinfo " id="T15:U480">3</span>)</span></span>+<span class="mxinfo " id="T15:U481"><span class="mxinfo " id="T15:U482">pi</span>/<span class="mxinfo " id="T15:U483">2</span></span></span>, <span class="mxinfo " id="T15:U484"><span class="var type1" id="S7T15U678">A</span>/<span class="var type1" id="S8T15U679">B</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line">    <span class="keyword">elseif</span>((<span class="var type1" id="S36T3U685">beg</span> &amp;&amp; <span class="mxinfo " id="T3:U488"><span class="var type1" id="S32T15U687">sLk</span>==<span class="mxinfo " id="T15:U490">3</span></span>) || (<span class="mxinfo " id="T3:U491">~<span class="var type1" id="S36T3U692">beg</span></span> &amp;&amp; <span class="mxinfo " id="T3:U493"><span class="var type1" id="S32T15U694">sLk</span>==<span class="mxinfo " id="T15:U495">2</span></span>)) <span class="comment">%if pushing with right corner</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line">        <span class="mxinfo " id="T20:U496"><span class="mxinfo " id="T20:U497"><span class="var type1" id="S42T1U699">piv</span>(<span class="var type1" id="S30T15U700">src</span>,<span class="mxinfo " id="T19:U500">:</span>)</span>=<span class="mxinfo " id="T20:U501"><span class="fcn" id="F243N5:B703">pivotArm</span>(<span class="mxinfo " id="T15:U502">0</span>, <span class="mxinfo " id="T15:U503"><span class="mxinfo " id="T15:U504"><span class="var type1" id="S43T15U707">fAng</span>-<span class="mxinfo " id="T15:U506"><span class="var type1" id="S3T2U709">sm</span>(<span class="var type1" id="S30T15U710">src</span>,<span class="mxinfo " id="T15:U509">3</span>)</span></span>+<span class="mxinfo " id="T15:U510"><span class="mxinfo " id="T15:U511">pi</span>/<span class="mxinfo " id="T15:U512">2</span></span></span>, <span class="mxinfo " id="T15:U513">0</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line">    <span class="keyword">elseif</span>((<span class="var type1" id="S36T3U722">beg</span> &amp;&amp; <span class="mxinfo " id="T3:U515"><span class="var type1" id="S32T15U724">sLk</span>==<span class="mxinfo " id="T15:U517">2</span></span>) || (<span class="mxinfo " id="T3:U518">~<span class="var type1" id="S36T3U729">beg</span></span> &amp;&amp; <span class="mxinfo " id="T3:U520"><span class="var type1" id="S32T15U731">sLk</span>==<span class="mxinfo " id="T15:U522">1</span></span>)) <span class="comment">%pusing with left corner</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line">        <span class="mxinfo " id="T20:U523"><span class="mxinfo " id="T20:U524"><span class="var type1" id="S42T1U736">piv</span>(<span class="var type1" id="S30T15U737">src</span>,<span class="mxinfo " id="T19:U527">:</span>)</span>=<span class="mxinfo " id="T20:U528"><span class="fcn" id="F243N5:B740">pivotArm</span>(<span class="mxinfo " id="T15:U529">0</span>, <span class="mxinfo " id="T15:U530"><span class="mxinfo " id="T15:U531"><span class="mxinfo " id="T15:U532">-<span class="var type1" id="S43T15U745">fAng</span></span>+<span class="mxinfo " id="T15:U534"><span class="var type1" id="S3T2U747">sm</span>(<span class="var type1" id="S30T15U748">src</span>,<span class="mxinfo " id="T15:U537">3</span>)</span></span>+<span class="mxinfo " id="T15:U538"><span class="mxinfo " id="T15:U539">pi</span>/<span class="mxinfo " id="T15:U540">2</span></span></span>, <span class="mxinfo " id="T15:U541">0</span>)</span></span>; <span class="mxinfo " id="T4:U542"><span class="mxinfo " id="T4:U543"><span class="var type1" id="S42T1U758">piv</span>(<span class="var type1" id="S30T15U759">src</span>,<span class="mxinfo " id="T4:U546">[<span class="mxinfo " id="T15:U547">1</span>,<span class="mxinfo " id="T15:U548">3</span>]</span>)</span>=<span class="mxinfo " id="T4:U549">-<span class="mxinfo " id="T4:U550"><span class="var type1" id="S42T1U766">piv</span>(<span class="var type1" id="S30T15U767">src</span>,<span class="mxinfo " id="T4:U553">[<span class="mxinfo " id="T15:U554">1</span>,<span class="mxinfo " id="T15:U555">3</span>]</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line">    <span class="keyword">elseif</span>(<span class="var type1" id="S36T3U775">beg</span> &amp;&amp; <span class="mxinfo " id="T3:U557"><span class="var type1" id="S32T15U777">sLk</span>==<span class="mxinfo " id="T15:U559">1</span></span>) <span class="comment">%pushing with left arm tip</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line">        <span class="mxinfo " id="T20:U560"><span class="mxinfo " id="T20:U561"><span class="var type1" id="S42T1U782">piv</span>(<span class="var type1" id="S30T15U783">src</span>,<span class="mxinfo " id="T19:U564">:</span>)</span>=<span class="mxinfo " id="T20:U565"><span class="fcn" id="F243N5:B786">pivotArm</span>(<span class="mxinfo " id="T15:U566"><span class="var type1" id="S3T2U788">sm</span>(<span class="var type1" id="S30T15U789">src</span>,<span class="mxinfo " id="T12:U569">4</span>)</span>, <span class="mxinfo " id="T15:U570"><span class="mxinfo " id="T15:U571"><span class="mxinfo " id="T15:U572">-<span class="var type1" id="S43T15U794">fAng</span></span>+<span class="mxinfo " id="T15:U574"><span class="var type1" id="S3T2U796">sm</span>(<span class="var type1" id="S30T15U797">src</span>,<span class="mxinfo " id="T15:U577">3</span>)</span></span>+<span class="mxinfo " id="T15:U578"><span class="mxinfo " id="T15:U579">pi</span>/<span class="mxinfo " id="T15:U580">2</span></span></span>, <span class="mxinfo " id="T15:U581"><span class="var type1" id="S7T15U804">A</span>/<span class="var type1" id="S8T15U805">B</span></span>)</span></span>; <span class="mxinfo " id="T4:U584"><span class="mxinfo " id="T4:U585"><span class="var type1" id="S42T1U809">piv</span>(<span class="var type1" id="S30T15U810">src</span>,<span class="mxinfo " id="T4:U588">[<span class="mxinfo " id="T15:U589">1</span>,<span class="mxinfo " id="T15:U590">3</span>]</span>)</span>=<span class="mxinfo " id="T4:U591">-<span class="mxinfo " id="T4:U592"><span class="var type1" id="S42T1U817">piv</span>(<span class="var type1" id="S30T15U818">src</span>,<span class="mxinfo " id="T4:U595">[<span class="mxinfo " id="T15:U596">1</span>,<span class="mxinfo " id="T15:U597">3</span>]</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line">    <span class="var type0" id="S42T0U826">piv</span>(:,3)=<span class="message error" id="M1F1C"><span class="mxinfo " id="T22:U598"><span class="var type1" id="S42T1U831">piv</span>(<span class="mxinfo " id="T21:U600">:</span>,<span class="mxinfo " id="T15:U601">3</span>)</span>.*<span class="var type1" id="S5T4U834">fricCoeff</span></span>; <span class="comment">%scale force by friction coefficients</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line">    <span class="comment">%chose which of the two moves - random, but weighted by the required force:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line">    <span class="mxinfo " id="T15:U603"><span class="var type1" id="S53T15U837">srcF</span>=<span class="mxinfo " id="T15:U605">abs(<span class="mxinfo " id="T15:U606"><span class="var type1" id="S42T1U841">piv</span>(<span class="var type1" id="S30T15U842">src</span>,<span class="mxinfo " id="T12:U609">3</span>)</span>)</span></span>; <span class="mxinfo " id="T15:U610"><span class="var type1" id="S54T15U846">trgF</span>=<span class="mxinfo " id="T15:U612">abs(<span class="mxinfo " id="T15:U613"><span class="var type1" id="S42T1U850">piv</span>(<span class="var type1" id="S31T15U851">trg</span>,<span class="mxinfo " id="T12:U616">3</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line">    <span class="keyword">if</span>(<span class="mxinfo " id="T3:U617">(<span class="mxinfo " id="T15:U618">(<span class="mxinfo " id="T15:U619"><span class="var type1" id="S53T15U861">srcF</span>-<span class="var type1" id="S54T15U862">trgF</span></span>)/(<span class="mxinfo " id="T15:U622"><span class="var type1" id="S53T15U865">srcF</span>+<span class="var type1" id="S54T15U866">trgF</span></span>)</span>)&lt;<span class="mxinfo " id="T15:U625"><span class="mxinfo " id="T15:U626">0.5</span>*(<span class="mxinfo " id="T15:U627"><span class="mxinfo " id="T15:U628">rand</span>-<span class="mxinfo " id="T15:U629">0.5</span></span>)</span></span>); <span class="mxinfo " id="T15:U630"><span class="var type1" id="S56T15U876">mv</span>=<span class="var type1" id="S30T15U877">src</span></span>; <span class="comment">%move source smarticle</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line">    <span class="keyword">else</span>; <span class="mxinfo " id="T15:U633"><span class="var type1" id="S56T15U881">mv</span>=<span class="var type1" id="S31T15U882">trg</span></span>; <span class="comment">%else move target smarticle</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line">    <span class="mxinfo " id="T15:U636"><span class="var type1" id="S57T15U885">pAold</span>=<span class="mxinfo " id="T15:U638">0</span></span>; <span class="mxinfo " id="T4:U639"><span class="var type1" id="S58T4U889">pCOMold</span>=<span class="mxinfo " id="T4:U641">[<span class="mxinfo " id="T15:U642">0</span>,<span class="mxinfo " id="T15:U643">0</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S59T15U896">i</span>=<span class="mxinfo " id="T22:U645"><span class="mxinfo " id="T15:U646">1</span>:<span class="mxinfo " id="T15:U647">2</span></span> <span class="comment">%if one is hard to rotate (too far), rotate the other</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line">    <span class="mxinfo " id="T15:U648"><span class="var type1" id="S60T15U902">cth</span>=<span class="mxinfo " id="T15:U650">cos(<span class="mxinfo " id="T15:U651"><span class="mxinfo " id="T15:U652"><span class="var type1" id="S3T2U907">sm</span>(<span class="var type1" id="S56T15U908">mv</span>,<span class="mxinfo " id="T12:U655">3</span>)</span>-<span class="mxinfo " id="T15:U656"><span class="mxinfo " id="T15:U657">pi</span>/<span class="mxinfo " id="T15:U658">2</span></span></span>)</span></span>; <span class="mxinfo " id="T15:U659"><span class="var type1" id="S62T15U916">sth</span>=<span class="mxinfo " id="T15:U661">sin(<span class="mxinfo " id="T15:U662"><span class="mxinfo " id="T15:U663"><span class="var type1" id="S3T2U921">sm</span>(<span class="var type1" id="S56T15U922">mv</span>,<span class="mxinfo " id="T12:U666">3</span>)</span>-<span class="mxinfo " id="T15:U667"><span class="mxinfo " id="T15:U668">pi</span>/<span class="mxinfo " id="T15:U669">2</span></span></span>)</span></span>; <span class="mxinfo " id="T5:U670"><span class="var type1" id="S64T5U930">rotMx</span>=<span class="mxinfo " id="T5:U672">[<span class="mxinfo " id="T4:U673">[<span class="var type1" id="S60T15U935">cth</span>,<span class="mxinfo " id="T15:U675">-<span class="var type1" id="S62T15U937">sth</span></span>]</span>;<span class="mxinfo " id="T4:U677">[<span class="var type1" id="S62T15U941">sth</span>,<span class="var type1" id="S60T15U942">cth</span>]</span>]</span></span>; <span class="comment">%rotation matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line">    <span class="mxinfo " id="T4:U680"><span class="var type1" id="S65T4U945">pivCOM</span>=<span class="mxinfo " id="T4:U682">(<span class="mxinfo " id="T22:U683"><span class="mxinfo " id="T22:U684"><span class="var type1" id="S64T5U950">rotMx</span>*<span class="mxinfo " id="T22:U686"><span class="mxinfo " id="T4:U687"><span class="var type1" id="S42T1U953">piv</span>(<span class="var type1" id="S56T15U954">mv</span>,<span class="mxinfo " id="T21:U690">1:2</span>)</span>'</span></span>*<span class="var type1" id="S8T15U958">B</span></span>)'</span></span>; <span class="comment">%pivot to smarticle COM in lab frame</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line">    <span class="mxinfo " id="T4:U692"><span class="var type1" id="S66T4U961">pivot</span>=<span class="mxinfo " id="T4:U694"><span class="mxinfo " id="T4:U695"><span class="var type1" id="S3T2U964">sm</span>(<span class="var type1" id="S56T15U965">mv</span>,<span class="mxinfo " id="T4:U698"><span class="mxinfo " id="T15:U699">1</span>:<span class="mxinfo " id="T15:U700">2</span></span>)</span>+<span class="var type1" id="S65T4U969">pivCOM</span></span></span>; <span class="comment">%pivot point in absolute coord</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line">    <span class="mxinfo " id="T4:U702"><span class="var type1" id="S67T4U972">pivRad</span>=<span class="mxinfo " id="T4:U704"><span class="mxinfo " id="T4:U705"><span class="var type1" id="S10T6U975">crd</span>(<span class="var type1" id="S30T15U976">src</span>,<span class="mxinfo " id="T4:U708"><span class="mxinfo " id="T15:U709">(<span class="mxinfo " id="T15:U710"><span class="var type1" id="S32T15U981">sLk</span>-<span class="var type1" id="S36T3U982">beg</span></span>)*<span class="mxinfo " id="T15:U713">2</span></span>+(<span class="mxinfo " id="T4:U714">1:2</span>)</span>)</span>-<span class="var type1" id="S66T4U988">pivot</span></span></span>; <span class="comment">%pivot to collision point</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line">    [<span class="mxinfo " id="T15:U716"><span class="var type1" id="S67T4U993">pivRad</span>(<span class="mxinfo " id="T12:U718">1</span>)</span>,<span class="mxinfo " id="T15:U719"><span class="var type1" id="S67T4U996">pivRad</span>(<span class="mxinfo " id="T12:U721">2</span>)</span>]=cart2pol(<span class="mxinfo " id="T15:U722"><span class="var type1" id="S67T4U1001">pivRad</span>(<span class="mxinfo " id="T12:U724">1</span>)</span>,<span class="mxinfo " id="T15:U725"><span class="var type1" id="S67T4U1004">pivRad</span>(<span class="mxinfo " id="T12:U727">2</span>)</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line">    <span class="mxinfo " id="T15:U728"><span class="var type1" id="S68T15U1008">pivAngle</span>=<span class="mxinfo " id="T15:U730">abs(<span class="mxinfo " id="T15:U731"><span class="mxinfo " id="T15:U732"><span class="mxinfo " id="T15:U733"><span class="mxinfo " id="T15:U734"><span class="var type1" id="S47T4U1015">vStickOut</span>(<span class="mxinfo " id="T12:U736">2</span>)</span>/<span class="mxinfo " id="T15:U737"><span class="var type1" id="S67T4U1018">pivRad</span>(<span class="mxinfo " id="T12:U739">2</span>)</span></span>.*<span class="mxinfo " id="T15:U740">cos(<span class="mxinfo " id="T15:U741"><span class="var type1" id="S43T15U1023">fAng</span>-<span class="mxinfo " id="T15:U743"><span class="var type1" id="S47T4U1025">vStickOut</span>(<span class="mxinfo " id="T15:U745">1</span>)</span></span>)</span></span>./<span class="mxinfo " id="T15:U746">sin(<span class="mxinfo " id="T15:U747"><span class="var type1" id="S43T15U1030">fAng</span>-<span class="mxinfo " id="T15:U749"><span class="var type1" id="S67T4U1032">pivRad</span>(<span class="mxinfo " id="T15:U751">1</span>)</span></span>)</span></span>)</span></span>; <span class="comment">%angle to pivot in order to resolve collision</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line">    <span class="keyword">if</span>(<span class="mxinfo " id="T3:U752"><span class="mxinfo " id="T15:U753">abs(<span class="var type1" id="S68T15U1040">pivAngle</span>)</span>&lt;<span class="var type1" id="S41T15U1041">maxAngle</span></span>); <span class="keyword">break</span>; <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line">    <span class="keyword">if</span>(<span class="mxinfo " id="T3:U756"><span class="var type1" id="S59T15U1047">i</span>==<span class="mxinfo " id="T15:U758">1</span></span>); <span class="mxinfo " id="T15:U759"><span class="var type1" id="S56T15U1051">mv</span>=<span class="mxinfo " id="T15:U761"><span class="mxinfo " id="T15:U762">3</span>-<span class="var type1" id="S56T15U1054">mv</span></span></span>; <span class="mxinfo " id="T15:U764"><span class="var type1" id="S57T15U1057">pAold</span>=<span class="var type1" id="S68T15U1058">pivAngle</span></span>; <span class="mxinfo " id="T4:U767"><span class="var type1" id="S58T4U1061">pCOMold</span>=<span class="var type1" id="S65T4U1062">pivCOM</span></span>; <span class="comment">%if pivAngle is too large, try rotating the other one</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line">    <span class="keyword">elseif</span>(<span class="mxinfo " id="T3:U770"><span class="mxinfo " id="T15:U771">abs(<span class="var type1" id="S57T15U1068">pAold</span>)</span>&lt;<span class="mxinfo " id="T15:U773">abs(<span class="var type1" id="S68T15U1071">pivAngle</span>)</span></span>); <span class="mxinfo " id="T15:U775"><span class="var type1" id="S68T15U1074">pivAngle</span>=<span class="var type1" id="S57T15U1075">pAold</span></span>; <span class="mxinfo " id="T15:U778"><span class="var type1" id="S56T15U1078">mv</span>=<span class="mxinfo " id="T15:U780"><span class="mxinfo " id="T15:U781">3</span>-<span class="var type1" id="S56T15U1081">mv</span></span></span>; <span class="mxinfo " id="T4:U783"><span class="var type1" id="S65T4U1084">pivCOM</span>=<span class="var type1" id="S58T4U1085">pCOMold</span></span>; <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line">    <span class="keyword">if</span>(<span class="mxinfo " id="T3:U786"><span class="mxinfo " id="T15:U787">abs(<span class="var type1" id="S68T15U1092">pivAngle</span>)</span>&lt;<span class="var type1" id="S41T15U1093">maxAngle</span></span>) <span class="comment">%only pivot if small angle - else <span class="keyword">...</span><span class="comment"> parallel?</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line">         <span class="comment">%xSm=NaN; return; %give error if rotating too far - need better resolution, or something is wrong</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line"><span class="comment">%     pivAngle=max(pivAngle,tRes*3/pivRad(2)); %bound pivot angle from below</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line">    <span class="mxinfo " id="T15:U790"><span class="var type1" id="S68T15U1096">pivAngle</span>=<span class="mxinfo " id="T15:U792"><span class="mxinfo " id="T15:U793"><span class="mxinfo " id="T15:U794">(<span class="mxinfo " id="T15:U795"><span class="mxinfo " id="T15:U796">1</span>-<span class="mxinfo " id="T15:U797">2*(<span class="mxinfo " id="T3:U798"><span class="var type1" id="S56T15U1107">mv</span>==<span class="var type1" id="S30T15U1108">src</span></span>)</span></span>)*<span class="var type1" id="S51T15U1109">fDir</span></span>*<span class="mxinfo " id="T15:U802">sign(<span class="mxinfo " id="T15:U803"><span class="var type1" id="S42T1U1113">piv</span>(<span class="var type1" id="S56T15U1114">mv</span>,<span class="mxinfo " id="T12:U806">3</span>)</span>)</span></span>*(<span class="mxinfo " id="T15:U807"><span class="var type1" id="S68T15U1118">pivAngle</span>+<span class="mxinfo " id="T15:U809"><span class="mxinfo " id="T15:U810"><span class="var type1" id="S40T15U1121">trEps</span>*(<span class="mxinfo " id="T15:U812"><span class="mxinfo " id="T15:U813">1</span>+<span class="mxinfo " id="T15:U814">rand</span></span>)</span>/<span class="mxinfo " id="T15:U815">max(<span class="mxinfo " id="T15:U816"><span class="var type1" id="S67T4U1130">pivRad</span>(<span class="mxinfo " id="T12:U818">2</span>)</span>,<span class="mxinfo " id="T15:U819"><span class="mxinfo " id="T15:U820">0.5</span>*<span class="var type1" id="S8T15U1134">B</span></span>)</span></span></span>)</span></span>; <span class="comment">%rotate a little further to make sure, and orient</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line">    <span class="mxinfo " id="T4:U822"><span class="var type1" id="S70T4U1137">sm12v</span>=<span class="mxinfo " id="T4:U824"><span class="mxinfo " id="T4:U825"><span class="var type1" id="S3T2U1140">sm</span>(<span class="var type1" id="S56T15U1141">mv</span>,<span class="mxinfo " id="T21:U828">1:2</span>)</span>-<span class="mxinfo " id="T4:U829"><span class="var type1" id="S3T2U1146">sm</span>(<span class="mxinfo " id="T15:U831"><span class="mxinfo " id="T15:U832">3</span>-<span class="var type1" id="S56T15U1149">mv</span></span>,<span class="mxinfo " id="T4:U834"><span class="mxinfo " id="T15:U835">1</span>:<span class="mxinfo " id="T15:U836">2</span></span>)</span></span></span>; <span class="comment">%vector between smarticles</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line">    <span class="comment">%rotate COM; add repulsive noise to prevent sticking together:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line">    <span class="mxinfo " id="T4:U837"><span class="mxinfo " id="T4:U838"><span class="var type1" id="S2T1U1156">xSm</span>(<span class="var type1" id="S56T15U1157">mv</span>,<span class="mxinfo " id="T4:U841"><span class="mxinfo " id="T15:U842">1</span>:<span class="mxinfo " id="T15:U843">2</span></span>)</span>=<span class="mxinfo " id="T4:U844"><span class="mxinfo " id="T4:U845"><span class="mxinfo " id="T4:U846"><span class="var type1" id="S2T1U1164">xSm</span>(<span class="var type1" id="S56T15U1165">mv</span>,<span class="mxinfo " id="T4:U849"><span class="mxinfo " id="T15:U850">1</span>:<span class="mxinfo " id="T15:U851">2</span></span>)</span>+<span class="mxinfo " id="T4:U852"><span class="mxinfo " id="T4:U853"><span class="var type1" id="S68T15U1171">pivAngle</span>*<span class="mxinfo " id="T4:U855">[1,-1]</span></span>.*<span class="mxinfo " id="T4:U856">flip(<span class="var type1" id="S65T4U1179">pivCOM</span>)</span></span></span>+<span class="mxinfo " id="T4:U858"><span class="mxinfo " id="T4:U859"><span class="mxinfo " id="T4:U860"><span class="mxinfo " id="T15:U861"><span class="var type1" id="S40T15U1184">trEps</span>*<span class="mxinfo " id="T15:U863">abs(<span class="var type1" id="S68T15U1187">pivAngle</span>)</span></span>*<span class="var type1" id="S70T4U1188">sm12v</span></span>/<span class="mxinfo " id="T15:U866">norm(<span class="var type1" id="S70T4U1191">sm12v</span>)</span></span>*<span class="mxinfo " id="T15:U868">rand</span></span></span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line">    <span class="mxinfo " id="T15:U869"><span class="mxinfo " id="T15:U870"><span class="var type1" id="S2T1U1197">xSm</span>(<span class="var type1" id="S56T15U1198">mv</span>,<span class="mxinfo " id="T15:U873">3</span>)</span>=<span class="mxinfo " id="T15:U874"><span class="mxinfo " id="T15:U875"><span class="var type1" id="S2T1U1202">xSm</span>(<span class="var type1" id="S56T15U1203">mv</span>,<span class="mxinfo " id="T15:U878">3</span>)</span>+<span class="var type1" id="S68T15U1205">pivAngle</span></span></span>; <span class="comment">%rotate angle</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line">    <span class="comment">%if links were near-parallel, ensure they don't pass through on nextstep: </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line">    <span class="comment">%(instead make them cross at the same point they did this time)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line">    <span class="keyword">if</span>(<span class="mxinfo " id="T3:U880"><span class="mxinfo " id="T15:U881">abs(<span class="mxinfo " id="T15:U882"><span class="var type1" id="S49T15U1213">so2fAng</span>-<span class="mxinfo " id="T15:U884"><span class="mxinfo " id="T15:U885">pi</span>/<span class="mxinfo " id="T15:U886">2</span></span></span>)</span>&lt;<span class="mxinfo " id="T15:U887"><span class="var type1" id="S9T15U1219">tRes</span>*<span class="mxinfo " id="T15:U889">10</span></span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line">        <span class="mxinfo " id="T6:U890"><span class="var type1" id="S73T6U1223">nextCrd</span>=<span class="mxinfo " id="T6:U892"><span class="fcn" id="F2N7:B1225">smcle2coord</span>(<span class="mxinfo " id="T2:U893">[<span class="var type1" id="S2T1U1228">xSm</span>,<span class="var type1" id="S6T5U1229">nextAl</span>]</span>)</span></span>; <span class="comment">%coordinates for next arm angles</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line">        <span class="mxinfo " id="T23:U896"><span class="var type1" id="S74T23U1232">nextInt</span>=<span class="mxinfo " id="T23:U898"><span class="fcn" id="F351N3:B1234">lineSegmentIntersect</span>(<span class="mxinfo " id="T11:U899"><span class="var type1" id="S73T6U1236">nextCrd</span>(<span class="var type1" id="S30T15U1237">src</span>,<span class="mxinfo " id="T11:U902"><span class="mxinfo " id="T15:U903">(<span class="mxinfo " id="T15:U904"><span class="var type1" id="S32T15U1242">sLk</span>-<span class="mxinfo " id="T15:U906">1</span></span>)*<span class="mxinfo " id="T15:U907">2</span></span>+(<span class="mxinfo " id="T11:U908">1:4</span>)</span>)</span>,<span class="mxinfo " id="T11:U909"><span class="var type1" id="S73T6U1250">nextCrd</span>(<span class="var type1" id="S31T15U1251">trg</span>,<span class="mxinfo " id="T11:U912"><span class="mxinfo " id="T15:U913">(<span class="mxinfo " id="T15:U914"><span class="var type1" id="S34T15U1256">tLk</span>-<span class="mxinfo " id="T15:U916">1</span></span>)*<span class="mxinfo " id="T15:U917">2</span></span>+(<span class="mxinfo " id="T11:U918">1:4</span>)</span>)</span>)</span></span>; <span class="comment">%intersection of these same links</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line"><span class="comment">%         cla; plot(nextCrd(:,1:2:end)',nextCrd(:,2:2:end)','-o','LineWidth',2); axis([-0.5,0.5,-0.5,0.5]*12);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line"><span class="comment">%         scatter(nextInt.intMatrixX(:),nextInt.intMatrixY(:),1000,'r.'); %mark collision points</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line">        <span class="comment">%get new force orientation:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line">        <span class="mxinfo " id="T15:U919"><span class="var type1" id="S75T15U1265">begS</span>=<span class="mxinfo " id="T15:U921"><span class="mxinfo " id="T15:U922">1</span>-<span class="mxinfo " id="T15:U923">2*<span class="var type1" id="S36T3U1270">beg</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line">        <span class="mxinfo " id="T4:U925"><span class="var type1" id="S76T4U1273">nSV</span>=<span class="mxinfo " id="T4:U927"><span class="var type1" id="S75T15U1275">begS</span> *(<span class="mxinfo " id="T4:U929"><span class="mxinfo " id="T4:U930"><span class="var type1" id="S73T6U1279">nextCrd</span>(<span class="var type1" id="S30T15U1280">src</span>,<span class="mxinfo " id="T4:U933"><span class="mxinfo " id="T15:U934">(<span class="var type1" id="S32T15U1284">sLk</span>)*<span class="mxinfo " id="T15:U936">2</span></span>+(<span class="mxinfo " id="T4:U937">1:2</span>)</span>)</span>-<span class="mxinfo " id="T4:U938"><span class="var type1" id="S73T6U1291">nextCrd</span>(<span class="var type1" id="S30T15U1292">src</span>,<span class="mxinfo " id="T4:U941"><span class="mxinfo " id="T15:U942">(<span class="mxinfo " id="T15:U943"><span class="var type1" id="S32T15U1297">sLk</span>-<span class="mxinfo " id="T15:U945">1</span></span>)*<span class="mxinfo " id="T15:U946">2</span></span>+(<span class="mxinfo " id="T4:U947">1:2</span>)</span>)</span></span>)</span></span>; <span class="comment">%new source vector</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line">        <span class="mxinfo " id="T4:U948"><span class="var type1" id="S77T4U1306">nTV</span>=<span class="mxinfo " id="T4:U950"><span class="mxinfo " id="T4:U951"><span class="var type1" id="S73T6U1309">nextCrd</span>(<span class="var type1" id="S31T15U1310">trg</span>,<span class="mxinfo " id="T4:U954"><span class="mxinfo " id="T15:U955">(<span class="var type1" id="S34T15U1314">tLk</span>)*<span class="mxinfo " id="T15:U957">2</span></span>+(<span class="mxinfo " id="T4:U958">1:2</span>)</span>)</span>-<span class="mxinfo " id="T4:U959"><span class="var type1" id="S73T6U1321">nextCrd</span>(<span class="var type1" id="S31T15U1322">trg</span>,<span class="mxinfo " id="T4:U962"><span class="mxinfo " id="T15:U963">(<span class="mxinfo " id="T15:U964"><span class="var type1" id="S34T15U1327">tLk</span>-<span class="mxinfo " id="T15:U966">1</span></span>)*<span class="mxinfo " id="T15:U967">2</span></span>+(<span class="mxinfo " id="T4:U968">1:2</span>)</span>)</span></span></span>; <span class="comment">%new target vector</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line">        <span class="mxinfo " id="T15:U969"><span class="var type1" id="S78T15U1336">sinTh</span>=<span class="mxinfo " id="T15:U971"><span class="mxinfo " id="T15:U972">(<span class="mxinfo " id="T15:U973"><span class="mxinfo " id="T15:U974"><span class="mxinfo " id="T15:U975"><span class="var type1" id="S76T4U1343">nSV</span>(<span class="mxinfo " id="T12:U977">1</span>)</span>*<span class="mxinfo " id="T15:U978"><span class="var type1" id="S77T4U1346">nTV</span>(<span class="mxinfo " id="T15:U980">2</span>)</span></span>-<span class="mxinfo " id="T15:U981"><span class="mxinfo " id="T15:U982"><span class="var type1" id="S76T4U1350">nSV</span>(<span class="mxinfo " id="T15:U984">2</span>)</span>*<span class="mxinfo " id="T15:U985"><span class="var type1" id="S77T4U1353">nTV</span>(<span class="mxinfo " id="T15:U987">1</span>)</span></span></span>)/<span class="mxinfo " id="T15:U988">norm(<span class="var type1" id="S76T4U1357">nSV</span>)</span></span>/<span class="mxinfo " id="T15:U990">norm(<span class="var type1" id="S77T4U1360">nTV</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line">        <span class="mxinfo " id="T15:U992"><span class="var type1" id="S79T15U1363">flipOrt</span>=<span class="mxinfo " id="T15:U994"><span class="mxinfo " id="T15:U995">-<span class="var type1" id="S51T15U1366">fDir</span></span>*<span class="mxinfo " id="T15:U997">sign(<span class="var type1" id="S78T15U1369">sinTh</span>)</span></span></span>;<span class="comment">%do the links flip relative orientation? use sin = cross prod</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line">        <span class="keyword">if</span>(<span class="mxinfo " id="T3:U999"><span class="var type1" id="S79T15U1374">flipOrt</span>&gt;<span class="mxinfo " id="T15:U1001">0</span></span>); <span class="mxinfo " id="T15:U1002"><span class="var type1" id="S80T15U1378">currInt</span>=<span class="mxinfo " id="T15:U1004"><span class="mxinfo " id="T15:U1005"><span class="var type1" id="S74T23U1382">nextInt</span>.intNormalizedDistance1To2</span>(1)*<span class="mxinfo " id="T15:U1007"><span class="var type1" id="S17T9U1386">lenMx</span>(<span class="var type1" id="S32T15U1387">sLk</span>,<span class="mxinfo " id="T15:U1010">1</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line">        <span class="keyword">else</span>; <span class="mxinfo " id="T15:U1011"><span class="var type1" id="S80T15U1392">currInt</span>=<span class="mxinfo " id="T15:U1013"><span class="mxinfo " id="T15:U1014"><span class="var type1" id="S74T23U1396">nextInt</span>.intNormalizedDistance2To1</span>(1)*<span class="mxinfo " id="T15:U1016"><span class="var type1" id="S17T9U1400">lenMx</span>(<span class="var type1" id="S34T15U1401">tLk</span>,<span class="mxinfo " id="T15:U1019">1</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line">            <span class="mxinfo " id="T15:U1020"><span class="var type1" id="S75T15U1405">begS</span>=<span class="mxinfo " id="T15:U1022"><span class="mxinfo " id="T15:U1023">1</span>-<span class="mxinfo " id="T15:U1024">2*(<span class="mxinfo " id="T3:U1025"><span class="mxinfo " id="T15:U1026"><span class="var type1" id="S76T4U1413">nSV</span>*<span class="mxinfo " id="T22:U1028"><span class="var type1" id="S77T4U1415">nTV</span>'</span></span>&gt;<span class="mxinfo " id="T15:U1030">0</span></span>)</span></span></span>; <span class="mxinfo " id="T4:U1031"><span class="var type1" id="S77T4U1419">nTV</span>=<span class="mxinfo " id="T4:U1033"><span class="mxinfo " id="T15:U1034">-<span class="var type1" id="S75T15U1422">begS</span></span>*<span class="var type1" id="S76T4U1423">nSV</span></span></span>; <span class="mxinfo " id="T15:U1037"><span class="var type1" id="S32T15U1426">sLk</span>=<span class="var type1" id="S34T15U1427">tLk</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line">        <span class="mxinfo " id="T15:U1040"><span class="var type1" id="S81T15U1430">goalInt</span>=<span class="mxinfo " id="T15:U1042"><span class="mxinfo " id="T15:U1043"><span class="var type1" id="S17T9U1433">lenMx</span>(<span class="var type1" id="S32T15U1434">sLk</span>,<span class="mxinfo " id="T15:U1046">1</span>)</span>*(<span class="mxinfo " id="T15:U1047"><span class="mxinfo " id="T15:U1048">0.5</span>+<span class="mxinfo " id="T15:U1049"><span class="mxinfo " id="T15:U1050">0.45</span>*<span class="var type1" id="S75T15U1441">begS</span></span></span>)</span></span>; <span class="comment">%shift s.t. this is new intersection point</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line">        <span class="mxinfo " id="T15:U1052"><span class="var type1" id="S82T15U1444">smShift</span>=<span class="mxinfo " id="T15:U1054"><span class="mxinfo " id="T15:U1055"><span class="var type1" id="S75T15U1447">begS</span>*(<span class="mxinfo " id="T15:U1057"><span class="var type1" id="S81T15U1450">goalInt</span>-<span class="var type1" id="S80T15U1451">currInt</span></span>)</span>*<span class="mxinfo " id="T15:U1060">abs(<span class="var type1" id="S78T15U1454">sinTh</span>)</span></span></span>; <span class="comment">%shift = intShift * sin(angle between new links)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line">        <span class="keyword">if</span>(<span class="mxinfo " id="T3:U1062"><span class="var type1" id="S82T15U1459">smShift</span>&gt;<span class="mxinfo " id="T15:U1064">0</span></span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line"><span class="comment">%             if(smShift&lt;trEps/5); smShift=trEps; end %bound shift from below</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line">            <span class="mxinfo " id="T4:U1065"><span class="mxinfo " id="T4:U1066"><span class="var type1" id="S2T1U1464">xSm</span>(<span class="var type1" id="S56T15U1465">mv</span>,<span class="mxinfo " id="T4:U1069"><span class="mxinfo " id="T15:U1070">1</span>:<span class="mxinfo " id="T15:U1071">2</span></span>)</span>=<span class="mxinfo " id="T4:U1072"><span class="mxinfo " id="T4:U1073"><span class="var type1" id="S2T1U1471">xSm</span>(<span class="var type1" id="S56T15U1472">mv</span>,<span class="mxinfo " id="T4:U1076"><span class="mxinfo " id="T15:U1077">1</span>:<span class="mxinfo " id="T15:U1078">2</span></span>)</span>-<span class="mxinfo " id="T4:U1079"><span class="mxinfo " id="T4:U1080"><span class="mxinfo " id="T4:U1081"><span class="mxinfo " id="T15:U1082"><span class="mxinfo " id="T15:U1083">(<span class="mxinfo " id="T15:U1084"><span class="mxinfo " id="T15:U1085">1</span>-<span class="mxinfo " id="T15:U1086">2*(<span class="mxinfo " id="T3:U1087"><span class="var type1" id="S56T15U1488">mv</span>==<span class="var type1" id="S30T15U1489">src</span></span>)</span></span>)*<span class="var type1" id="S51T15U1490">fDir</span></span>*<span class="var type1" id="S82T15U1491">smShift</span></span>*<span class="mxinfo " id="T4:U1092">flip(<span class="var type1" id="S77T4U1494">nTV</span>)</span></span>.*<span class="mxinfo " id="T4:U1094">[<span class="mxinfo " id="T15:U1095">1</span>,<span class="mxinfo " id="T15:U1096">-<span class="mxinfo " id="T15:U1097">1</span></span>]</span></span>/<span class="mxinfo " id="T15:U1098">norm(<span class="var type1" id="S77T4U1502">nTV</span>)</span></span></span></span>; <span class="comment">%shift orthogonal to new target vector</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line">        <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line">            <span class="mxinfo " id="T15:U1100"><span class="mxinfo " id="T15:U1101"><span class="var type1" id="S2T1U1507">xSm</span>(<span class="var type1" id="S56T15U1508">mv</span>,<span class="mxinfo " id="T15:U1104">3</span>)</span>=<span class="mxinfo " id="T15:U1105"><span class="mxinfo " id="T15:U1106"><span class="var type1" id="S2T1U1512">xSm</span>(<span class="var type1" id="S56T15U1513">mv</span>,<span class="mxinfo " id="T15:U1109">3</span>)</span>+<span class="mxinfo " id="T15:U1110">(<span class="mxinfo " id="T15:U1111"><span class="mxinfo " id="T15:U1112">rand</span>-<span class="mxinfo " id="T15:U1113">0.5</span></span>)*<span class="mxinfo " id="T15:U1114">0.1</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line"><span class="comment">%         nextCrd=smcle2coord([xSm,nextAl]); %coordinates for next arm angles</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line"><span class="comment">%         nextInt=lineSegmentIntersect(nextCrd(src,(sLk-1)*2+(1:4)),nextCrd(trg,(tLk-1)*2+(1:4))); %intersection of these same links</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line"><span class="comment">%         cla; plot(nextCrd(:,1:2:end)',nextCrd(:,2:2:end)','-o','LineWidth',2); axis([-0.5,0.5,-0.5,0.5]*12);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line"><span class="comment">%         scatter(nextInt.intMatrixX(:),nextInt.intMatrixY(:),1000,'r.'); %mark collision points</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line">    <span class="keyword">elseif</span>(<span class="mxinfo " id="T3:U1115"><span class="mxinfo " id="T15:U1116">abs(<span class="var type1" id="S68T15U1527">pivAngle</span>)</span>&gt;=<span class="var type1" id="S41T15U1528">maxAngle</span></span>) <span class="comment">%if still hasn't moved, wiggle apart</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line">        <span class="mxinfo " id="T4:U1119"><span class="var type1" id="S70T4U1531">sm12v</span>=<span class="mxinfo " id="T4:U1121"><span class="mxinfo " id="T4:U1122"><span class="var type1" id="S3T2U1534">sm</span>(<span class="var type1" id="S56T15U1535">mv</span>,<span class="mxinfo " id="T21:U1125">1:2</span>)</span>-<span class="mxinfo " id="T4:U1126"><span class="var type1" id="S3T2U1540">sm</span>(<span class="mxinfo " id="T15:U1128"><span class="mxinfo " id="T15:U1129">3</span>-<span class="var type1" id="S56T15U1543">mv</span></span>,<span class="mxinfo " id="T4:U1131"><span class="mxinfo " id="T15:U1132">1</span>:<span class="mxinfo " id="T15:U1133">2</span></span>)</span></span></span>; <span class="comment">%vector between smarticles</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line">        <span class="mxinfo " id="T4:U1134"><span class="mxinfo " id="T4:U1135"><span class="var type1" id="S2T1U1550">xSm</span>(<span class="var type1" id="S56T15U1551">mv</span>,<span class="mxinfo " id="T4:U1138"><span class="mxinfo " id="T15:U1139">1</span>:<span class="mxinfo " id="T15:U1140">2</span></span>)</span>=<span class="mxinfo " id="T4:U1141"><span class="mxinfo " id="T4:U1142"><span class="var type1" id="S2T1U1557">xSm</span>(<span class="var type1" id="S56T15U1558">mv</span>,<span class="mxinfo " id="T4:U1145"><span class="mxinfo " id="T15:U1146">1</span>:<span class="mxinfo " id="T15:U1147">2</span></span>)</span>+<span class="mxinfo " id="T4:U1148"><span class="mxinfo " id="T4:U1149"><span class="mxinfo " id="T4:U1150"><span class="var type1" id="S70T4U1565">sm12v</span>/<span class="mxinfo " id="T15:U1152">norm(<span class="var type1" id="S70T4U1568">sm12v</span>)</span></span>*<span class="mxinfo " id="T15:U1154">rand</span></span>*<span class="var type1" id="S40T15U1571">trEps</span></span></span></span>; <span class="comment">%add repulsive noise to prevent sticking together</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line">        <span class="mxinfo " id="T15:U1156"><span class="mxinfo " id="T15:U1157"><span class="var type1" id="S2T1U1575">xSm</span>(<span class="var type1" id="S56T15U1576">mv</span>,<span class="mxinfo " id="T15:U1160">3</span>)</span>=<span class="mxinfo " id="T15:U1161"><span class="mxinfo " id="T15:U1162"><span class="var type1" id="S2T1U1580">xSm</span>(<span class="var type1" id="S56T15U1581">mv</span>,<span class="mxinfo " id="T15:U1165">3</span>)</span>+<span class="mxinfo " id="T15:U1166">(<span class="mxinfo " id="T15:U1167"><span class="mxinfo " id="T15:U1168">rand</span>-<span class="mxinfo " id="T15:U1169">0.5</span></span>)*<span class="mxinfo " id="T15:U1170">0.02</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line"><span class="comment">%     if(abs(so2fAng-pi/2)&lt;tRes*10) %approx cos</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line"><span class="comment">%         xSm(:,1:2)=xSm(:,1:2)+4*trEps*fDir*[cos(fAng),sin(fAng)].*[1;-1];</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line"><span class="comment">%         xSm(:,3)=xSm(:,3)+(rand(2,1)-0.5)*tRes*40;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line"><span class="comment">%     end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line"><span class="comment">%response when force applied to the right arm or corner</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line"><span class="comment">%in: arm angle, force angle, arm length (in units of B)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line"><span class="comment">%out: [px,py,f] = pivot coordinates (in units of B) and critical force</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,136" id="srcline136">136</a></span><span class="line"><span class="comment">%required to move (in units of friction force; f&gt;0 =&gt; CCW rotation)</span></span></span>
</pre>
<div class="dead">
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,137" id="srcline137">137</a></span><span class="line">function [out]=pivotArm(al,th,A)</span></span>
<span class="srcline"><span class="lineno"><a href="1,138" id="srcline138">138</a></span><span class="line">    secth=sec(th); tanth=tan(th);</span></span>
<span class="srcline"><span class="lineno"><a href="1,139" id="srcline139">139</a></span><span class="line">    <span class="comment">%the constant out front quantifies how far off the pivot can be (larger=&gt;further away). "right" value: 0.081</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,140" id="srcline140">140</a></span><span class="line">    py=0.081./(-2*A*secth.*sin(al-th)+tanth); <span class="comment">%approximation for py</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,141" id="srcline141">141</a></span><span class="line">    pylnpy2=-0.6*atan(10*py); <span class="comment">%differentiable approximation for py*log(py^2) for py in (-0.5,0.5)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,142" id="srcline142">142</a></span><span class="line">    px=tanth/2.*pylnpy2;</span></span>
<span class="srcline"><span class="lineno"><a href="1,143" id="srcline143">143</a></span><span class="line">    f=-secth.*pylnpy2;</span></span>
<span class="srcline"><span class="lineno"><a href="1,144" id="srcline144">144</a></span><span class="line">    out=[px,py,f];</span></span>
<span class="srcline"><span class="lineno"><a href="1,145" id="srcline145">145</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="1,146" id="srcline146">146</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,147" id="srcline147">147</a></span><span class="line"><span class="comment">%response when orthogonal force applied to the body</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,148" id="srcline148">148</a></span><span class="line"><span class="comment">%in: distance from center to push point (in units of B)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,149" id="srcline149">149</a></span><span class="line"><span class="comment">%out: [px,py,f] = pivot coordinates (in units of B) and critical force required to move</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,150" id="srcline150">150</a></span><span class="line">function [out]=pivotBody(x)</span></span>
<span class="srcline"><span class="lineno"><a href="1,151" id="srcline151">151</a></span><span class="line">    sq=sqrt(1+4*x.^2);</span></span>
<span class="srcline"><span class="lineno"><a href="1,152" id="srcline152">152</a></span><span class="line">    out=[(x-sign(x).*sq/2), 0, -2*x+sign(x).*sq];</span></span>
<span class="srcline"><span class="lineno"><a href="1,153" id="srcline153">153</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="1,154" id="srcline154">154</a></span><span class="line"> </span></span>
</pre>
</div>
</body>
</html>
