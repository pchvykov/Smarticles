<html>
<body>
<script src="resources/eml_report_loadable_data.js"></script>
<pre class="code">
<span class="srcline"><span class="lineno"><a href="59,1" id="srcline1">  1</a></span><span class="line"><span class="comment">%resolve a pair-collision, returning new sm position values</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,2" id="srcline2">  2</a></span><span class="line"><span class="comment">%in: the two smcle 5-tuples, flag whether to resolve or just check collisions</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,3" id="srcline3">  3</a></span><span class="line"><span class="comment">%out: T/F if just checking, list of new 3-tuples (cx,cy,theta) if resolving</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,4" id="srcline4">  4</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T57U3">xSm</span>]=pairCollision(<span class="var type2" id="S3T10V3U6">sm</span>, <span class="var type2" id="S4T39V4U7">resolveFl</span>, <span class="var type2" id="S5T58V5U8">fricCoeff</span>, <span class="var type0" id="S6T0U9">nextAl</span>) <span class="comment">%#codegen</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,5" id="srcline5">  5</a></span><span class="line">    <span class="keyword">global</span> <span class="var type0" id="S7T0U11">A</span> <span class="var type0" id="S8T0U12">B</span> <span class="var type0" id="S9T0U13">tRes</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="59,6" id="srcline6">  6</a></span><span class="line">    <span class="comment">% check for collisions:----------</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,7" id="srcline7">  7</a></span><span class="line">    <span class="var type0" id="S10T0U16">crd</span>=<span class="message error" id="M2F150C"><span class="fcn" id="F151N6:B18">smcle2coord</span>(<span class="var type1" id="S3T10U19">sm</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="59,8" id="srcline8">  8</a></span><span class="line">    <span class="var type0" id="S12T0U22">inters</span> = lineSegmentIntersect([<span class="var type0" id="S10T0U28"><span class="message error" id="M3F150C">crd</span></span>(1,1:4); <span class="var type0" id="S10T0U35">crd</span>(1,3:6); <span class="var type0" id="S10T0U42">crd</span>(1,5:8)],[<span class="var type0" id="S10T0U50">crd</span>(2,1:4); <span class="var type0" id="S10T0U57">crd</span>(2,3:6); <span class="var type0" id="S10T0U64">crd</span>(2,5:8)]);</span></span>
<span class="srcline"><span class="lineno"><a href="59,9" id="srcline9">  9</a></span><span class="line">    <span class="keyword">if</span> all(~<span class="var type0" id="S12T0U75"><span class="message error" id="M4F150C">inters</span></span>.intAdjacencyMatrix); <span class="var type0" id="S2T0U79">xSm</span>=zeros(<span class="mxinfo " id="T1:U6">2</span>,<span class="mxinfo " id="T1:U7">3</span>); <span class="keyword">return</span>; <span class="keyword">end</span> <span class="comment">%if no collision, return false</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,10" id="srcline10"> 10</a></span><span class="line">    <span class="keyword">if</span>(~<span class="var type1" id="S4T39U89">resolveFl</span>); <span class="var type0" id="S2T0U92">xSm</span>=ones(2,3); <span class="keyword">return</span>; <span class="keyword">end</span> <span class="comment">%if just checking for collisions</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,11" id="srcline11"> 11</a></span><span class="line"><span class="comment">%     cla; plot(crd(:,1:2:end)',crd(:,2:2:end)','-o','LineWidth',2); axis([-0.5,0.5,-0.5,0.5]*12);</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,12" id="srcline12"> 12</a></span><span class="line"><span class="comment">%     scatter(inters.intMatrixX(:),inters.intMatrixY(:),1000,'r.'); %mark collision points</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,13" id="srcline13"> 13</a></span><span class="line">    <span class="comment">% find out who is pushing who:-------</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,14" id="srcline14"> 14</a></span><span class="line">    <span class="var type0" id="S17T0U100">lenMx</span>=repmat([<span class="var type1" id="S7T1U105">A</span>;<span class="mxinfo " id="T59:U10"><span class="var type1" id="S8T59U107"><span class="message error" id="M5F150C">B</span></span></span>;<span class="var type0" id="S7T0U109">A</span>],1,3); <span class="var type0" id="S19T0U114">lenMx2</span>=<span class="var type0" id="S17T0U116"><span class="message error" id="M6F150C">lenMx</span></span>'; <span class="comment">%scales to get real-space distances</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,15" id="srcline15"> 15</a></span><span class="line">    <span class="var type0" id="S20T0U119">inX</span>=find(<span class="var type0" id="S12T0U123"><span class="message error" id="M7F150C">inters</span></span>.intAdjacencyMatrix); <span class="var type0" id="S20T0U127">inX</span>=<span class="var type0" id="S20T0U129"><span class="message error" id="M8F150C">inX</span></span>(1); <span class="comment">%get intersection index</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,16" id="srcline16"> 16</a></span><span class="line">    <span class="var type0" id="S22T0U133">dBeg12</span>=<span class="var type0" id="S12T0U136"><span class="message error" id="M9F150C">inters</span></span>.intNormalizedDistance1To2(<span class="var type0" id="S20T0U138">inX</span>); <span class="var type0" id="S23T0U141">dEnd12</span>=(1-<span class="var type0" id="S22T0U146"><span class="message error" id="M10F150C">dBeg12</span></span>).*<span class="var type0" id="S17T0U148">lenMx</span>(<span class="var type0" id="S20T0U149">inX</span>); <span class="var type0" id="S22T0U152">dBeg12</span>=<span class="var type0" id="S22T0U154"><span class="message error" id="M11F150C">dBeg12</span></span>.*<span class="var type0" id="S17T0U156">lenMx</span>(<span class="var type0" id="S20T0U157">inX</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="59,17" id="srcline17"> 17</a></span><span class="line">    <span class="var type0" id="S24T0U160">dBeg21</span>=<span class="var type0" id="S12T0U163"><span class="message error" id="M12F150C">inters</span></span>.intNormalizedDistance2To1(<span class="var type0" id="S20T0U165">inX</span>); <span class="var type0" id="S25T0U168">dEnd21</span>=(1-<span class="var type0" id="S24T0U173"><span class="message error" id="M13F150C">dBeg21</span></span>).*<span class="var type0" id="S19T0U175">lenMx2</span>(<span class="var type0" id="S20T0U176">inX</span>); <span class="var type0" id="S24T0U179">dBeg21</span>=<span class="var type0" id="S24T0U181"><span class="message error" id="M14F150C">dBeg21</span></span>.*<span class="var type0" id="S19T0U183">lenMx2</span>(<span class="var type0" id="S20T0U184">inX</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="59,18" id="srcline18"> 18</a></span><span class="line">    <span class="var type0" id="S26T0U187">intDistVc</span>=[<span class="var type0" id="S22T0U190"><span class="message error" id="M15F150C">dBeg12</span></span>, <span class="var type0" id="S23T0U191">dEnd12</span>, <span class="var type0" id="S24T0U192">dBeg21</span>, <span class="var type0" id="S25T0U193">dEnd21</span>];</span></span>
<span class="srcline"><span class="lineno"><a href="59,19" id="srcline19"> 19</a></span><span class="line">    <span class="comment">%decide by min sticking-out length:</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,20" id="srcline20"> 20</a></span><span class="line">    [<span class="var type0" id="S27T0U197"><span class="message error" id="M17F150C">minDist</span></span>,<span class="var type0" id="S28T0U198"><span class="message error" id="M18F150C">mIx</span></span>]=min(<span class="var type0" id="S26T0U201"><span class="message error" id="M16F150C">intDistVc</span></span>); <span class="comment">%find shortest distance to intersec</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,21" id="srcline21"> 21</a></span><span class="line"><span class="comment">%     if(minDist&gt;B/3) %error - need higher resolution (ambiguous pusing/pushed)</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,22" id="srcline22"> 22</a></span><span class="line"><span class="comment">%         "warning: collision orientation ambiguous"</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,23" id="srcline23"> 23</a></span><span class="line"><span class="comment">%     end</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,24" id="srcline24"> 24</a></span><span class="line">    <span class="keyword">if</span>(<span class="var type0" id="S28T0U206"><span class="message fatal" id="M19F150C">mIx</span></span>&lt;=2); <span class="var type0" id="S30T0U210">src</span>=1; <span class="var type0" id="S31T0U214">trg</span>=2; <span class="var type0" id="S32T0U218">sLk</span>=mod(<span class="var type0" id="S20T0U223">inX</span>-1,3)+1; <span class="var type0" id="S34T0U229">tLk</span>=ceil(<span class="var type0" id="S20T0U233">inX</span>/3); <span class="comment">%src - pushing, trg - pushed</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,25" id="srcline25"> 25</a></span><span class="line">    <span class="keyword">else</span>; <span class="var type0" id="S30T0U238">src</span>=2; <span class="var type0" id="S31T0U242">trg</span>=1; <span class="var type0" id="S34T0U246">tLk</span>=mod(<span class="var type0" id="S20T0U251">inX</span>-1,3)+1; <span class="var type0" id="S32T0U257">sLk</span>=ceil(<span class="var type0" id="S20T0U261">inX</span>/3);</span></span>
<span class="srcline"><span class="lineno"><a href="59,26" id="srcline26"> 26</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,27" id="srcline27"> 27</a></span><span class="line">    <span class="var type0" id="S36T0U265">beg</span>=logical(mod(<span class="var type0" id="S28T0U270">mIx</span>,2)); <span class="comment">%src is at beginning of the sLk link? </span></span></span>
<span class="srcline"><span class="lineno"><a href="59,28" id="srcline28"> 28</a></span><span class="line">    <span class="keyword">if</span>(<span class="var type0" id="S32T0U278">sLk</span>==2 || (<span class="var type0" id="S32T0U283">sLk</span>==3 &amp;&amp; <span class="var type0" id="S36T0U285">beg</span>) || (<span class="var type0" id="S32T0U289">sLk</span>==1 &amp;&amp; ~<span class="var type0" id="S36T0U292">beg</span>)) <span class="comment">%ensure that corner - check other intersection</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,29" id="srcline29"> 29</a></span><span class="line">        <span class="keyword">if</span>(~(<span class="var type0" id="S30T0U301">src</span>==1 &amp;&amp; sum(<span class="var type0" id="S12T0U308">inters</span>.intAdjacencyMatrix(:,<span class="var type0" id="S34T0U311">tLk</span>))==2) <span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,30" id="srcline30"> 30</a></span><span class="line">                &amp;&amp; ~(<span class="var type0" id="S30T0U317">src</span>==2 &amp;&amp; sum(<span class="var type0" id="S12T0U324">inters</span>.intAdjacencyMatrix(<span class="var type0" id="S34T0U326">tLk</span>,:))==2))</span></span>
<span class="srcline"><span class="lineno"><a href="59,31" id="srcline31"> 31</a></span><span class="line">            <span class="var type0" id="S28T0U331">mIx</span>=(<span class="var type0" id="S28T0U335">mIx</span>&lt;=2)*2; [~,<span class="var type0" id="S39T0U342">tmp</span>]=min(<span class="var type0" id="S26T0U346">intDistVc</span>(<span class="var type0" id="S28T0U348">mIx</span>+(1:2)));</span></span>
<span class="srcline"><span class="lineno"><a href="59,32" id="srcline32"> 32</a></span><span class="line">            <span class="var type0" id="S28T0U355">mIx</span>=<span class="var type0" id="S28T0U357">mIx</span>+<span class="var type0" id="S39T0U358">tmp</span>; <span class="var type0" id="S36T0U361">beg</span>=logical(mod(<span class="var type0" id="S28T0U366">mIx</span>,2));</span></span>
<span class="srcline"><span class="lineno"><a href="59,33" id="srcline33"> 33</a></span><span class="line">            <span class="var type0" id="S39T0U370">tmp</span>=<span class="var type0" id="S30T0U371">src</span>; <span class="var type0" id="S30T0U374">src</span>=<span class="var type0" id="S31T0U375">trg</span>; <span class="var type0" id="S31T0U378">trg</span>=<span class="var type0" id="S39T0U379">tmp</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="59,34" id="srcline34"> 34</a></span><span class="line">            <span class="var type0" id="S39T0U382">tmp</span>=<span class="var type0" id="S32T0U383">sLk</span>; <span class="var type0" id="S32T0U386">sLk</span>=<span class="var type0" id="S34T0U387">tLk</span>; <span class="var type0" id="S34T0U390">tLk</span>=<span class="var type0" id="S39T0U391">tmp</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="59,35" id="srcline35"> 35</a></span><span class="line">        <span class="keyword">end</span> <span class="comment">%else make the other link source</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,36" id="srcline36"> 36</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,37" id="srcline37"> 37</a></span><span class="line">    <span class="comment">% Do move calculation:----------</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,38" id="srcline38"> 38</a></span><span class="line">    <span class="var type0" id="S40T0U394">trEps</span>=0.2*<span class="var type1" id="S9T1U398">tRes</span>*<span class="var type0" id="S8T0U399">B</span>; <span class="var type0" id="S41T0U402">maxAngle</span>=0.2;</span></span>
<span class="srcline"><span class="lineno"><a href="59,39" id="srcline39"> 39</a></span><span class="line">    <span class="comment">%get force angle from what we are pushing on (normal to the surface):</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,40" id="srcline40"> 40</a></span><span class="line">    <span class="comment">%and calculate the response on the pushed smarticle:</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,41" id="srcline41"> 41</a></span><span class="line">    <span class="var type0" id="S42T0U406">piv</span>=zeros(2,3); <span class="var type0" id="S43T0U413">fAng</span>=0;</span></span>
<span class="srcline"><span class="lineno"><a href="59,42" id="srcline42"> 42</a></span><span class="line">    <span class="keyword">if</span>(<span class="var type0" id="S34T0U419">tLk</span>==3); <span class="var type0" id="S43T0U423">fAng</span>=<span class="var type0" id="S3T0U426">sm</span>(<span class="var type0" id="S31T0U427">trg</span>,3)+<span class="var type0" id="S3T0U430">sm</span>(<span class="var type0" id="S31T0U431">trg</span>,5); <span class="comment">%right arm pushed</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,43" id="srcline43"> 43</a></span><span class="line">        <span class="var type0" id="S42T0U436">piv</span>(<span class="var type0" id="S31T0U437">trg</span>,:)=pivotArm(<span class="var type0" id="S3T0U442">sm</span>(<span class="var type0" id="S31T0U443">trg</span>,5), <span class="var type0" id="S3T0U447">sm</span>(<span class="var type0" id="S31T0U448">trg</span>,5)+pi/2, <span class="var type0" id="S26T0U456">intDistVc</span>(2*<span class="var type0" id="S31T0U460">trg</span>-1)/<span class="var type0" id="S8T0U462">B</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="59,44" id="srcline44"> 44</a></span><span class="line">    <span class="keyword">elseif</span>(<span class="var type0" id="S34T0U466">tLk</span>==2); <span class="var type0" id="S43T0U470">fAng</span>=<span class="var type0" id="S3T0U472">sm</span>(<span class="var type0" id="S31T0U473">trg</span>,3); <span class="comment">%body pushed</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,45" id="srcline45"> 45</a></span><span class="line">        <span class="var type0" id="S42T0U478">piv</span>(<span class="var type0" id="S31T0U479">trg</span>,:)=pivotBody(<span class="var type0" id="S26T0U486">intDistVc</span>(2*<span class="var type0" id="S31T0U490">trg</span>-1)/<span class="var type0" id="S8T0U492">B</span> - 0.5);</span></span>
<span class="srcline"><span class="lineno"><a href="59,46" id="srcline46"> 46</a></span><span class="line">    <span class="keyword">elseif</span>(<span class="var type0" id="S34T0U497">tLk</span>==1); <span class="var type0" id="S43T0U501">fAng</span>=<span class="var type0" id="S3T0U504">sm</span>(<span class="var type0" id="S31T0U505">trg</span>,3)-<span class="var type0" id="S3T0U508">sm</span>(<span class="var type0" id="S31T0U509">trg</span>,4); <span class="comment">%left arm pushed</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,47" id="srcline47"> 47</a></span><span class="line">        <span class="var type0" id="S42T0U514">piv</span>(<span class="var type0" id="S31T0U515">trg</span>,:)=pivotArm(<span class="var type0" id="S3T0U520">sm</span>(<span class="var type0" id="S31T0U521">trg</span>,4), <span class="var type0" id="S3T0U525">sm</span>(<span class="var type0" id="S31T0U526">trg</span>,4)+pi/2, <span class="var type0" id="S26T0U534">intDistVc</span>(2*<span class="var type0" id="S31T0U537">trg</span>)/<span class="var type0" id="S8T0U538">B</span>); <span class="var type0" id="S42T0U542">piv</span>(<span class="var type0" id="S31T0U543">trg</span>,[1,3])=-<span class="var type0" id="S42T0U550">piv</span>(<span class="var type0" id="S31T0U551">trg</span>,[1,3]); <span class="comment">%flip x-axis</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,48" id="srcline48"> 48</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,49" id="srcline49"> 49</a></span><span class="line">    <span class="comment">%get force orientation:</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,50" id="srcline50"> 50</a></span><span class="line">    <span class="var type0" id="S47T0U558">vStickOut</span>=<span class="var type0" id="S10T0U561">crd</span>(<span class="var type0" id="S30T0U562">src</span>,(<span class="var type0" id="S32T0U567">sLk</span>-<span class="var type0" id="S36T0U568">beg</span>)*2+(1:2))-[<span class="var type0" id="S12T0U578">inters</span>.intMatrixX(<span class="var type0" id="S20T0U580">inX</span>),<span class="var type0" id="S12T0U583">inters</span>.intMatrixY(<span class="var type0" id="S20T0U585">inX</span>)]; <span class="comment">%sLk-beg=[0,4] vertex index - gives the piece sticking through inters</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,51" id="srcline51"> 51</a></span><span class="line">    [<span class="var type0" id="S47T0U590">vStickOut</span>(1),<span class="var type0" id="S47T0U593">vStickOut</span>(2)]=cart2pol(<span class="var type0" id="S47T0U598">vStickOut</span>(1),<span class="var type0" id="S47T0U601">vStickOut</span>(2)); <span class="comment">%polar coordinates</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,52" id="srcline52"> 52</a></span><span class="line">    <span class="var type0" id="S49T0U605">so2fAng</span>=abs(mod(<span class="var type0" id="S47T0U614">vStickOut</span>(1)-<span class="var type0" id="S43T0U616">fAng</span>+pi,2*pi)-pi);</span></span>
<span class="srcline"><span class="lineno"><a href="59,53" id="srcline53"> 53</a></span><span class="line">    <span class="var type0" id="S51T0U627">fDir</span>=sign(pi/2-<span class="var type0" id="S49T0U635">so2fAng</span>); <span class="comment">%get the direction of the force on trg</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,54" id="srcline54"> 54</a></span><span class="line">    <span class="var type0" id="S2T0U638">xSm</span>=<span class="var type0" id="S3T0U640">sm</span>(:,1:3); <span class="comment">%setup the identity map</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,55" id="srcline55"> 55</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="59,56" id="srcline56"> 56</a></span><span class="line">    <span class="comment">%calculate the response on the pushing smarticle:</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,57" id="srcline57"> 57</a></span><span class="line">    <span class="keyword">if</span>(~<span class="var type0" id="S36T0U650">beg</span> &amp;&amp; <span class="var type0" id="S32T0U652">sLk</span>==3) <span class="comment">%if pushing with the right arm tip</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,58" id="srcline58"> 58</a></span><span class="line">        <span class="var type0" id="S42T0U657">piv</span>(<span class="var type0" id="S30T0U658">src</span>,:)=pivotArm(<span class="var type0" id="S3T0U663">sm</span>(<span class="var type0" id="S30T0U664">src</span>,5), <span class="var type0" id="S43T0U668">fAng</span>-<span class="var type0" id="S3T0U670">sm</span>(<span class="var type0" id="S30T0U671">src</span>,3)+pi/2, <span class="var type0" id="S7T0U678">A</span>/<span class="var type0" id="S8T0U679">B</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="59,59" id="srcline59"> 59</a></span><span class="line">    <span class="keyword">elseif</span>((<span class="var type0" id="S36T0U685">beg</span> &amp;&amp; <span class="var type0" id="S32T0U687">sLk</span>==3) || (~<span class="var type0" id="S36T0U692">beg</span> &amp;&amp; <span class="var type0" id="S32T0U694">sLk</span>==2)) <span class="comment">%if pushing with right corner</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,60" id="srcline60"> 60</a></span><span class="line">        <span class="var type0" id="S42T0U699">piv</span>(<span class="var type0" id="S30T0U700">src</span>,:)=pivotArm(0, <span class="var type0" id="S43T0U707">fAng</span>-<span class="var type0" id="S3T0U709">sm</span>(<span class="var type0" id="S30T0U710">src</span>,3)+pi/2, 0);</span></span>
<span class="srcline"><span class="lineno"><a href="59,61" id="srcline61"> 61</a></span><span class="line">    <span class="keyword">elseif</span>((<span class="var type0" id="S36T0U722">beg</span> &amp;&amp; <span class="var type0" id="S32T0U724">sLk</span>==2) || (~<span class="var type0" id="S36T0U729">beg</span> &amp;&amp; <span class="var type0" id="S32T0U731">sLk</span>==1)) <span class="comment">%pusing with left corner</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,62" id="srcline62"> 62</a></span><span class="line">        <span class="var type0" id="S42T0U736">piv</span>(<span class="var type0" id="S30T0U737">src</span>,:)=pivotArm(0, -<span class="var type0" id="S43T0U745">fAng</span>+<span class="var type0" id="S3T0U747">sm</span>(<span class="var type0" id="S30T0U748">src</span>,3)+pi/2, 0); <span class="var type0" id="S42T0U758">piv</span>(<span class="var type0" id="S30T0U759">src</span>,[1,3])=-<span class="var type0" id="S42T0U766">piv</span>(<span class="var type0" id="S30T0U767">src</span>,[1,3]);</span></span>
<span class="srcline"><span class="lineno"><a href="59,63" id="srcline63"> 63</a></span><span class="line">    <span class="keyword">elseif</span>(<span class="var type0" id="S36T0U775">beg</span> &amp;&amp; <span class="var type0" id="S32T0U777">sLk</span>==1) <span class="comment">%pushing with left arm tip</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,64" id="srcline64"> 64</a></span><span class="line">        <span class="var type0" id="S42T0U782">piv</span>(<span class="var type0" id="S30T0U783">src</span>,:)=pivotArm(<span class="var type0" id="S3T0U788">sm</span>(<span class="var type0" id="S30T0U789">src</span>,4), -<span class="var type0" id="S43T0U794">fAng</span>+<span class="var type0" id="S3T0U796">sm</span>(<span class="var type0" id="S30T0U797">src</span>,3)+pi/2, <span class="var type0" id="S7T0U804">A</span>/<span class="var type0" id="S8T0U805">B</span>); <span class="var type0" id="S42T0U809">piv</span>(<span class="var type0" id="S30T0U810">src</span>,[1,3])=-<span class="var type0" id="S42T0U817">piv</span>(<span class="var type0" id="S30T0U818">src</span>,[1,3]);</span></span>
<span class="srcline"><span class="lineno"><a href="59,65" id="srcline65"> 65</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,66" id="srcline66"> 66</a></span><span class="line">    <span class="var type0" id="S42T0U826">piv</span>(:,3)=<span class="var type0" id="S42T0U831">piv</span>(:,3).*<span class="var type0" id="S5T0U834">fricCoeff</span>; <span class="comment">%scale force by friction coefficients</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,67" id="srcline67"> 67</a></span><span class="line">    <span class="comment">%chose which of the two moves - random, but weighted by the required force:</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,68" id="srcline68"> 68</a></span><span class="line">    <span class="var type0" id="S53T0U837">srcF</span>=abs(<span class="var type0" id="S42T0U841">piv</span>(<span class="var type0" id="S30T0U842">src</span>,3)); <span class="var type0" id="S54T0U846">trgF</span>=abs(<span class="var type0" id="S42T0U850">piv</span>(<span class="var type0" id="S31T0U851">trg</span>,3));</span></span>
<span class="srcline"><span class="lineno"><a href="59,69" id="srcline69"> 69</a></span><span class="line">    <span class="keyword">if</span>(((<span class="var type0" id="S53T0U861">srcF</span>-<span class="var type0" id="S54T0U862">trgF</span>)/(<span class="var type0" id="S53T0U865">srcF</span>+<span class="var type0" id="S54T0U866">trgF</span>))&lt;0.5*(rand-0.5)); <span class="var type0" id="S56T0U876">mv</span>=<span class="var type0" id="S30T0U877">src</span>; <span class="comment">%move source smarticle</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,70" id="srcline70"> 70</a></span><span class="line">    <span class="keyword">else</span>; <span class="var type0" id="S56T0U881">mv</span>=<span class="var type0" id="S31T0U882">trg</span>; <span class="comment">%else move target smarticle</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,71" id="srcline71"> 71</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,72" id="srcline72"> 72</a></span><span class="line">    <span class="var type0" id="S57T0U885">pAold</span>=0; <span class="var type0" id="S58T0U889">pCOMold</span>=[0,0];</span></span>
<span class="srcline"><span class="lineno"><a href="59,73" id="srcline73"> 73</a></span><span class="line">    <span class="keyword">for</span> <span class="var type0" id="S59T0U896">i</span>=1:2 <span class="comment">%if one is hard to rotate (too far), rotate the other</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,74" id="srcline74"> 74</a></span><span class="line">    <span class="var type0" id="S60T0U902">cth</span>=cos(<span class="var type0" id="S3T0U907">sm</span>(<span class="var type0" id="S56T0U908">mv</span>,3)-pi/2); <span class="var type0" id="S62T0U916">sth</span>=sin(<span class="var type0" id="S3T0U921">sm</span>(<span class="var type0" id="S56T0U922">mv</span>,3)-pi/2); <span class="var type0" id="S64T0U930">rotMx</span>=[[<span class="var type0" id="S60T0U935">cth</span>,-<span class="var type0" id="S62T0U937">sth</span>];[<span class="var type0" id="S62T0U941">sth</span>,<span class="var type0" id="S60T0U942">cth</span>]]; <span class="comment">%rotation matrix</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,75" id="srcline75"> 75</a></span><span class="line">    <span class="var type0" id="S65T0U945">pivCOM</span>=(<span class="var type0" id="S64T0U950">rotMx</span>*<span class="var type0" id="S42T0U953">piv</span>(<span class="var type0" id="S56T0U954">mv</span>,1:2)'*<span class="var type0" id="S8T0U958">B</span>)'; <span class="comment">%pivot to smarticle COM in lab frame</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,76" id="srcline76"> 76</a></span><span class="line">    <span class="var type0" id="S66T0U961">pivot</span>=<span class="var type0" id="S3T0U964">sm</span>(<span class="var type0" id="S56T0U965">mv</span>,1:2)+<span class="var type0" id="S65T0U969">pivCOM</span>; <span class="comment">%pivot point in absolute coord</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,77" id="srcline77"> 77</a></span><span class="line">    <span class="var type0" id="S67T0U972">pivRad</span>=<span class="var type0" id="S10T0U975">crd</span>(<span class="var type0" id="S30T0U976">src</span>,(<span class="var type0" id="S32T0U981">sLk</span>-<span class="var type0" id="S36T0U982">beg</span>)*2+(1:2))-<span class="var type0" id="S66T0U988">pivot</span>; <span class="comment">%pivot to collision point</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,78" id="srcline78"> 78</a></span><span class="line">    [<span class="var type0" id="S67T0U993">pivRad</span>(1),<span class="var type0" id="S67T0U996">pivRad</span>(2)]=cart2pol(<span class="var type0" id="S67T0U1001">pivRad</span>(1),<span class="var type0" id="S67T0U1004">pivRad</span>(2));</span></span>
<span class="srcline"><span class="lineno"><a href="59,79" id="srcline79"> 79</a></span><span class="line">    <span class="var type0" id="S68T0U1008">pivAngle</span>=abs(<span class="var type0" id="S47T0U1015">vStickOut</span>(2)/<span class="var type0" id="S67T0U1018">pivRad</span>(2).*cos(<span class="var type0" id="S43T0U1023">fAng</span>-<span class="var type0" id="S47T0U1025">vStickOut</span>(1))./sin(<span class="var type0" id="S43T0U1030">fAng</span>-<span class="var type0" id="S67T0U1032">pivRad</span>(1))); <span class="comment">%angle to pivot in order to resolve collision</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,80" id="srcline80"> 80</a></span><span class="line">    <span class="keyword">if</span>(abs(<span class="var type0" id="S68T0U1041">pivAngle</span>)&lt;<span class="var type0" id="S41T0U1042">maxAngle</span> || max(<span class="var type0" id="S5T0U1046">fricCoeff</span>)&gt;100); <span class="keyword">break</span>; <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,81" id="srcline81"> 81</a></span><span class="line">    <span class="keyword">if</span>(<span class="var type0" id="S59T0U1053">i</span>==1); <span class="var type0" id="S56T0U1057">mv</span>=3-<span class="var type0" id="S56T0U1060">mv</span>; <span class="var type0" id="S57T0U1063">pAold</span>=<span class="var type0" id="S68T0U1064">pivAngle</span>; <span class="var type0" id="S58T0U1067">pCOMold</span>=<span class="var type0" id="S65T0U1068">pivCOM</span>; <span class="comment">%if pivAngle is too large, try rotating the other one</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,82" id="srcline82"> 82</a></span><span class="line">    <span class="keyword">elseif</span>(abs(<span class="var type0" id="S57T0U1074">pAold</span>)&lt;abs(<span class="var type0" id="S68T0U1077">pivAngle</span>)); <span class="var type0" id="S68T0U1080">pivAngle</span>=<span class="var type0" id="S57T0U1081">pAold</span>; <span class="var type0" id="S56T0U1084">mv</span>=3-<span class="var type0" id="S56T0U1087">mv</span>; <span class="var type0" id="S65T0U1090">pivCOM</span>=<span class="var type0" id="S58T0U1091">pCOMold</span>; <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,83" id="srcline83"> 83</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,84" id="srcline84"> 84</a></span><span class="line">    <span class="keyword">if</span>(abs(<span class="var type0" id="S68T0U1098">pivAngle</span>)&lt;<span class="var type0" id="S41T0U1099">maxAngle</span>) <span class="comment">%only pivot if small angle - else <span class="keyword">...</span><span class="comment"> parallel?</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="59,85" id="srcline85"> 85</a></span><span class="line">         <span class="comment">%xSm=NaN; return; %give error if rotating too far - need better resolution, or something is wrong</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,86" id="srcline86"> 86</a></span><span class="line"><span class="comment">%     pivAngle=max(pivAngle,tRes*3/pivRad(2)); %bound pivot angle from below</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,87" id="srcline87"> 87</a></span><span class="line">    <span class="var type0" id="S68T0U1102">pivAngle</span>=(1-2*(<span class="var type0" id="S56T0U1113">mv</span>==<span class="var type0" id="S30T0U1114">src</span>))*<span class="var type0" id="S51T0U1115">fDir</span>*sign(<span class="var type0" id="S42T0U1119">piv</span>(<span class="var type0" id="S56T0U1120">mv</span>,3))*(<span class="var type0" id="S68T0U1124">pivAngle</span>+<span class="var type0" id="S40T0U1127">trEps</span>*(1+rand)/max(<span class="var type0" id="S67T0U1136">pivRad</span>(2),0.5*<span class="var type0" id="S8T0U1140">B</span>)); <span class="comment">%rotate a little further to make sure, and orient</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,88" id="srcline88"> 88</a></span><span class="line">    <span class="var type0" id="S70T0U1143">sm12v</span>=<span class="var type0" id="S3T0U1146">sm</span>(<span class="var type0" id="S56T0U1147">mv</span>,1:2)-<span class="var type0" id="S3T0U1152">sm</span>(3-<span class="var type0" id="S56T0U1155">mv</span>,1:2); <span class="comment">%vector between smarticles</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,89" id="srcline89"> 89</a></span><span class="line">    <span class="comment">%rotate COM; add repulsive noise to prevent sticking together:</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,90" id="srcline90"> 90</a></span><span class="line">    <span class="var type0" id="S2T0U1162">xSm</span>(<span class="var type0" id="S56T0U1163">mv</span>,1:2)=<span class="var type0" id="S2T0U1170">xSm</span>(<span class="var type0" id="S56T0U1171">mv</span>,1:2)+<span class="var type0" id="S68T0U1177">pivAngle</span>*[1,-1].*flip(<span class="var type0" id="S65T0U1185">pivCOM</span>)+<span class="var type0" id="S40T0U1190">trEps</span>*abs(<span class="var type0" id="S68T0U1193">pivAngle</span>)*<span class="var type0" id="S70T0U1194">sm12v</span>/norm(<span class="var type0" id="S70T0U1197">sm12v</span>)*rand; </span></span>
<span class="srcline"><span class="lineno"><a href="59,91" id="srcline91"> 91</a></span><span class="line">    <span class="var type0" id="S2T0U1203">xSm</span>(<span class="var type0" id="S56T0U1204">mv</span>,3)=<span class="var type0" id="S2T0U1208">xSm</span>(<span class="var type0" id="S56T0U1209">mv</span>,3)+<span class="var type0" id="S68T0U1211">pivAngle</span>; <span class="comment">%rotate angle</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,92" id="srcline92"> 92</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,93" id="srcline93"> 93</a></span><span class="line">    <span class="comment">%if links were near-parallel, ensure they don't pass through on nextstep: </span></span></span>
<span class="srcline"><span class="lineno"><a href="59,94" id="srcline94"> 94</a></span><span class="line">    <span class="comment">%(instead make them cross at the same point they did this time)</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,95" id="srcline95"> 95</a></span><span class="line">    <span class="keyword">if</span>(abs(<span class="var type0" id="S49T0U1219">so2fAng</span>-pi/2)&lt;<span class="var type0" id="S9T0U1225">tRes</span>*20)</span></span>
<span class="srcline"><span class="lineno"><a href="59,96" id="srcline96"> 96</a></span><span class="line">        <span class="var type0" id="S73T0U1229">nextCrd</span>=smcle2coord([<span class="var type0" id="S2T0U1234">xSm</span>,<span class="var type0" id="S6T0U1235">nextAl</span>]); <span class="comment">%coordinates for next arm angles</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,97" id="srcline97"> 97</a></span><span class="line">        <span class="var type0" id="S74T0U1238">nextInt</span>=lineSegmentIntersect(<span class="var type0" id="S73T0U1242">nextCrd</span>(<span class="var type0" id="S30T0U1243">src</span>,(<span class="var type0" id="S32T0U1248">sLk</span>-1)*2+(1:4)),<span class="var type0" id="S73T0U1256">nextCrd</span>(<span class="var type0" id="S31T0U1257">trg</span>,(<span class="var type0" id="S34T0U1262">tLk</span>-1)*2+(1:4))); <span class="comment">%intersection of these same links</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,98" id="srcline98"> 98</a></span><span class="line"><span class="comment">%         cla; plot(nextCrd(:,1:2:end)',nextCrd(:,2:2:end)','-o','LineWidth',2); axis([-0.5,0.5,-0.5,0.5]*12);</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,99" id="srcline99"> 99</a></span><span class="line"><span class="comment">%         scatter(nextInt.intMatrixX(:),nextInt.intMatrixY(:),1000,'r.'); %mark collision points</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,100" id="srcline100">100</a></span><span class="line">        <span class="comment">%get new force orientation:</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,101" id="srcline101">101</a></span><span class="line">        <span class="var type0" id="S75T0U1271">begS</span>=1-2*<span class="var type0" id="S36T0U1276">beg</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="59,102" id="srcline102">102</a></span><span class="line">        <span class="var type0" id="S76T0U1279">nSV</span>=<span class="var type0" id="S75T0U1281">begS</span> *(<span class="var type0" id="S73T0U1285">nextCrd</span>(<span class="var type0" id="S30T0U1286">src</span>,(<span class="var type0" id="S32T0U1290">sLk</span>)*2+(1:2))-<span class="var type0" id="S73T0U1297">nextCrd</span>(<span class="var type0" id="S30T0U1298">src</span>,(<span class="var type0" id="S32T0U1303">sLk</span>-1)*2+(1:2))); <span class="comment">%new source vector</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,103" id="srcline103">103</a></span><span class="line">        <span class="var type0" id="S77T0U1312">nTV</span>=<span class="var type0" id="S73T0U1315">nextCrd</span>(<span class="var type0" id="S31T0U1316">trg</span>,(<span class="var type0" id="S34T0U1320">tLk</span>)*2+(1:2))-<span class="var type0" id="S73T0U1327">nextCrd</span>(<span class="var type0" id="S31T0U1328">trg</span>,(<span class="var type0" id="S34T0U1333">tLk</span>-1)*2+(1:2)); <span class="comment">%new target vector</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,104" id="srcline104">104</a></span><span class="line">        <span class="var type0" id="S78T0U1342">sinTh</span>=(<span class="var type0" id="S76T0U1349">nSV</span>(1)*<span class="var type0" id="S77T0U1352">nTV</span>(2)-<span class="var type0" id="S76T0U1356">nSV</span>(2)*<span class="var type0" id="S77T0U1359">nTV</span>(1))/norm(<span class="var type0" id="S76T0U1363">nSV</span>)/norm(<span class="var type0" id="S77T0U1366">nTV</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="59,105" id="srcline105">105</a></span><span class="line">        <span class="var type0" id="S79T0U1369">flipOrt</span>=-<span class="var type0" id="S51T0U1372">fDir</span>*sign(<span class="var type0" id="S78T0U1375">sinTh</span>);<span class="comment">%do the links flip relative orientation? use sin = cross prod</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,106" id="srcline106">106</a></span><span class="line">        <span class="keyword">if</span>(<span class="var type0" id="S79T0U1380">flipOrt</span>&gt;0); <span class="var type0" id="S80T0U1384">currInt</span>=<span class="var type0" id="S74T0U1388">nextInt</span>.intNormalizedDistance1To2(1)*<span class="var type0" id="S17T0U1392">lenMx</span>(<span class="var type0" id="S32T0U1393">sLk</span>,1);</span></span>
<span class="srcline"><span class="lineno"><a href="59,107" id="srcline107">107</a></span><span class="line">        <span class="keyword">else</span>; <span class="var type0" id="S80T0U1398">currInt</span>=<span class="var type0" id="S74T0U1402">nextInt</span>.intNormalizedDistance2To1(1)*<span class="var type0" id="S17T0U1406">lenMx</span>(<span class="var type0" id="S34T0U1407">tLk</span>,1);</span></span>
<span class="srcline"><span class="lineno"><a href="59,108" id="srcline108">108</a></span><span class="line">            <span class="var type0" id="S75T0U1411">begS</span>=1-2*(<span class="var type0" id="S76T0U1419">nSV</span>*<span class="var type0" id="S77T0U1421">nTV</span>'&gt;0); <span class="var type0" id="S77T0U1425">nTV</span>=-<span class="var type0" id="S75T0U1428">begS</span>*<span class="var type0" id="S76T0U1429">nSV</span>; <span class="var type0" id="S32T0U1432">sLk</span>=<span class="var type0" id="S34T0U1433">tLk</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="59,109" id="srcline109">109</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,110" id="srcline110">110</a></span><span class="line">        <span class="var type0" id="S81T0U1436">goalInt</span>=<span class="var type0" id="S17T0U1439">lenMx</span>(<span class="var type0" id="S32T0U1440">sLk</span>,1)*(0.5+0.45*<span class="var type0" id="S75T0U1447">begS</span>); <span class="comment">%shift s.t. this is new intersection point</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,111" id="srcline111">111</a></span><span class="line">        <span class="var type0" id="S82T0U1450">smShift</span>=<span class="var type0" id="S75T0U1453">begS</span>*(<span class="var type0" id="S81T0U1456">goalInt</span>-<span class="var type0" id="S80T0U1457">currInt</span>)*abs(<span class="var type0" id="S78T0U1460">sinTh</span>); <span class="comment">%shift = intShift * sin(angle between new links)</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,112" id="srcline112">112</a></span><span class="line">        <span class="keyword">if</span>(<span class="var type0" id="S82T0U1465">smShift</span>&gt;0)</span></span>
<span class="srcline"><span class="lineno"><a href="59,113" id="srcline113">113</a></span><span class="line"><span class="comment">%             if(smShift&lt;trEps/5); smShift=trEps; end %bound shift from below</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,114" id="srcline114">114</a></span><span class="line">            <span class="var type0" id="S2T0U1470">xSm</span>(<span class="var type0" id="S56T0U1471">mv</span>,1:2)=<span class="var type0" id="S2T0U1477">xSm</span>(<span class="var type0" id="S56T0U1478">mv</span>,1:2)-(1-2*(<span class="var type0" id="S56T0U1494">mv</span>==<span class="var type0" id="S30T0U1495">src</span>))*<span class="var type0" id="S51T0U1496">fDir</span>*<span class="var type0" id="S82T0U1497">smShift</span>*flip(<span class="var type0" id="S77T0U1500">nTV</span>).*[1,-1]/norm(<span class="var type0" id="S77T0U1508">nTV</span>); <span class="comment">%shift orthogonal to new target vector</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,115" id="srcline115">115</a></span><span class="line">        <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,116" id="srcline116">116</a></span><span class="line">            <span class="var type0" id="S2T0U1513">xSm</span>(<span class="var type0" id="S56T0U1514">mv</span>,3)=<span class="var type0" id="S2T0U1518">xSm</span>(<span class="var type0" id="S56T0U1519">mv</span>,3)+(rand-0.5)*0.1;</span></span>
<span class="srcline"><span class="lineno"><a href="59,117" id="srcline117">117</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,118" id="srcline118">118</a></span><span class="line"><span class="comment">%         nextCrd=smcle2coord([xSm,nextAl]); %coordinates for next arm angles</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,119" id="srcline119">119</a></span><span class="line"><span class="comment">%         nextInt=lineSegmentIntersect(nextCrd(src,(sLk-1)*2+(1:4)),nextCrd(trg,(tLk-1)*2+(1:4))); %intersection of these same links</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,120" id="srcline120">120</a></span><span class="line"><span class="comment">%         cla; plot(nextCrd(:,1:2:end)',nextCrd(:,2:2:end)','-o','LineWidth',2); axis([-0.5,0.5,-0.5,0.5]*12);</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,121" id="srcline121">121</a></span><span class="line"><span class="comment">%         scatter(nextInt.intMatrixX(:),nextInt.intMatrixY(:),1000,'r.'); %mark collision points</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,122" id="srcline122">122</a></span><span class="line">    <span class="keyword">elseif</span>(abs(<span class="var type0" id="S68T0U1533">pivAngle</span>)&gt;=<span class="var type0" id="S41T0U1534">maxAngle</span>) <span class="comment">%if still hasn't moved, wiggle apart</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,123" id="srcline123">123</a></span><span class="line">        <span class="var type0" id="S70T0U1537">sm12v</span>=<span class="var type0" id="S3T0U1540">sm</span>(<span class="var type0" id="S56T0U1541">mv</span>,1:2)-<span class="var type0" id="S3T0U1546">sm</span>(3-<span class="var type0" id="S56T0U1549">mv</span>,1:2); <span class="comment">%vector between smarticles</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,124" id="srcline124">124</a></span><span class="line">        <span class="var type0" id="S2T0U1556">xSm</span>(<span class="var type0" id="S56T0U1557">mv</span>,1:2)=<span class="var type0" id="S2T0U1563">xSm</span>(<span class="var type0" id="S56T0U1564">mv</span>,1:2)+<span class="var type0" id="S70T0U1571">sm12v</span>/norm(<span class="var type0" id="S70T0U1574">sm12v</span>)*rand*<span class="var type0" id="S40T0U1577">trEps</span>; <span class="comment">%add repulsive noise to prevent sticking together</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,125" id="srcline125">125</a></span><span class="line">        <span class="var type0" id="S2T0U1581">xSm</span>(<span class="var type0" id="S56T0U1582">mv</span>,3)=<span class="var type0" id="S2T0U1586">xSm</span>(<span class="var type0" id="S56T0U1587">mv</span>,3)+(rand-0.5)*0.02;</span></span>
<span class="srcline"><span class="lineno"><a href="59,126" id="srcline126">126</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,127" id="srcline127">127</a></span><span class="line"><span class="comment">%     if(abs(so2fAng-pi/2)&lt;tRes*10) %approx cos</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,128" id="srcline128">128</a></span><span class="line"><span class="comment">%         xSm(:,1:2)=xSm(:,1:2)+4*trEps*fDir*[cos(fAng),sin(fAng)].*[1;-1];</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,129" id="srcline129">129</a></span><span class="line"><span class="comment">%         xSm(:,3)=xSm(:,3)+(rand(2,1)-0.5)*tRes*40;</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,130" id="srcline130">130</a></span><span class="line"><span class="comment">%     end</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,131" id="srcline131">131</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,132" id="srcline132">132</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="59,133" id="srcline133">133</a></span><span class="line"><span class="comment">%response when force applied to the right arm or corner</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,134" id="srcline134">134</a></span><span class="line"><span class="comment">%in: arm angle, force angle, arm length (in units of B)</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,135" id="srcline135">135</a></span><span class="line"><span class="comment">%out: [px,py,f] = pivot coordinates (in units of B) and critical force</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,136" id="srcline136">136</a></span><span class="line"><span class="comment">%required to move (in units of friction force; f&gt;0 =&gt; CCW rotation)</span></span></span>
</pre>
<div class="dead">
<pre class="code">
<span class="srcline"><span class="lineno"><a href="59,137" id="srcline137">137</a></span><span class="line">function [out]=pivotArm(al,th,A)</span></span>
<span class="srcline"><span class="lineno"><a href="59,138" id="srcline138">138</a></span><span class="line">    secth=sec(th); tanth=tan(th);</span></span>
<span class="srcline"><span class="lineno"><a href="59,139" id="srcline139">139</a></span><span class="line">    <span class="comment">%the constant out front quantifies how far off the pivot can be (larger=&gt;further away). "right" value: 0.081</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,140" id="srcline140">140</a></span><span class="line">    py=0.081./(-2*A*secth.*sin(al-th)+tanth); <span class="comment">%approximation for py</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,141" id="srcline141">141</a></span><span class="line">    pylnpy2=-0.6*atan(10*py); <span class="comment">%differentiable approximation for py*log(py^2) for py in (-0.5,0.5)</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,142" id="srcline142">142</a></span><span class="line">    px=tanth/2.*pylnpy2;</span></span>
<span class="srcline"><span class="lineno"><a href="59,143" id="srcline143">143</a></span><span class="line">    f=-secth.*pylnpy2;</span></span>
<span class="srcline"><span class="lineno"><a href="59,144" id="srcline144">144</a></span><span class="line">    out=[px,py,f];</span></span>
<span class="srcline"><span class="lineno"><a href="59,145" id="srcline145">145</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="59,146" id="srcline146">146</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="59,147" id="srcline147">147</a></span><span class="line"><span class="comment">%response when orthogonal force applied to the body</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,148" id="srcline148">148</a></span><span class="line"><span class="comment">%in: distance from center to push point (in units of B)</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,149" id="srcline149">149</a></span><span class="line"><span class="comment">%out: [px,py,f] = pivot coordinates (in units of B) and critical force required to move</span></span></span>
<span class="srcline"><span class="lineno"><a href="59,150" id="srcline150">150</a></span><span class="line">function [out]=pivotBody(x)</span></span>
<span class="srcline"><span class="lineno"><a href="59,151" id="srcline151">151</a></span><span class="line">    sq=sqrt(1+4*x.^2);</span></span>
<span class="srcline"><span class="lineno"><a href="59,152" id="srcline152">152</a></span><span class="line">    out=[(x-sign(x).*sq/2), 0, -2*x+sign(x).*sq];</span></span>
<span class="srcline"><span class="lineno"><a href="59,153" id="srcline153">153</a></span><span class="line">end</span></span>
<span class="srcline"><span class="lineno"><a href="59,154" id="srcline154">154</a></span><span class="line"> </span></span>
</pre>
</div>
</body>
</html>
