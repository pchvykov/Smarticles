<html>
<body>
<script src="resources/eml_report_loadable_data.js"></script>
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type0" id="S2T0U3">crdDat</span>]=runSmarticles(<span class="var type0" id="S3T0U6">tMax</span>, <span class="var type0" id="S4T0U7">windSize</span>, <span class="var type0" id="S5T0U8">Upow</span>, <span class="var type0" id="S6T0U9">freqList</span>, <span class="var type0" id="S7T0U10">phaseList</span>, <span class="var type0" id="S8T0U11">fricCoeff</span>) <span class="comment">%#codegen</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2"> 2</a></span><span class="line"><span class="keyword">global</span> <span class="var type0" id="S9T0U13">B</span> <span class="var type0" id="S10T0U14">tRes</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3"> 3</a></span><span class="line"><span class="var type0" id="S11T0U17">livePlot</span>=0;</span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4"> 4</a></span><span class="line"><span class="var type0" id="S12T0U21">Nsm</span>=length(<span class="var type0" id="S6T0U24">freqList</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5"> 5</a></span><span class="line"><span class="var type0" id="S14T0U27">t</span>=0:<span class="var type0" id="S10T0U31">tRes</span>:<span class="var type0" id="S3T0U32">tMax</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6"> 6</a></span><span class="line"><span class="comment">%====Define motion gate===============</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7"> 7</a></span><span class="line"><span class="var type0" id="S15T0U35">gates</span> = <span class="mxinfo " id="T32:U1">@(<span class="mxinfo " id="T1:U2">t</span>) <span class="mxinfo " id="T46:U3"><span class="mxinfo " id="T46:U4"><span class="mxinfo " id="T46:U5">[<span class="mxinfo " id="T8:U6">cos(<span class="mxinfo " id="T8:U7"><span class="mxinfo " id="T8:U8"><span class="var type1" id="S6T8U46">freqList</span>*<span class="mxinfo " id="T1:U10">t</span></span>+<span class="var type1" id="S7T8U48">phaseList</span></span>)</span>,<span class="mxinfo " id="T8:U12">sin(<span class="mxinfo " id="T8:U13"><span class="mxinfo " id="T8:U14"><span class="var type1" id="S6T8U53">freqList</span>*<span class="mxinfo " id="T1:U16">t</span></span>+<span class="var type1" id="S7T8U55">phaseList</span></span>)</span>]</span>*<span class="mxinfo " id="T1:U18">pi</span></span>/2</span></span>; <span class="comment">%variable frequency circle gate</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8"> 8</a></span><span class="line"><span class="comment">% gates = @(t) [cos(t),sin(t);cos(t),sin(t)]*pi/2; %circle gate</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9"> 9</a></span><span class="line"><span class="comment">% chopTri = @(t) max(min(2*sawtooth(t,0.5),1),-1); %for sq wave</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10">10</a></span><span class="line"><span class="comment">% gates = @(t) [chopTri(freqList*t+phaseList),chopTri(freqList*t+pi/2+phaseList)]*pi/2; %var freq square gate</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11">11</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12">12</a></span><span class="line"><span class="var type0" id="S19T0U61">xSm</span>=zeros(<span class="var type0" id="S12T0U64">Nsm</span>,5);</span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13">13</a></span><span class="line"><span class="var type0" id="S19T0U69">xSm</span>(:,4:5)=<span class="var type0" id="S15T0U75">gates</span>(0);</span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14">14</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15">15</a></span><span class="line"><span class="comment">%======Set smarticle initial positions: [cx,cy, theta, al1, al2] - c.o.m coord, body orientation, arm angles</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16">16</a></span><span class="line"><span class="comment">% xSm=[2,1,pi/4,pi/8,pi/8];</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17">17</a></span><span class="line"><span class="comment">% xSm(:,1:3)=(rand(Nsm,3)-0.5).*repmat([10,10, 2*pi],Nsm,1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18">18</a></span><span class="line"><span class="keyword">for</span> <span class="var type0" id="S21T0U79">smi</span>=1:<span class="var type0" id="S12T0U82">Nsm</span> </span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19">19</a></span><span class="line">    <span class="var type0" id="S22T0U85">collFl</span>=true;</span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20">20</a></span><span class="line">    <span class="var type0" id="S24T0U90">ii</span>=1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21">21</a></span><span class="line">    <span class="keyword">while</span>(<span class="var type0" id="S22T0U94">collFl</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22">22</a></span><span class="line">        <span class="var type0" id="S24T0U97">ii</span>=<span class="var type0" id="S24T0U99">ii</span>+1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23">23</a></span><span class="line">        <span class="var type0" id="S22T0U103">collFl</span>=false;</span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24">24</a></span><span class="line">        <span class="var type0" id="S19T0U109">xSm</span>(<span class="var type0" id="S21T0U110">smi</span>,1:3)=(rand(1,3)-0.5).*[<span class="var type0" id="S4T0U124">windSize</span>,<span class="var type0" id="S4T0U125">windSize</span>, 2*pi]; <span class="comment">%add new smcle</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25">25</a></span><span class="line">        <span class="keyword">for</span> <span class="var type0" id="S27T0U132">smic</span>=1:<span class="var type0" id="S21T0U136">smi</span>-1 <span class="comment">%check that it doesn't collide with previous ones</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26">26</a></span><span class="line">            <span class="var type0" id="S28T0U140">res</span>=pairCollision(<span class="var type0" id="S19T0U144">xSm</span>([<span class="var type0" id="S21T0U147">smi</span>,<span class="var type0" id="S27T0U148">smic</span>],:), false, [1,1], zeros(2));</span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27">27</a></span><span class="line">            <span class="var type0" id="S22T0U161">collFl</span>=<span class="var type0" id="S22T0U163">collFl</span> || <span class="var type0" id="S28T0U165">res</span>(1); <span class="comment">%only check for collisions</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28">28</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29">29</a></span><span class="line">        <span class="keyword">if</span>(<span class="var type0" id="S24T0U171">ii</span>&gt;100); error(<span class="string">'cannot build IC'</span>); <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30">30</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31">31</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32">32</a></span><span class="line"><span class="comment">% xSm(:,1:3)=[-3,0,pi/2; -1.1,0.1,pi/2-0.1];</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33">33</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34">34</a></span><span class="line"><span class="comment">%====Define Central attractive force=======</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35">35</a></span><span class="line"><span class="comment">% Fcent = @(vec) -vec.* repmat(min((vec(:,1).^2+vec(:,2).^2).^(Upow/2-1)<span class="keyword">...</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36">36</a></span><span class="line"><span class="comment">%     .*Upow/(windSize*0.6)^(Upow-2),10)/(windSize*0.6)^2,1,2);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37">37</a></span><span class="line"><span class="comment">%Circular "plate" potential </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38">38</a></span><span class="line">    <span class="var type0" id="S31T0U179">Fcent</span> = @(vec) -vec./<span class="var type0" id="S9T0U186">B</span>.*repmat(max(0,1-<span class="var type0" id="S4T0U196">windSize</span>*0.6./sqrt(vec(:,1).^2+vec(:,2).^2)),1,2);</span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39">39</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40">40</a></span><span class="line"><span class="comment">%====Run simulation==============</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41">41</a></span><span class="line"><span class="var type0" id="S35T0U217">nextAl</span>=<span class="var type0" id="S15T0U219">gates</span>(<span class="var type0" id="S14T0U221">t</span>(1));</span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42">42</a></span><span class="line"><span class="var type0" id="S2T0U225">crdDat</span>=zeros(<span class="var type0" id="S12T0U228">Nsm</span>,5,length(<span class="var type0" id="S14T0U233">t</span>)-1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43">43</a></span><span class="line"><span class="comment">% coder.extrinsic('waitbar');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44">44</a></span><span class="line"><span class="comment">% if(~livePlot); w=waitbar(0); end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45">45</a></span><span class="line"><span class="keyword">for</span> <span class="var type0" id="S36T0U237">ti</span>=1:length(<span class="var type0" id="S14T0U243">t</span>)-1</span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46">46</a></span><span class="line">    <span class="var type0" id="S19T0U248">xSm</span>(:,4:5)=<span class="var type0" id="S35T0U253">nextAl</span>; <span class="comment">%move the arms</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47">47</a></span><span class="line">    <span class="var type0" id="S35T0U256">nextAl</span>=<span class="var type0" id="S15T0U258">gates</span>(<span class="var type0" id="S14T0U260">t</span>(<span class="var type0" id="S36T0U262">ti</span>+1));</span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48">48</a></span><span class="line">    <span class="var type0" id="S19T0U267">xSm</span>(:,1:3)=resolveCollisions(<span class="var type0" id="S19T0U274">xSm</span>,true, <span class="var type0" id="S8T0U277">fricCoeff</span>, <span class="var type0" id="S35T0U278">nextAl</span>); <span class="comment">%resolve all collisions sequentially</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49">49</a></span><span class="line">    <span class="var type0" id="S19T0U282">xSm</span>(:,1:2)=<span class="var type0" id="S19T0U289">xSm</span>(:,1:2)+<span class="var type0" id="S10T0U295">tRes</span>*<span class="var type0" id="S31T0U297">Fcent</span>(<span class="var type0" id="S19T0U299">xSm</span>(:,1:2));</span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50">50</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51">51</a></span><span class="line"><span class="comment">%     if(livePlot &amp;&amp; mod(ti,0.05*2*pi/tRes)&lt;1 &amp;&amp; t(ti)&gt;000) %show smarticles motion live</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52">52</a></span><span class="line"><span class="comment">%         crd=smcle2coord(xSm);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53">53</a></span><span class="line"><span class="comment">%         cla; plot(crd(:,1:2:end)',crd(:,2:2:end)','-','LineWidth',2); axis([-0.5,0.5,-0.5,0.5]*(windSize+B)*1.1);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54">54</a></span><span class="line"><span class="comment">%         pause(0.01); </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55">55</a></span><span class="line"><span class="comment">%     end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56">56</a></span><span class="line"><span class="comment">%     if(~livePlot &amp;&amp; mod(ti,length(t)/30)&lt;=1); waitbar(ti/length(t),w); end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57">57</a></span><span class="line">    <span class="var type0" id="S2T0U307">crdDat</span>(:,:,<span class="var type0" id="S36T0U310">ti</span>)=<span class="var type0" id="S19T0U311">xSm</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58">58</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59">59</a></span><span class="line"><span class="comment">% if(~livePlot); close(w); end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60">60</a></span><span class="line"><span class="keyword">return</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61">61</a></span><span class="line"> </span></span>
</pre>
</div>
</body>
</html>
